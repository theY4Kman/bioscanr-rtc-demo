/*
 * Copyright © Acision 2014. All rights reserved.
 */

/**
 * @license almond 0.2.9 Copyright (c) 2011-2014, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

/*!
 * EventEmitter v4.2.7 - git.io/ee
 * Oliver Caldwell
 * MIT license
 * @preserve
 */

/**
 * Project: wampy.js
 *
 * https://github.com/KSDaemon/wampy.js
 *
 * A lightweight client-side implementation of
 * WAMP (The WebSocket Application Messaging Protocol)
 * http://wamp.ws
 *
 * Provides asynchronous RPC/PubSub over WebSocket.
 *
 * Copyright 2014 KSDaemon. Licensed under the MIT License.
 * See license text at http://www.opensource.org/licenses/mit-license.php
 *
 */

/*!
 * js-logger - http://github.com/jonnyreeves/js-logger 
 * Jonny Reeves, http://jonnyreeves.co.uk/
 * js-logger may be freely distributed under the MIT license. 
 */

//     uuid.js
//
//     Copyright (c) 2010-2012 Robert Kieffer
//     MIT License - http://opensource.org/licenses/mit-license.php

/*
 * JsSIP version 0.3.0-crocodile-3-devel
 * Copyright (c) 2012-2014 José Luis Millán - Versatica <http://www.versatica.com>
 * Homepage: http://jssip.net
 * License: http://jssip.net/license
 */

(function(e,t){typeof define=="function"&&define.amd?define(["underscore"],t):e.AcisionSDK=t(e._)})(this,function(e){var t,n,r;return function(e){function v(e,t){return h.call(e,t)}function m(e,t){var n,r,i,s,o,u,a,f,c,h,p,v=t&&t.split("/"),m=l.map,g=m&&m["*"]||{};if(e&&e.charAt(0)===".")if(t){v=v.slice(0,v.length-1),e=e.split("/"),o=e.length-1,l.nodeIdCompat&&d.test(e[o])&&(e[o]=e[o].replace(d,"")),e=v.concat(e);for(c=0;c<e.length;c+=1){p=e[c];if(p===".")e.splice(c,1),c-=1;else if(p===".."){if(c===1&&(e[2]===".."||e[0]===".."))break;c>0&&(e.splice(c-1,2),c-=2)}}e=e.join("/")}else e.indexOf("./")===0&&(e=e.substring(2));if((v||g)&&m){n=e.split("/");for(c=n.length;c>0;c-=1){r=n.slice(0,c).join("/");if(v)for(h=v.length;h>0;h-=1){i=m[v.slice(0,h).join("/")];if(i){i=i[r];if(i){s=i,u=c;break}}}if(s)break;!a&&g&&g[r]&&(a=g[r],f=c)}!s&&a&&(s=a,u=f),s&&(n.splice(0,u,s),e=n.join("/"))}return e}function g(t,n){return function(){return s.apply(e,p.call(arguments,0).concat([t,n]))}}function y(e){return function(t){return m(t,e)}}function b(e){return function(t){a[e]=t}}function w(t){if(v(f,t)){var n=f[t];delete f[t],c[t]=!0,i.apply(e,n)}if(!v(a,t)&&!v(c,t))throw new Error("No "+t);return a[t]}function E(e){var t,n=e?e.indexOf("!"):-1;return n>-1&&(t=e.substring(0,n),e=e.substring(n+1,e.length)),[t,e]}function S(e){return function(){return l&&l.config&&l.config[e]||{}}}var i,s,o,u,a={},f={},l={},c={},h=Object.prototype.hasOwnProperty,p=[].slice,d=/\.js$/;o=function(e,t){var n,r=E(e),i=r[0];return e=r[1],i&&(i=m(i,t),n=w(i)),i?n&&n.normalize?e=n.normalize(e,y(t)):e=m(e,t):(e=m(e,t),r=E(e),i=r[0],e=r[1],i&&(n=w(i))),{f:i?i+"!"+e:e,n:e,pr:i,p:n}},u={require:function(e){return g(e)},exports:function(e){var t=a[e];return typeof t!="undefined"?t:a[e]={}},module:function(e){return{id:e,uri:"",exports:a[e],config:S(e)}}},i=function(t,n,r,i){var s,l,h,p,d,m=[],y=typeof r,E;i=i||t;if(y==="undefined"||y==="function"){n=!n.length&&r.length?["require","exports","module"]:n;for(d=0;d<n.length;d+=1){p=o(n[d],i),l=p.f;if(l==="require")m[d]=u.require(t);else if(l==="exports")m[d]=u.exports(t),E=!0;else if(l==="module")s=m[d]=u.module(t);else if(v(a,l)||v(f,l)||v(c,l))m[d]=w(l);else{if(!p.p)throw new Error(t+" missing "+l);p.p.load(p.n,g(i,!0),b(l),{}),m[d]=a[l]}}h=r?r.apply(a[t],m):undefined;if(t)if(s&&s.exports!==e&&s.exports!==a[t])a[t]=s.exports;else if(h!==e||!E)a[t]=h}else t&&(a[t]=r)},t=n=s=function(t,n,r,a,f){if(typeof t=="string")return u[t]?u[t](n):w(o(t,n).f);if(!t.splice){l=t,l.deps&&s(l.deps,l.callback);if(!n)return;n.splice?(t=n,n=r,r=null):t=e}return n=n||function(){},typeof r=="function"&&(r=a,a=f),a?i(e,t,n,r):setTimeout(function(){i(e,t,n,r)},4),s},s.config=function(e){return s(e)},t._defined=a,r=function(e,t,n){t.splice||(n=t,t=[]),!v(a,e)&&!v(f,e)&&(f[e]=[e,t,n])},r.amd={jQuery:!0}}(),r("almond",function(){}),function(){function e(){}function s(e,t){var n=e.length;while(n--)if(e[n].listener===t)return n;return-1}function o(e){return function(){return this[e].apply(this,arguments)}}var t=e.prototype,n=this,i=n.EventEmitter;t.getListeners=function(t){var n=this._getEvents(),r,i;if(t instanceof RegExp){r={};for(i in n)n.hasOwnProperty(i)&&t.test(i)&&(r[i]=n[i])}else r=n[t]||(n[t]=[]);return r},t.flattenListeners=function(t){var n=[],r;for(r=0;r<t.length;r+=1)n.push(t[r].listener);return n},t.getListenersAsObject=function(t){var n=this.getListeners(t),r;return n instanceof Array&&(r={},r[t]=n),r||n},t.addListener=function(t,n){var r=this.getListenersAsObject(t),i=typeof n=="object",o;for(o in r)r.hasOwnProperty(o)&&s(r[o],n)===-1&&r[o].push(i?n:{listener:n,once:!1});return this},t.on=o("addListener"),t.addOnceListener=function(t,n){return this.addListener(t,{listener:n,once:!0})},t.once=o("addOnceListener"),t.defineEvent=function(t){return this.getListeners(t),this},t.defineEvents=function(t){for(var n=0;n<t.length;n+=1)this.defineEvent(t[n]);return this},t.removeListener=function(t,n){var r=this.getListenersAsObject(t),i,o;for(o in r)r.hasOwnProperty(o)&&(i=s(r[o],n),i!==-1&&r[o].splice(i,1));return this},t.off=o("removeListener"),t.addListeners=function(t,n){return this.manipulateListeners(!1,t,n)},t.removeListeners=function(t,n){return this.manipulateListeners(!0,t,n)},t.manipulateListeners=function(t,n,r){var i,s,o=t?this.removeListener:this.addListener,u=t?this.removeListeners:this.addListeners;if(typeof n!="object"||n instanceof RegExp){i=r.length;while(i--)o.call(this,n,r[i])}else for(i in n)n.hasOwnProperty(i)&&(s=n[i])&&(typeof s=="function"?o.call(this,i,s):u.call(this,i,s));return this},t.removeEvent=function(t){var n=typeof t,r=this._getEvents(),i;if(n==="string")delete r[t];else if(t instanceof RegExp)for(i in r)r.hasOwnProperty(i)&&t.test(i)&&delete r[i];else delete this._events;return this},t.removeAllListeners=o("removeEvent"),t.emitEvent=function(t,n){var r=this.getListenersAsObject(t),i,s,o,u;for(o in r)if(r.hasOwnProperty(o)){s=r[o].length;while(s--)i=r[o][s],i.once===!0&&this.removeListener(t,i.listener),u=i.listener.apply(this,n||[]),u===this._getOnceReturnValue()&&this.removeListener(t,i.listener)}return this},t.trigger=o("emitEvent"),t.emit=function(t){var n=Array.prototype.slice.call(arguments,1);return this.emitEvent(t,n)},t.setOnceReturnValue=function(t){return this._onceReturnValue=t,this},t._getOnceReturnValue=function(){return this.hasOwnProperty("_onceReturnValue")?this._onceReturnValue:!0},t._getEvents=function(){return this._events||(this._events={})},e.noConflict=function(){return n.EventEmitter=i,e},typeof r=="function"&&r.amd?r("EventEmitter",[],function(){return e}):typeof module=="object"&&module.exports?module.exports=e:this.EventEmitter=e}.call(this),r("wampy",[],function(){function t(e){var t,n,r;return e?/^ws/.test(e)?e:/:\d{1,5}/.test(e)?(t=window.location.protocol==="https:"?"wss://":"ws://",t+e):(t=window.location.protocol==="https:"?"wss://":"ws://",n=window.location.port!==""?":"+window.location.port:"",r=e[0]==="/"?e:"/"+e,t+window.location.hostname+n+r):(t=window.location.protocol==="https:"?"wss://":"ws://",n=window.location.port!==""?":"+window.location.port:"",t+window.location.hostname+n+"/ws")}function n(){var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=16,n="",r=e.length;while(t--)n+=e.charAt(Math.floor(Math.random()*r));return n}function r(e,n){var r=t(e);return"WebSocket"in window?n?new WebSocket(r,n):new WebSocket(r):"MozWebSocket"in window?n?new MozWebSocket(r,n):new MozWebSocket(r):null}var e={TYPE_ID_WELCOME:0,TYPE_ID_PREFIX:1,TYPE_ID_CALL:2,TYPE_ID_CALLRESULT:3,TYPE_ID_CALLERROR:4,TYPE_ID_SUBSCRIBE:5,TYPE_ID_UNSUBSCRIBE:6,TYPE_ID_PUBLISH:7,TYPE_ID_EVENT:8},i=function(){this._pref2uri={},this._uri2pref={}};i.prototype.get=function(e){return this._pref2uri[e]},i.prototype.set=function(e,t){this._pref2uri[e]=t,this._uri2pref[e]=t},i.prototype.remove=function(e){this._pref2uri[e]&&(delete this._uri2pref[this._pref2uri[e]],delete this._pref2uri[e])},i.prototype.reset=function(){this._pref2uri={},this._uri2pref={}},i.prototype.resolve=function(e){var t=/^http(s)?:\/\//.test(e),n=e.indexOf(":"),r;return!t&&n>=0?(r=e.substring(0,n),this._pref2uri[r]?this._pref2uri[r]+e.substring(n+1):null):e};var s=function(e,t,n){this._url=e,this._protocols=[],this._cache={sessionId:null,protocolVersion:1,timer:null,reconnectingAttempts:0,welcome:!1,onConnect:null,onClose:null,onError:null,onReconnect:null},this._serverIdent=null,this._ws=null,this._queue=[],this._calls={},this._subscriptions={},this._isInitialized=!1,this._options={autoReconnect:!0,reconnectInterval:2e3,maxRetries:25},this._prefixMap=new i;switch(arguments.length){case 1:typeof arguments[0]=="string"?this._ws=r(arguments[0]):this._options=this._merge(this._options,arguments[0]);break;case 2:typeof arguments[0]=="string"&&arguments[1]instanceof Array?(this._protocols=arguments[1],this._ws=r(arguments[0],arguments[1])):(this._ws=r(arguments[0]),this._options=this._merge(this._options,arguments[1]));break;case 3:this._protocols=arguments[1],this._ws=r(arguments[0],arguments[1]),this._options=this._merge(this._options,arguments[2])}this._initWsCallbacks()};return s.prototype._merge=function(){var e={},t,n=arguments.length,r;for(t=0;t<n;t++)for(r in arguments[t])e[r]=arguments[t][r];return e},s.prototype._send=function(e){e&&this._queue.push(JSON.stringify(e));if(this._isInitialized&&this._ws.readyState===1)while(this._queue.length)this._ws.send(this._queue.shift())},s.prototype._initWsCallbacks=function(){var e=this;this._ws.onopen=function(){e._wsOnOpen.call(e)},this._ws.onclose=function(t){e._wsOnClose.call(e,t)},this._ws.onmessage=function(t){e._wsOnMessage.call(e,t)},this._ws.onerror=function(t){e._wsOnError.call(e,t)}},s.prototype._wsOnOpen=function(){console.log("[wampy] websocket connected")},s.prototype._wsOnClose=function(e){var t=this;console.log("[wampy] websocket disconnected"),this._cache.welcome=!1,this._isInitialized&&this._options.autoReconnect&&this._cache.reconnectingAttempts<this._options.maxRetries?this._cache.timer=window.setTimeout(function(){t._wsReconnect.call(t)},this._options.reconnectInterval):(this._options.onClose&&this._options.onClose(),this.disconnect())},s.prototype._wsOnMessage=function(t){var n,r,i;console.log("[wampy] websocket message received: ",t.data),n=JSON.parse(t.data);switch(n[0]){case e.TYPE_ID_WELCOME:this._cache.sessionId=n[1],this._cache.protocolVersion=n[2],this._serverIdent=n[3],this._isInitialized=!0,this._options.onConnect&&this._options.onConnect(),this._send();break;case e.TYPE_ID_CALLRESULT:this._calls[n[1]]&&this._calls[n[1]].callRes&&this._calls[n[1]].callRes(n[2]);break;case e.TYPE_ID_CALLERROR:this._calls[n[1]]&&this._calls[n[1]].callErr&&this._calls[n[1]].callErr(n[2],n[3],n[4]);break;case e.TYPE_ID_EVENT:i=this._prefixMap.resolve(n[1]);if(this._subscriptions[i]){r=this._subscriptions[i].length;while(r--)this._subscriptions[i][r](n[2])}}},s.prototype._wsOnError=function(e){console.log("[wampy] websocket error"),this._options.onError&&this._options.onError()},s.prototype._wsReconnect=function(){console.log("[wampy] websocket reconnecting..."),this._options.onReconnect&&this._options.onReconnect(),this._cache.reconnectingAttempts++,this._ws=r(this._url,this._protocols),this._initWsCallbacks()},s.prototype.options=function(e){if(e===undefined)return this._options;if(typeof e=="object")return this._options=this._merge(this._options,e),this},s.prototype.connect=function(e,t){return e&&(this._url=e),t instanceof Array?this._protocols=t:this._protocols=[],this._ws=r(this._url,this._protocols),this},s.prototype.disconnect=function(){return this._isInitialized&&(this._isInitialized=!1,this._ws.close(),this._serverIdent=null,this._prefixMap.reset(),this._ws=null,this._queue=[],this._subscriptions={},this._calls={},this._cache={protocolVersion:1,reconnectingAttempts:0}),this},s.prototype.prefix=function(t,n){return this._prefixMap.set(t,n),this._send([e.TYPE_ID_PREFIX,t,n]),this},s.prototype.unprefix=function(e){return this._prefixMap.remove(e),this},s.prototype.call=function(t,r){var i=n(),s,o=arguments.length,u=[e.TYPE_ID_CALL];while(i in this._calls)i=n();this._calls[i]=r,u.push(i),u.push(t);for(s=2;s<o;s++)u.push(arguments[s]);return this._send(u),this},s.prototype.subscribe=function(t,n){var r=this._prefixMap.resolve(t);return this._subscriptions[r]||(this._subscriptions[r]=[],this._send([e.TYPE_ID_SUBSCRIBE,t])),this._subscriptions[r].indexOf(n)<0&&this._subscriptions[r].push(n),this},s.prototype.unsubscribe=function(t,n){var r,i=this._prefixMap.resolve(t);if(this._subscriptions[i]){if(n!==undefined){r=this._subscriptions[i].indexOf(n),r>=0&&this._subscriptions[i].splice(r,1);if(this._subscriptions[i].length)return this}this._send([e.TYPE_ID_UNSUBSCRIBE,t]),delete this._subscriptions[i]}return this},s.prototype.publish=function(t,n,r,i){var s=[e.TYPE_ID_PUBLISH,t,n];switch(arguments.length){case 2:this._send(s);break;case 3:if(typeof r=="boolean"||r instanceof Array)s.push(r),this._send(s);break;case 4:r instanceof Array&&i instanceof Array&&(s.push(r),s.push(i),this._send(s))}return this},s}),function(e,t){typeof exports=="object"?t(exports,module):typeof r=="function"&&r.amd&&r("sasl/lib/factory",["exports","module"],t)}(this,function(e,t){function n(){this._mechs=[]}n.prototype.use=function(e,t){return t||(t=e,e=t.prototype.name),this._mechs.push({name:e,mech:t}),this},n.prototype.create=function(e){for(var t=0,n=this._mechs.length;t<n;t++)for(var r=0,i=e.length;r<i;r++){var s=this._mechs[t];if(s.name==e[r])return new s.mech}return null},e=t.exports=n}),function(e,t){typeof exports=="object"?t(exports,module,n("./lib/factory")):typeof r=="function"&&r.amd&&r("sasl/main",["exports","module","./lib/factory"],t)}(this,function(e,t,n){e=t.exports=n,e.Factory=n}),r("sasl",["sasl/main"],function(e){return e}),function(e){var t={};t.VERSION="0.9.14";var n,i={},s=function(e,t){return function(){return t.apply(e,arguments)}},o=function(){var e=arguments,t=e[0],n,r;for(r=1;r<e.length;r++)for(n in e[r])!(n in t)&&e[r].hasOwnProperty(n)&&(t[n]=e[r][n]);return t},u=function(e,t){return{value:e,name:t}};t.DEBUG=u(1,"DEBUG"),t.INFO=u(2,"INFO"),t.WARN=u(4,"WARN"),t.ERROR=u(8,"ERROR"),t.OFF=u(99,"OFF");var a=function(e){this.context=e,this.setLevel(e.filterLevel),this.log=this.info};a.prototype={setLevel:function(e){e&&"value"in e&&(this.context.filterLevel=e)},enabledFor:function(e){var t=this.context.filterLevel;return e.value>=t.value},debug:function(){this.invoke(t.DEBUG,arguments)},info:function(){this.invoke(t.INFO,arguments)},warn:function(){this.invoke(t.WARN,arguments)},error:function(){this.invoke(t.ERROR,arguments)},invoke:function(e,t){n&&this.enabledFor(e)&&n(t,o({level:e},this.context))}};var f=new a({filterLevel:t.OFF});(function(){var e=t;e.enabledFor=s(f,f.enabledFor),e.debug=s(f,f.debug),e.info=s(f,f.info),e.warn=s(f,f.warn),e.error=s(f,f.error),e.log=e.info})(),t.setHandler=function(e){n=e},t.setLevel=function(e){f.setLevel(e);for(var t in i)i.hasOwnProperty(t)&&i[t].setLevel(e)},t.get=function(e){return i[e]||(i[e]=new a(o({name:e},f.context)))},t.useDefaults=function(e){if(typeof console=="undefined")return;t.setLevel(e||t.DEBUG),t.setHandler(function(e,n){var r=console.log;n.name&&(e[0]="["+n.name+"] "+e[0]),n.level===t.WARN&&console.warn?r=console.warn:n.level===t.ERROR&&console.error?r=console.error:n.level===t.INFO&&console.info&&(r=console.info),Function.prototype.apply.call(r,console,e)})},typeof r=="function"&&r.amd?r("logger",t):typeof module!="undefined"&&module.exports?module.exports=t:(t._prevLogger=e.Logger,t.noConflict=function(){return e.Logger=t._prevLogger,t},e.Logger=t)}(this),r("src/auth/sasl-x-acision-oauth",[],function(){function e(){}return e.prototype.name="X-ACISION-OAUTH",e.prototype.clientFirst=!0,e.prototype.response=function(e){return JSON.stringify(e)},e.prototype.challenge=function(e){return e=JSON.parse(e),this.interactiveUrl=e.interactiveUrl,this.immediateUrl=e.immediateUrl,this},e}),function(e,t){typeof exports=="object"?t(exports,module):typeof r=="function"&&r.amd&&r("sasl-plain/lib/mechanism",["exports","module"],t)}(this,function(e,t){function n(){}n.prototype.name="PLAIN",n.prototype.clientFirst=!0,n.prototype.response=function(e){var t="";return t+=e.authzid||"",t+="\0",t+=e.username,t+="\0",t+=e.password,t},n.prototype.challenge=function(e){return this},e=t.exports=n}),function(e,t){typeof exports=="object"?t(exports,module,n("./lib/mechanism")):typeof r=="function"&&r.amd&&r("sasl-plain/main",["exports","module","./lib/mechanism"],t)}(this,function(e,t,n){e=t.exports=n,e.Mechanism=n}),r("sasl-plain",["sasl-plain/main"],function(e){return e}),function(e,t){typeof exports=="object"?t(exports,module):typeof r=="function"&&r.amd&&r("sasl-anonymous/lib/mechanism",["exports","module"],t)}(this,function(e,t){function n(){}n.prototype.name="ANONYMOUS",n.prototype.clientFirst=!0,n.prototype.response=function(e){return e.trace||""},n.prototype.challenge=function(e){},e=t.exports=n}),function(e,t){typeof exports=="object"?t(exports,module,n("./lib/mechanism")):typeof r=="function"&&r.amd&&r("sasl-anonymous/main",["exports","module","./lib/mechanism"],t)}(this,function(e,t,n){e=t.exports=n,e.Mechanism=n}),r("sasl-anonymous",["sasl-anonymous/main"],function(e){return e}),r("src/auth",["underscore","EventEmitter","wampy","sasl","require","logger","./auth/sasl-x-acision-oauth","sasl-plain","sasl-anonymous"],function(e,t,n,r,i,s,o){function w(e){var t={},n=e.slice(1).split("&");return n.forEach(function(e){e=e.split("="),t[e[0]]=decodeURIComponent(e[1]||"")}),t}var u=s.get("SDK:Auth"),a="http://sdk.acision.com/auth/v1.1",f="connecting",l="authenticating",c="connected",h="disconnecting",p="disconnected",d="PLAIN",v="X-ACISION-OAUTH",m="error",g="success",y=new r.Factory;y.use(i("sasl-plain")),y.use(o);var b=new r.Factory;b.use(i("sasl-anonymous"));var E=function(e,t){var r=this,i=t.baseUrl+"/auth/v1.1";/^wss?:\/\//.test(i)||(i=i.replace(/^.*:\/\//,""),i="wss://"+i),i=i.concat("?apiKey=",e),t.refreshToken&&(i=i.concat("&refreshToken=",t.refreshToken)),this.config=t,this.mech=null,this.state=f,this.ws=new n(i,["wamp"],{autoReconnect:!1,onConnect:function(){r.onConnect()},onClose:function(){r.onClose()},onError:function(){r.state=h,r.emitEvent(m)}})};return E.prototype=new t,E.prototype.constructor=E,E.prototype.onConnect=function(){if(this.config.refreshToken)return this.getBootstrapConfig();var t=this;this.state=l,this.ws.call(a+"/requestMechanisms",{callRes:function(e){t.onReceivedMechs(e)},callErr:e.bind(this.handleCallError,this)})},E.prototype.onClose=function(){this.state!==h&&(u.warn("Unexpected disconnect"),this.emitEvent(m)),this.state=p},E.prototype.onReceivedMechs=function(t){var n=this;this.config.anonymous?this.mech=b.create(t):this.mech=y.create(t);if(!this.mech){u.warn("No mutually-supported mechanisms:",t),this.state=h,this.ws.disconnect(),this.emitEvent(m);return}var r={mechanism:this.mech.name};if(this.mech.clientFirst){var i=this.createCredentials();r.response=btoa(this.mech.response(i))}this.ws.call(a+"/requestAuthentication",{callRes:function(e){if(e.type==="challenge"){n.onChallenge(e.challenge);return}n.onOutcome(e.type,e.data)},callErr:e.bind(this.handleCallError,this)},r)},E.prototype.onChallenge=function(e){var t=this,n=this.mech;if(n.name===v){n.challenge(atob(e));if(n.immediateUrl){var r=function(e){var n=JSON.stringify({authCode:e.code});t.sendResponse(n)},i=function(){t.state=h,t.ws.disconnect(),t.emitEvent(m,[{interactiveUrl:n.interactiveUrl}])},s;if(this.config.authDisplay==="frame"){var o=document.createElement("iframe");o.style.display="none",o.id="acisionsdk-oauth-frame",o.src=n.immediateUrl,document.getElementsByTagName("body")[0].appendChild(o),s=o.contentWindow,s.close=function(){o.remove()}}else if(!this.config.authDisplay||this.config.authDisplay==="popup")s=window.open(n.immediateUrl,"OAuthPopup");var a=Date.now()+5e3,f=window.setInterval(function(){if(s.location.origin===window.location.origin){window.clearInterval(f);var e=w(s.location.search);s.close(),e.code?r(e):(u.warn("OAuth error:",e),i());return}Date.now()>a&&(window.clearInterval(f),u.warn("OAuth timeout"),i())},500);return}u.info("Interactive auth required:",n.interactiveUrl),this.state=h,this.ws.disconnect(),this.emitEvent(m,[{interactiveUrl:n.interactiveUrl}]);return}u.warn("Unexpected challenge:",e),this.state=h,this.ws.disconnect(),this.emitEvent(m);return},E.prototype.sendResponse=function(t){var n=this,r={response:btoa(t)};this.ws.call(a+"/sendResponse",{callRes:function(e){if(e.type==="challenge"){n.onChallenge(e.challenge);return}n.onOutcome(e.type,e.data)},callErr:e.bind(this.handleCallError,this)},r)},E.prototype.onOutcome=function(e,t){if(e==="success"){this.state=c,this.getBootstrapConfig();return}u.warn("Unsuccessful outcome:",e,t),this.state=h,this.ws.disconnect(),this.emitEvent(m)},E.prototype.createCredentials=function(){var e=this.config,t={};return this.mech.name===d?(t.username=e.username,t.password=e.password):this.mech.name===v&&(t.username=e.username,e.authAccessToken?t.authAccessToken=e.password:e.password&&(t.authCode=e.password)),t},E.prototype.getBootstrapConfig=function(){var t=this;this.ws.call(a+"/getBootstrapConfig",{callRes:function(e){t.state=h,t.ws.disconnect(),t.emitEvent(g,[e])},callErr:e.bind(this.handleCallError,this)})},E.prototype.handleCallError=function(e,t,n){u.warn("Auth call error:",e,t,n),this.state=h,this.ws.disconnect(),this.emitEvent(m)},E}),r("src/network-api",["underscore","EventEmitter","wampy","logger"],function(e,t,n,r){function a(e){this.wampBaseUri=e}var i=r.get("SDK:Net"),s="http://sdk.acision.com/auth/v1.1/setAccessToken",o="error",u="ready";return a.prototype=new t,a.prototype.constructor=a,a.prototype.init=function(t,r,s,u){var a=this;this.sdk=t,this.enabled=r,this.ready=!1;if(!r)return;if(this.wampBaseUri&&s&&t.config.persistent){var f;e.isArray(s)?f=e.sample(s):f=s,this.ws=new n(f,["wamp"],{autoReconnect:!0,onConnect:function(){a.onConnect()},onError:function(){a.ready=!1},onReconnect:function(){i.warn("Reconnecting...")},onClose:function(){a.ws&&(i.error("Max retries reached; aborting"),a.emitEvent(o))}});return}var l=u;e.isArray(l)&&(l=e.sample(l)),l.slice(-1)!=="/"&&(l+="/"),this.restUrl=l,this.ready=!0},a.prototype.isReady=function(){return!this.enabled||this.ready},a.prototype.onConnect=function(){i.info("Connected"),this.refreshConfig()},a.prototype.refreshConfig=function(){var e=this;if(!this.ws)return;this.ws.call(s,{callRes:function(){i.debug("Authentication successful"),e.ready=!0,e.emitEvent(u)},callErr:function(){i.debug("Authentication failed"),e.emitEvent(o)}},this.sdk.config.accessToken)},a.prototype.sendRequest=function(t,n,r,i,s){if(!this.enabled)throw new Error("API is disabled");if(this.ws){if(!this.ready)throw new Error("API not ready - did you wait for the onConnected event?");this.ws.call(this.wampBaseUri+n,{callRes:i,callErr:s},r)}else{var o=new XMLHttpRequest;o.open(t,this.restUrl+n),o.setRequestHeader("Authorization","Bearer "+this.sdk.config.accessToken),o.setRequestHeader("Content-Type","application/json"),o.setRequestHeader("Accept","application/json"),o.responseType="json",o.onload=function(){this.status>=200&&this.status<300?i(this.response):s(this.response||{code:"RestError",message:"Unknown error: "+this.status})},o.onerror=function(){s({code:"NetworkError",message:"A network error was encountered"})},o.onabort=function(){s({code:"AbortError",message:"The request was aborted"})},o.ontimeout=function(){s({code:"TimeoutError",message:"The request timed out"})},r&&!e.isString(r)&&(r=JSON.stringify(r)),o.send(r)}},a.prototype.disconnect=function(){this.ws&&(this.ws.disconnect(),delete this.ws)},a}),function(){function h(e,t,n){var r=t&&n||0,i=0;t=t||[],e.toLowerCase().replace(/[0-9a-f]{2}/g,function(e){i<16&&(t[r+i++]=l[e])});while(i<16)t[r+i++]=0;return t}function p(e,t){var n=t||0,r=f;return r[e[n++]]+r[e[n++]]+r[e[n++]]+r[e[n++]]+"-"+r[e[n++]]+r[e[n++]]+"-"+r[e[n++]]+r[e[n++]]+"-"+r[e[n++]]+r[e[n++]]+"-"+r[e[n++]]+r[e[n++]]+r[e[n++]]+r[e[n++]]+r[e[n++]]+r[e[n++]]}function b(e,t,n){var r=t&&n||0,i=t||[];e=e||{};var s=e.clockseq!=null?e.clockseq:m,o=e.msecs!=null?e.msecs:(new Date).getTime(),u=e.nsecs!=null?e.nsecs:y+1,a=o-g+(u-y)/1e4;a<0&&e.clockseq==null&&(s=s+1&16383),(a<0||o>g)&&e.nsecs==null&&(u=0);if(u>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");g=o,y=u,m=s,o+=122192928e5;var f=((o&268435455)*1e4+u)%4294967296;i[r++]=f>>>24&255,i[r++]=f>>>16&255,i[r++]=f>>>8&255,i[r++]=f&255;var l=o/4294967296*1e4&268435455;i[r++]=l>>>8&255,i[r++]=l&255,i[r++]=l>>>24&15|16,i[r++]=l>>>16&255,i[r++]=s>>>8|128,i[r++]=s&255;var c=e.node||v;for(var h=0;h<6;h++)i[r+h]=c[h];return t?t:p(i)}function w(e,n,r){var i=n&&r||0;typeof e=="string"&&(n=e=="binary"?new a(16):null,e=null),e=e||{};var s=e.random||(e.rng||t)();s[6]=s[6]&15|64,s[8]=s[8]&63|128;if(n)for(var o=0;o<16;o++)n[i+o]=s[o];return n||p(s)}var e=this,t;if(typeof n=="function")try{var i=n("crypto").randomBytes;t=i&&function(){return i(16)}}catch(s){}if(!t&&e.crypto&&crypto.getRandomValues){var o=new Uint8Array(16);t=function(){return crypto.getRandomValues(o),o}}if(!t){var u=new Array(16);t=function(){for(var e=0,t;e<16;e++)(e&3)===0&&(t=Math.random()*4294967296),u[e]=t>>>((e&3)<<3)&255;return u}}var a=typeof Buffer=="function"?Buffer:Array,f=[],l={};for(var c=0;c<256;c++)f[c]=(c+256).toString(16).substr(1),l[f[c]]=c;var d=t(),v=[d[0]|1,d[1],d[2],d[3],d[4],d[5]],m=(d[6]<<8|d[7])&16383,g=0,y=0,E=w;E.v1=b,E.v4=w,E.parse=h,E.unparse=p,E.BufferClass=a;if(typeof r=="function"&&r.amd)r("uuid",[],function(){return E});else if(typeof module!="undefined"&&module.exports)module.exports=E;else{var S=e.uuid;E.noConflict=function(){return e.uuid=S,E},e.uuid=E}}.call(this),r("src/messaging",["underscore","EventEmitter","wampy","logger","./network-api","uuid"],function(e,t,n,r,i,s){function w(t,n){return e.isArray(t)||(t=[t]),e.map(t,function(e){return e.indexOf("@")<0?e.concat("@",n):e})}function S(e){var t=[];if(e&&"deliveryModes"in e){var n=e.deliveryModes.length;for(var r=0;r<n;r++)y.indexOf(e.deliveryModes[r])>-1?t.push(e.deliveryModes[r]):o.warn("Found invalid delivery mode "+e.deliveryModes[r])}else e&&"advancedServices"in e&&(o.warn('"advancedServices" option is deprecated use "deliveryModes"'),e.advancedServices===h?t=[g]:e.advancedServices===p?t=[d,v,g]:e.advancedServices===c&&(t=[d,v,m]));return t}function x(t,n,r,i,s){var u={};u.token=n,u.appARN=r,u.notificationMessage=i,t.sendRequest("POST","requestMessageNotification",u,function(){o.debug("requestMessageNotification succeeded"),s&&e.isFunction(s.onAcknowledged)&&s.onAcknowledged()},function(t){o.warn("requestMessageNotification failed"),s&&e.isFunction(s.onError)&&s.onError(t.code,t.message)})}var o=r.get("SDK:Msg"),u=r.get("SDK:Msg:FileXfer"),a="http://sdk.acision.com/messaging/v1.1/",f="1.1",l="application/x-acision-sdk-file-transfer",c="never",h="always",p="fallback",d="immediate",v="push",m="offline",g="fallback",y=[d,v,m,g],b=[d,v,m],E=function(e){var t=e.config.interfaces.messaging,n=null,r=null;t&&(n=t.wsEndpoints[f],r=t.restEndpoints[f]),this.init(e,!!t,n,r),this.deliveryModes=b,this.pendingFileTransfers={},this.pendingFileUploadIDs={},this.pendingFileUploadAborts={}};return E.prototype=new i(a),E.prototype.constructor=E,E.prototype.sendToDestination=function(t,n,r,i){var u=this.sdk.config;t=w(t,u.defaultDomain);var a={from:r&&r.from||u.primaryAddress,to:t,content:n};r&&r.contentType&&(a.contentType=r.contentType);var f=S(r);f.length===0&&(f=this.deliveryModes),a.delivery_modes=f,r&&r.ttl&&(a.ttl=r.ttl),this.sendRequest("POST","sendMessage",a,function(t){o.debug("sendMessage succeeded");if(i&&e.isFunction(i.onAcknowledged)){var n;t&&t.msgid?n=t.msgid:(o.debug("v1.0 compatibility: generating local message ID"),n=s.v1()),i.onAcknowledged(n)}},function(t){o.warn("sendMessage failed"),i&&e.isFunction(i.onError)&&i.onError(t.code,t.message)})},E.prototype.sendToDestinations=E.prototype.sendToDestination,E.prototype.sendToGroup=function(t,n,r,i){var u=this.sdk.config;e.isArray(t)||(t=[t]);var a={from:r&&r.from||u.primaryAddress,toGroup:t,content:n};r&&r.contentType&&(a.contentType=r.contentType);var f=S(r);f.length===0&&(f=this.deliveryModes),a.delivery_modes=f,r&&r.ttl&&(a.ttl=r.ttl),this.sendRequest("POST","sendMessage",a,function(t){o.debug("sendMessage succeeded");if(i&&e.isFunction(i.onAcknowledged)){var n;t&&t.msgid?n=t.msgid:(o.debug("v1.0 compatibility: generating message ID"),n=s.v1()),i.onAcknowledged(n)}},function(t){o.warn("sendMessage failed"),i&&e.isFunction(i.onError)&&i.onError(t.code,t.message)})},E.prototype.sendFileToDestination=function(t,n,r){var i=this.sdk.config,s=this,o=e.unique();t=w(t,i.defaultDomain);var a={from:i.primaryAddress,to:t,contentType:n.contentType||n.file.type||"application/octet-stream",fileName:n.file.name,message:n.message};return e.isUndefined(n.file.size)||(a.contentLength=n.file.size),e.isUndefined(n.contentDisposition)||(a.contentDisposition=n.contentDisposition),u.info("Sending request to upload file\n",n.file),this.sendRequest("POST","allocateFile",a,function(e){u.info(e.serverId+": Obtained file transfer ID"),s.pendingFileTransfers[e.serverId]={serverId:e.serverId,params:a,file:n.file,callbacks:r,internalId:o,delayAbort:!1},s.pendingFileUploadIDs[o]=e.serverId;if(s.pendingFileUploadAborts[o]){delete s.pendingFileUploadAborts[o],s._sendAbortFile(e.serverId,!0);return}},function(t){u.warn("Request failed: "+t.code+": "+t.message),r&&e.isFunction(r.onError)&&r.onError(t.code,t.message)}),{abort:function(){e.isUndefined(s.pendingFileUploadIDs[o])?s.pendingFileUploadAborts[o]=!0:s._sendAbortFile(s.pendingFileUploadIDs[o],!0)}}},E.prototype._putFile=function(t){var n=this;if(e.isUndefined(this.pendingFileTransfers[t.serverId])){u.error(t.serverId+": Unknown ID in file upload message");return}var r=this.pendingFileTransfers[t.serverId];if(!t.accept){n._fileTransferError(r.serverId,!0,{code:"Rejected",message:"Rejected by recipient"},!0);return}u.info(t.serverId+": Preparing file upload"),r.xhr=new XMLHttpRequest,r.xhr.open("PUT",t.url),r.xhr.setRequestHeader("Content-Type",r.params.contentType),r.xhr.setRequestHeader("Content-Disposition",r.params.contentDisposition),r.xhr.setRequestHeader("x-awz-meta-filename",r.params.fileName),r.xhr.addEventListener("load",function(){if(this.status<200||this.status>=300){n._fileTransferError(r.serverId,!0,this.response||{code:"RestError",message:"Unknown error: "+this.status});return}u.info(t.serverId+": File upload succeeded"),u.info(t.serverId+": Notifying server"),n.sendRequest("POST","sendFile",{serverId:r.serverId},function(){})}),r.callbacks&&e.isFunction(r.callbacks.onProgress)&&r.xhr.upload.addEventListener("progress",function(t){r.callbacks.onProgress(t.lengthComputable||!e.isUndefined(t.total)?t.total:undefined,t.loaded)}),r.xhr.addEventListener("error",e.bind(n._fileTransferError,n,r.serverId,!0,{code:"NetworkError",message:"A network error was encountered"})),r.xhr.addEventListener("abort",e.bind(n._fileTransferError,n,r.serverId,!0,{code:"AbortError",message:"The request was aborted"})),r.xhr.addEventListener("timeout",e.bind(n._fileTransferError,n,r.serverId,!0,{code:"TimeoutError",message:"The request timed out"})),u.info(t.serverId+": Uploading file"),r.xhr.send(r.file)},E.prototype._getFile=function(t){var n=this;if(e.isUndefined(this.pendingFileTransfers[t.serverId])){u.error(t.serverId+": Unknown ID in file download message");return}var r=this.pendingFileTransfers[t.serverId],i=e.omit(r.params,["contentType","contentDisposition","fileName","message","contentLength"]);e.extend(i,e.pick(t,["contentType","contentDisposition","fileName","message"])),i.fileSize=t.contentLength,u.info(t.serverId+": Preparing file download"),r.xhr=new XMLHttpRequest,r.xhr.open("GET",t.url),r.xhr.responseType="blob",r.xhr.addEventListener("load",function(){if(this.status<200||this.status>=300){n._fileTransferError(r.serverId,!1,this.response||{code:"RestError",message:"Unknown error: "+this.status});return}u.info(t.serverId+": File download succeeded"),u.info(t.serverId+": Notifying server"),n.sendRequest("POST","receivedFile",{serverId:r.serverId},function(){}),delete n.pendingFileTransfers[t.serverId],delete n.pendingFileUploadIDs[r.internalId],r.callbacks.onDownloaded(i,r.xhr.response)}),r.callbacks&&e.isFunction(r.callbacks.onProgress)&&r.xhr.addEventListener("progress",function(t){r.callbacks.onProgress(t.lengthComputable||!e.isUndefined(t.total)?t.total:undefined,t.loaded)}),r.xhr.addEventListener("error",e.bind(n._fileTransferError,n,r.serverId,!1,{code:"NetworkError",message:"A network error was encountered"})),r.xhr.addEventListener("abort",e.bind(n._fileTransferError,n,r.serverId,!1,{code:"AbortError",message:"The request was aborted"})),r.xhr.addEventListener("timeout",e.bind(n._fileTransferError,n,r.serverId,!1,{code:"TimeoutError",message:"The request timed out"})),u.info(t.serverId+": Downloading file"),r.xhr.send(r.file)},E.prototype._fileTransferError=function(t,n,r,i){u.warn(t+": File transfer failed: "+r.code+": "+r.message);if(e.isUndefined(this.pendingFileTransfers[t]))return;var s=this.pendingFileTransfers[t];i||this._sendAbortFile(t,n),s.callbacks&&e.isFunction(s.callbacks.onError)&&s.callbacks.onError(r.code,"File transfer failed: "+r.message)},E.prototype._incomingFile=function(t,n){var r=this,i=e.pick(t,["from","to","toGroup"]);e.extend(i,e.pick(t.content,["contentType","contentLength","contentDisposition","fileName","message"]));var s={params:i,serverId:t.content.serverId,delayAbort:!0};this.pendingFileTransfers[s.serverId]=s;if(e.isFunction(n)){var o=e.omit(i,"contentLength");e.isUndefined(i.contentLength)||(o.fileSize=i.contentLength),o.accept=e.bind(r._sendAcceptFile,r,t.content.serverId),o.reject=e.bind(r._sendRejectFile,r,t.content.serverId),o.abort=e.bind(r._sendAbortFile,r,t.content.serverId,!1),n(o)}else this._sendRejectFile(s.serverId)},E.prototype._downloadedFile=function(t){if(e.isUndefined(this.pendingFileTransfers[t.serverId])){u.error(t.serverId+": Unknown ID in file upload message");return}var n=this.pendingFileTransfers[t.serverId];n.callbacks&&e.isFunction(n.callbacks.onAcknowledged)&&n.callbacks.onAcknowledged(),delete this.pendingFileTransfers[t.serverId],delete this.pendingFileUploadIDs[n.internalId]},E.prototype._abortedFile=function(t){if(e.isUndefined(this.pendingFileTransfers[t.serverId])){u.error(t.serverId+": Unknown ID in file transfer message");return}u.info(t.serverId+": Aborting file transfer");var n=this.pendingFileTransfers[t.serverId];if(n.delayAbort){u.info(t.serverId+": Delaying abort until accept/reject"),n.pendingAbort=!0;return}delete this.pendingFileTransfers[t.serverId],delete this.pendingFileUploadIDs[n.internalId],n.xhr&&n.xhr.abort();var r={serverId:n.serverId,senderInitiated:t.senderInitiated};this.sendRequest("POST","abortAckFile",r,function(){u.info(n.serverId+": Ack'd abort")},function(e){u.info(n.serverId+": Ack failed: "+e.code+": "+e.message)}),n.callbacks&&e.isFunction(n.callbacks.onError)&&n.callbacks.onError("Aborted","File transfer failed: Aborted by user")},E.prototype._sendAcceptFile=function(t,n){if(e.isUndefined(this.pendingFileTransfers[t])){u.error(t+": Accepting unknown ID");return}var r=this.pendingFileTransfers[t];r.callbacks=n,r.delayAbort=!1;if(r.pendingAbort){u.info(t+": Acting on delayed abort"),this._abortedFile({serverId:r.serverId,senderInitiated:!0});return}var i={serverId:r.serverId,accept:!0};u.info(r.serverId+": Accepting file"),this.sendRequest("POST","acceptFile",i,function(){u.info(r.serverId+": Accepted file")},function(t){u.info(r.serverId+": Acceptance failed: "+t.code+": "+t.message),n&&e.isFunction(n.onError)&&n.onError(t.code,t.message)})},E.prototype._sendRejectFile=function(t){if(e.isUndefined(this.pendingFileTransfers[t])){u.error(t+": Rejecting unknown ID");return}var n=this.pendingFileTransfers[t];n.delayAbort=!1;if(n.pendingAbort){u.info(t+": Acting on delayed abort"),this._abortedFile({serverId:n.serverId,senderInitiated:!0});return}delete this.pendingFileTransfers[t],delete this.pendingFileUploadIDs[n.internalId];var r={serverId:n.serverId,accept:!1};u.info(n.serverId+": Rejecting file"),this.sendRequest("POST","acceptFile",r,function(){u.info(n.serverId+": Rejected file")},function(e){u.info(n.serverId+": Rejection failed: "+e.code+": "+e.message)})},E.prototype._sendAbortFile=function(t,n){if(e.isUndefined(this.pendingFileTransfers[t])){u.error(t+": Aborting unknown ID");return}u.info(t+": Aborting file transfer");var r=this.pendingFileTransfers[t];delete this.pendingFileTransfers[t],delete this.pendingFileUploadIDs[r.internalId],r.xhr&&r.xhr.abort();var i={serverId:r.serverId,senderInitiated:n};this.sendRequest("POST","abortFile",i,function(){u.info(r.serverId+": Aborted file")},function(e){u.info(r.serverId+": Abort failed: "+e.code+": "+e.message)})},E.prototype.setCallbacks=function(e){var t=this;if(!this.ws)throw new Error('Cannot set callbacks for a non-persistent connection. Use "requestMessageNotification"');e.onMessage&&this.ws.subscribe(a+"message?device="+this.sdk.uuid,function(n){switch(n.contentType){case l:switch(n.content.state){case"accept":t._putFile(n.content);break;case"downloaded":t._downloadedFile(n.content);break;case"request":t._incomingFile(n,e.onFileAvailable);break;case"ready":t._getFile(n.content);break;case"aborted":t._abortedFile(n.content);break;case"abortedack":break;default:o.error("Unexpected file transfer message",n)}break;default:e.onMessage(n)}})},E.prototype.requestMessageNotification=function(e,t,n,r){if(this.ws)throw new Error('Do not request Message Notification for a persistent connection. Use "setCallbacks"');if(!e)throw new Error('Must specify "token" parameter');if(!t)throw new Error('Must specify "appARN" parameter');if(!n)throw new Error('Must specify "notificationMessage" parameter');var i=this;x(i,e,t,n,r),setInterval(function(){x(i,e,t,n,r)},3e5)},E.prototype.getMessages=function(t,n){if(this.ws)throw new Error('Do not use getMessages for a persistent connection. Use "setCallbacks"');if(!t)throw new Error("Must specify a unique identifier for this instance.");var r={};r.uniqueId=t,this.sendRequest("GET","getMessages/"+t,r,function(){o.debug("getMessages succeeded"),n&&e.isFunction(n.onAcknowledged)&&n.onAcknowledged()},function(t){o.warn("getMessages failed"),n&&e.isFunction(n.onError)&&n.onError(t.code,t.message)})},E.prototype.recallMessage=function(t,n){if(!t)throw new Error("Must specify the message to recall.");var r={msgid:t};this.sendRequest("POST","recallMessage",r,function(t){o.debug("recallMessage succeeded"),n&&e.isFunction(n.onResult)&&n.onResult(t.unread)},function(t){o.warn("recallMessage failed"),n&&e.isFunction(n.onError)&&n.onError(t.code,t.message)})},E.prototype.setOptions=function(e){var t=S(e);t.length!==0&&(this.deliveryModes=t)},E}),r("src/contacts",["underscore","EventEmitter","wampy","logger","./network-api"],function(e,t,n,r,i){var s=r.get("SDK:Contacts"),o="1.1",u=function(e){var t=e.config.interfaces.contacts,n=null;t&&(n=t.restEndpoints[o]),this.init(e,!!t,null,n)};return u.prototype=new i(null),u.prototype.constructor=u,u.prototype.setGroup=function(t,n,r){this.sendRequest("PUT","lists/"+t,n,function(){r&&e.isFunction(r.onSuccess)&&r.onSuccess()},function(t){r&&e.isFunction(r.onError)&&r.onError(t.code,t.message)})},u.prototype.getGroup=function(t,n){this.sendRequest("GET","lists/"+t,null,function(t){n&&e.isFunction(n.onSuccess)&&n.onSuccess(t)},function(t){if(t.code==="ResourceNotFound"){n&&e.isFunction(n.onSuccess)&&n.onSuccess([]);return}n&&e.isFunction(n.onError)&&n.onError(t.code,t.message)})},u.prototype.deleteGroup=function(t,n){this.sendRequest("DELETE","lists/"+t,null,function(){n&&e.isFunction(n.onSuccess)&&n.onSuccess()},function(t){n&&e.isFunction(n.onError)&&n.onError(t.code,t.message)})},u.prototype.addToGroup=function(t,n,r){this.sendRequest("POST","lists/"+t+"/add",n,function(){r&&e.isFunction(r.onSuccess)&&r.onSuccess()},function(t){r&&e.isFunction(r.onError)&&r.onError(t.code,t.message)})},u.prototype.removeFromGroup=function(t,n,r){this.sendRequest("POST","lists/"+t+"/remove",n,function(){r&&e.isFunction(r.onSuccess)&&r.onSuccess()},function(t){r&&e.isFunction(r.onError)&&r.onError(t.code,t.message)})},u.prototype.getUserConfig=function(t){this.sendRequest("GET","settings",null,function(n){s.debug("getUserConfig succeeded"),t&&e.isFunction(t.onSuccess)&&t.onSuccess(n)},function(n){s.warn("getUserConfig failed"),t&&e.isFunction(t.onError)&&t.onError(n.code,n.message)})},u.prototype.setUserConfig=function(t,n){this.sendRequest("PUT","settings",t,function(){s.debug("setUserConfig succeeded"),n&&e.isFunction(n.onSuccess)&&n.onSuccess()},function(t){s.warn("setUserConfig failed"),n&&e.isFunction(n.onError)&&n.onError(t.code,t.message)})},u}),function(e){var t=function(){var e={};return Object.defineProperties(e,{version:{get:function(){return"0.3.0-crocodile-3-devel"}},name:{get:function(){return"JsSIP"}}}),e}();(function(e){var t,n,r=e.name+" | "+"EVENT EMITTER"+" | ";t=function(){},t.prototype={initEvents:function(e){var t=e.length;this.events={},this.onceNotFired=[],this.maxListeners=10,this.events.newListener=function(e){console.log(r+"new listener added to event "+e)};while(t--)console.log(r+"adding event "+e[t]),this.events[e[t]]=[]},checkEvent:function(e){return this.events[e]?!0:(console.error(r+"no event named "+e),!1)},addListener:function(e,t){if(!this.checkEvent(e))return;this.events[e].length>=this.maxListeners&&console.warn(r+"max listeners exceeded for event "+e),this.events[e].push(t),this.events.newListener.call(null,e)},on:function(e,t){this.addListener(e,t)},once:function(e,t){this.events[e].unshift(t),this.onceNotFired.push(e)},removeListener:function(e,t){if(!this.checkEvent(e))return;var n=this.events[e],r=0,i=n.length;while(r<i)n[r]&&n[r].toString()===t.toString()?n.splice(r,1):r++},removeAllListener:function(e){if(!this.checkEvent(e))return;this.events[e]=[]},setMaxListeners:function(e){Number(e)&&(this.maxListeners=e)},listeners:function(e){return this.events[e]},emit:function(t,n,i){var s,o,u=0;if(!this.checkEvent(t))return;console.log(r+"emitting event "+t),s=this.events[t],o=s.length;var a=new e.Event(t,n,i);if(a)for(u;u<o;u++)try{s[u].apply(null,[a])}catch(f){console.warn(r+"event handler threw exception:\n",f.stack)}else for(u;u<o;u++)try{s[u].call()}catch(f){console.warn(r+"event handler threw exception:\n",f.stack)}u=this.onceNotFired.indexOf(t),u!==-1&&(this.onceNotFired.splice(u,1),this.events[t].shift())},newListener:function(e){this.events.newListener=e}},n=function(e,t,n){this.type=e,this.sender=t,this.data=n},e.EventEmitter=t,e.Event=n})(t),t.C={USER_AGENT:t.name+" "+t.version,SIP:"sip",INVALID_TARGET_URI:"sip:invalid@invalid",causes:{CONNECTION_ERROR:"Connection Error",REQUEST_TIMEOUT:"Request Timeout",SIP_FAILURE_CODE:"SIP Failure Code",INVALID_TARGET:"Invalid Target",INVALID_REFER_TO_TARGET:"Invalid Refer-To Target",INTERNAL_ERROR:"Internal Error",BUSY:"Busy",REJECTED:"Rejected",REDIRECTED:"Redirected",UNAVAILABLE:"Unavailable",NOT_FOUND:"Not Found",ADDRESS_INCOMPLETE:"Address Incomplete",INCOMPATIBLE_SDP:"Incompatible SDP",AUTHENTICATION_ERROR:"Authentication Error",DIALOG_ERROR:"Dialog Error",WEBRTC_NOT_SUPPORTED:"WebRTC Not Supported",WEBRTC_ERROR:"WebRTC Error",CANCELED:"Canceled",NO_ANSWER:"No Answer",EXPIRES:"Expires",NO_ACK:"No ACK",USER_DENIED_MEDIA_ACCESS:"User Denied Media Access",BAD_MEDIA_DESCRIPTION:"Bad Media Description",RTP_TIMEOUT:"RTP Timeout",SESSION_TIMER:"Session Timer Expired"},SIP_ERROR_CAUSES:{REDIRECTED:[300,301,302,305,380],BUSY:[486,600],REJECTED:[403,603],NOT_FOUND:[404,604],UNAVAILABLE:[480,410,408,430],ADDRESS_INCOMPLETE:[484],INCOMPATIBLE_SDP:[488,606],AUTHENTICATION_ERROR:[401,407]},ACK:"ACK",BYE:"BYE",CANCEL:"CANCEL",INFO:"INFO",INVITE:"INVITE",MESSAGE:"MESSAGE",NOTIFY:"NOTIFY",OPTIONS:"OPTIONS",REGISTER:"REGISTER",UPDATE:"UPDATE",SUBSCRIBE:"SUBSCRIBE",REFER:"REFER",SIP_EXTENSIONS:{TIMER:"timer",TARGET_DIALOG:"tdialog",GRUU:"gruu"},REASON_PHRASE:{100:"Trying",180:"Ringing",181:"Call Is Being Forwarded",182:"Queued",183:"Session Progress",199:"Early Dialog Terminated",200:"OK",202:"Accepted",204:"No Notification",300:"Multiple Choices",301:"Moved Permanently",302:"Moved Temporarily",305:"Use Proxy",380:"Alternative Service",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Timeout",410:"Gone",412:"Conditional Request Failed",413:"Request Entity Too Large",414:"Request-URI Too Long",415:"Unsupported Media Type",416:"Unsupported URI Scheme",417:"Unknown Resource-Priority",420:"Bad Extension",421:"Extension Required",422:"Session Interval Too Small",423:"Interval Too Brief",428:"Use Identity Header",429:"Provide Referrer Identity",430:"Flow Failed",433:"Anonymity Disallowed",436:"Bad Identity-Info",437:"Unsupported Certificate",438:"Invalid Identity Header",439:"First Hop Lacks Outbound Support",440:"Max-Breadth Exceeded",469:"Bad Info Package",470:"Consent Needed",478:"Unresolvable Destination",480:"Temporarily Unavailable",481:"Call/Transaction Does Not Exist",482:"Loop Detected",483:"Too Many Hops",484:"Address Incomplete",485:"Ambiguous",486:"Busy Here",487:"Request Terminated",488:"Not Acceptable Here",489:"Bad Event",491:"Request Pending",493:"Undecipherable",494:"Security Agreement Required",500:"Server Internal Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Server Time-out",505:"Version Not Supported",513:"Message Too Large",580:"Precondition Failure",600:"Busy Everywhere",603:"Decline",604:"Does Not Exist Anywhere",606:"Not Acceptable"}},function(t){var n;n={ConfigurationError:function(){var t=function(t,n){this.code=1,this.name="CONFIGURATION_ERROR",this.parameter=t,this.value=n,this.message=this.value?"Invalid value "+e.JSON.stringify(this.value)+' for parameter "'+this.parameter+'"':"Missing parameter: "+this.parameter};return t.prototype=new Error,t}(),InvalidTargetError:function(){var e=function(e){this.code=2,this.name="INVALID_TARGET_ERROR",this.target=e,this.message="Invalid target: "+this.target};return e.prototype=new Error,e}(),InvalidStateError:function(){var e=function(e){this.code=3,this.name="INVALID_STATE_ERROR",this.status=e};return e.prototype=new Error,e}(),RemoteSupportError:function(){var e=function(e){this.code=4,this.name="REMOTE_SUPPORT_ERROR",this.option=e,this.message="Remote UA does not support method/extension: "+e};return e.prototype=new Error,e}()},t.Exceptions=n}(t),function(e){var t,n=500,r=4e3,i=5e3;t={T1:n,T2:r,T4:i,TIMER_B:64*n,TIMER_D:0*n,TIMER_F:64*n,TIMER_H:64*n,TIMER_I:0*n,TIMER_J:0*n,TIMER_K:0*i,TIMER_L:64*n,TIMER_M:64*n},e.Timers=t}(t),function(t){var n,r=t.name+" | "+"TRANSPORT"+" | ",i={STATUS_READY:0,STATUS_DISCONNECTED:1,STATUS_ERROR:2};n=function(e,t){this.ua=e,this.ws=null,this.server=t,this.reconnection_attempts=0,this.closed=!1,this.connected=!1,this.reconnectTimer=null,this.lastTransportError={},this.ua.transport=this,this.connect()},n.prototype={send:function(e){var t=e.toString();return this.ws&&this.ws.readyState===WebSocket.OPEN?(this.ua.configuration.trace_sip===!0&&console.log(r+"sending WebSocket message:\n\n"+t+"\n"),this.ws.send(t),!0):(console.warn(r+"unable to send message, WebSocket is not open"),!1)},disconnect:function(){this.ws&&(this.closed=!0,console.log(r+"closing WebSocket "+this.server.ws_uri),this.ws.close()),this.reconnectTimer!==null&&(e.clearTimeout(this.reconnectTimer),this.reconnectTimer=null,this.ua.emit("disconnected",this.ua,{transport:this,code:this.lastTransportError.code,reason:this.lastTransportError.reason}))},connect:function(){var e=this;if(!(!this.ws||this.ws.readyState!==WebSocket.OPEN&&this.ws.readyState!==WebSocket.CONNECTING))return console.log(r+"WebSocket "+this.server.ws_uri+" is already connected"),!1;this.ws&&this.ws.close(),console.log(r+"connecting to WebSocket "+this.server.ws_uri);try{this.ws=new WebSocket(this.server.ws_uri,"sip")}catch(t){console.warn(r+"error connecting to WebSocket "+this.server.ws_uri+": "+t)}this.ws.binaryType="arraybuffer",this.ws.onopen=function(){e.onOpen()},this.ws.onclose=function(t){e.onClose(t)},this.ws.onmessage=function(t){e.onMessage(t)},this.ws.onerror=function(t){e.onError(t)}},onOpen:function(){this.connected=!0,console.log(r+"WebSocket "+this.server.ws_uri+" connected"),this.reconnectTimer!==null&&(e.clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.reconnection_attempts=0,this.closed=!1,this.ua.onTransportConnected(this)},onClose:function(e){var t=this.connected;this.connected=!1,this.lastTransportError.code=e.code,this.lastTransportError.reason=e.reason,console.log(r+"WebSocket disconnected (code: "+e.code+(e.reason?"| reason: "+e.reason:"")+")"),e.wasClean===!1&&console.warn(r+"WebSocket abrupt disconnection"),t===!0?(this.ua.onTransportClosed(this),this.closed?this.ua.emit("disconnected",this.ua,{transport:this,code:this.lastTransportError.code,reason:this.lastTransportError.reason}):this.reConnect()):this.ua.onTransportError(this)},onMessage:function(e){var n,i,s=e.data;if(s==="\r\n"){this.ua.configuration.trace_sip===!0&&console.log(r+"received WebSocket message with CRLF Keep Alive response");return}if(typeof s!="string"){try{s=String.fromCharCode.apply(null,new Uint8Array(s))}catch(o){console.warn(r+"received WebSocket binary message failed to be converted into string, message discarded");return}this.ua.configuration.trace_sip===!0&&console.log(r+"received WebSocket binary message:\n\n"+s+"\n")}else this.ua.configuration.trace_sip===!0&&console.log(r+"received WebSocket text message:\n\n"+s+"\n");n=t.Parser.parseMessage(s);if(this.ua.status===t.UA.C.STATUS_USER_CLOSED&&n instanceof t.IncomingRequest)return;if(n&&t.sanityCheck(n,this.ua,this))if(n instanceof t.IncomingRequest)n.transport=this,this.ua.receiveRequest(n);else if(n instanceof t.IncomingResponse)switch(n.method){case t.C.INVITE:i=this.ua.transactions.ict[n.via_branch],i&&i.receiveResponse(n);break;case t.C.ACK:break;default:i=this.ua.transactions.nict[n.via_branch],i&&i.receiveResponse(n)}},onError:function(e){console.warn(r+"WebSocket connection error: "+e)},reConnect:function(){var t=this;this.reconnection_attempts+=1,this.reconnection_attempts>this.ua.configuration.ws_server_max_reconnection?(console.warn(r+"maximum reconnection attempts for WebSocket "+this.server.ws_uri),this.ua.onTransportError(this)):(console.log(r+"trying to reconnect to WebSocket "+this.server.ws_uri+" (reconnection attempt "+this.reconnection_attempts+")"),this.reconnectTimer=e.setTimeout(function(){t.connect(),t.reconnectTimer=null},this.ua.configuration.ws_server_reconnection_timeout*1e3))}},n.C=i,t.Transport=n}(t),function(e){function r(e,t){var n=t,r=0,i=0;if(e.substring(n,n+2).match(/(^\r\n)/))return-2;while(r===0){i=e.indexOf("\r\n",n);if(i===-1)return i;!e.substring(i+2,i+4).match(/(^\r\n)/)&&e.charAt(i+2).match(/(^\s+)/)?n=i+2:r=i}return r}function i(t,n,r,i){var s,o,u,a=n.indexOf(":",r),f=n.substring(r,a).trim(),l=n.substring(a+1,i).trim();switch(f.toLowerCase()){case"via":case"v":t.addHeader("via",l),t.countHeader("via")===1?(u=t.parseHeader("Via"),u&&(t.via=u,t.via_branch=u.branch)):u=0;break;case"from":case"f":t.setHeader("from",l),u=t.parseHeader("from"),u&&(t.from=u,t.from_tag=u.getParam("tag"));break;case"to":case"t":t.setHeader("to",l),u=t.parseHeader("to"),u&&(t.to=u,t.to_tag=u.getParam("tag"));break;case"record-route":u=e.Grammar.parse(l,"Record_Route"),u===-1&&(u=undefined);for(o in u)s=u[o],t.addHeader("record-route",l.substring(s.possition,s.offset)),t.headers["Record-Route"][t.countHeader("record-route")-1].parsed=s.parsed;break;case"call-id":case"i":t.setHeader("call-id",l),u=t.parseHeader("call-id"),u&&(t.call_id=l);break;case"contact":case"m":u=e.Grammar.parse(l,"Contact"),u===-1&&(u=undefined);for(o in u)s=u[o],t.addHeader("contact",l.substring(s.possition,s.offset)),t.headers.Contact[t.countHeader("contact")-1].parsed=s.parsed;break;case"content-length":case"l":t.setHeader("content-length",l),u=t.parseHeader("content-length");break;case"content-type":case"c":t.setHeader("content-type",l),u=t.parseHeader("content-type");break;case"cseq":t.setHeader("cseq",l),u=t.parseHeader("cseq"),u&&(t.cseq=u.value),t instanceof e.IncomingResponse&&(t.method=u.method);break;case"max-forwards":t.setHeader("max-forwards",l),u=t.parseHeader("max-forwards");break;case"www-authenticate":t.setHeader("www-authenticate",l),u=t.parseHeader("www-authenticate");break;case"proxy-authenticate":t.setHeader("proxy-authenticate",l),u=t.parseHeader("proxy-authenticate");break;case"session-expires":case"x":t.setHeader("session-expires",l),u=t.parseHeader("session-expires");break;case"min-se":t.setHeader("min-se",l),u=t.parseHeader("min-se");break;case"supported":case"k":t.setHeader("supported",l),u=t.parseHeader("supported");break;case"require":t.setHeader("require",l),u=t.parseHeader("require");break;case"allow":t.setHeader("allow",l),u=t.parseHeader("allow");break;case"refer-to":case"r":t.setHeader("refer-to",l),u=t.parseHeader("refer-to");break;case"target-dialog":t.setHeader("target-dialog",l),u=t.parseHeader("target-dialog");break;case"event":case"o":t.setHeader("event",l),u=t.parseHeader("event");break;case"subscription-state":t.setHeader("subscription-state",l),u=t.parseHeader("subscription-state");break;default:t.setHeader(f,l),u=0}return u===undefined?!1:!0}var t,n=e.name+" | "+"PARSER"+" | ";t={},t.parseMessage=function(t,s){var o,u,a,f,l,c=0,h=t.indexOf("\r\n");if(h===-1){console.warn(n+"no CRLF found, not a SIP message, discarded");return}u=t.substring(0,h),l=e.Grammar.parse(u,"Request_Response");if(l===-1){console.warn(n+'error parsing first line of SIP message: "'+u+'"');return}l.status_code?(o=new e.IncomingResponse,o.status_code=l.status_code,o.reason_phrase=l.reason_phrase):(o=new e.IncomingRequest,o.method=l.method,o.ruri=l.uri),o.data=t,c=h+2;while(c<t.length){h=r(t,c);if(h===-2){f=c+2;break}if(h===-1){if(s)break;console.warn(n+"error parsing message: no empty line terminating headers");return}l=i(o,t,c,h);if(!l){console.warn(n+'error parsing header: "'+t.substring(c,h)+'"');return}c=h+2}return f&&(o.hasHeader("content-length")?(a=o.getHeader("content-length"),o.body=t.substr(f,a)):o.body=t.substring(f)),o},e.Parser=t}(t),function(e){var t,n,r,i,s=e.name+" | "+"SIP MESSAGE"+" | ";t=function(t,n,r,i,s,o){var u,a,f,l,c;i=i||{};if(!t||!n||!r)return null;this.headers={},this.method=t,this.ruri=n,this.body=o,this.extraHeaders=s||[],i.route_set?this.setHeader("route",i.route_set):r.configuration.use_preloaded_route&&this.setHeader("route",r.transport.server.sip_uri),this.setHeader("via",""),this.setHeader("max-forwards",e.UA.C.MAX_FORWARDS),u=i.to_display_name||i.to_display_name===0?'"'+i.to_display_name+'" ':"",u+="<"+(i.to_uri||n)+">",u+=i.to_tag?";tag="+i.to_tag:"",this.to=new e.NameAddrHeader.parse(u),this.setHeader("to",u),i.from_display_name||i.from_display_name===0?a='"'+i.from_display_name+'" ':r.configuration.display_name?a='"'+r.configuration.display_name+'" ':a="",a+="<"+(i.from_uri||r.configuration.uri)+">;tag=",a+=i.from_tag||e.Utils.newTag(),this.from=new e.NameAddrHeader.parse(a),this.setHeader("from",a),f=i.call_id||r.configuration.jssip_id+e.Utils.createRandomToken(15),this.call_id=f,this.setHeader("call-id",f),l=i.cseq||Math.floor(Math.random()*1e4),this.cseq=l,this.setHeader("cseq",l+" "+t),t!==e.C.CANCEL&&t!==e.C.ACK&&this.setHeader("allow",e.Utils.getAllowedMethods(r)),t!==e.C.ACK&&(c=e.Utils.getSupportedExtensions(r,i.extra_supported),this.setHeader("supported",c.join(",")))},t.prototype={setHeader:function(t,n){this.headers[e.Utils.headerize(t)]=n instanceof Array?n:[n]},toString:function(){var t="",n,r,i;t+=this.method+" "+this.ruri+" SIP/2.0\r\n";for(n in this.headers)for(i in this.headers[n])t+=n+": "+this.headers[n][i]+"\r\n";r=this.extraHeaders.length;for(i=0;i<r;i++)t+=this.extraHeaders[i]+"\r\n";return t+="User-Agent: "+e.C.USER_AGENT+"\r\n",this.body?(r=e.Utils.str_utf8_length(this.body),t+="Content-Length: "+r+"\r\n\r\n",t+=this.body):t+="Content-Length: 0\r\n\r\n",t}},n=function(){this.data=null,this.headers=null,this.method=null,this.via=null,this.via_branch=null,this.call_id=null,this.cseq=null,this.from=null,this.from_tag=null,this.to=null,this.to_tag=null,this.body=null},n.prototype={addHeader:function(t,n){var r={raw:n};t=e.Utils.headerize(t),this.headers[t]?this.headers[t].push(r):this.headers[t]=[r]},countHeader:function(t){var n=this.headers[e.Utils.headerize(t)];return n?n.length:0},getHeader:function(t,n){var r=this.headers[e.Utils.headerize(t)];n=n||0;if(!r)return;if(r[n])return r[n].raw},getHeaderAll:function(t){var n,r=this.headers[e.Utils.headerize(t)],i=[];if(!r)return[];for(n in r)i.push(r[n].raw);return i},hasHeader:function(t){return this.headers[e.Utils.headerize(t)]?!0:!1},parseHeader:function(t,n){var r,i,o;t=e.Utils.headerize(t),n=n||0;if(!this.headers[t]){console.log(s+'header "'+t+'" not present');return}if(n>=this.headers[t].length){console.log(s+'not so many "'+t+'" headers present');return}r=this.headers[t][n],i=r.raw;if(r.parsed)return r.parsed;o=e.Grammar.parse(i,t.replace(/-/g,"_"));if(o===-1){this.headers[t].splice(n,1),console.warn(s+'error parsing "'+t+'" header field with value "'+i+'"');return}return r.parsed=o,o},s:function(e,t){return this.parseHeader(e,t)},setHeader:function(t,n){var r={raw:n};this.headers[e.Utils.headerize(t)]=[r]},toString:function(){return this.data}},r=function(){this.headers={},this.ruri=null,this.transport=null,this.server_transaction=null},r.prototype=new n,r.prototype.reply=function(t,n,r,i,s,o){var u,a,f,l,c,h=this.getHeader("To"),p=0,d=0;t=t||null,n=n||null;if(!t||t<100||t>699)throw new TypeError("Invalid status_code: "+t);if(!(!n||typeof n=="string"||n instanceof String))throw new TypeError("Invalid reason_phrase: "+n);n=n||e.C.REASON_PHRASE[t]||"",r=r||[],c="SIP/2.0 "+t+" "+n+"\r\n";switch(this.method){case e.C.INVITE:case e.C.REFER:case e.C.SUBSCRIBE:case e.C.NOTIFY:if(t>100&&t<=200){u=this.countHeader("record-route");for(p;p<u;p++)c+="Record-Route: "+this.getHeader("record-route",p)+"\r\n"}}a=this.countHeader("via");for(d;d<a;d++)c+="Via: "+this.getHeader("via",d)+"\r\n";this.to_tag&&!this.s("to").hasParam("tag")&&(h+=";tag="+this.to_tag),c+="To: "+h+"\r\n",c+="From: "+this.getHeader("From")+"\r\n",c+="Call-ID: "+this.call_id+"\r\n",c+="CSeq: "+this.cseq+" "+this.method+"\r\n",f=r.length;for(l=0;l<f;l++)c+=r[l]+"\r\n";c+="User-Agent: "+e.C.USER_AGENT+"\r\n",i?(f=e.Utils.str_utf8_length(i),c+="Content-Type: application/sdp\r\n",c+="Content-Length: "+f+"\r\n\r\n",c+=i):c+="Content-Length: 0\r\n\r\n",this.server_transaction.receiveResponse(t,c,s,o)},r.prototype.reply_sl=function(t,n){var r,i,s=this.countHeader("via");t=t||null,n=n||null;if(!t||t<100||t>699)throw new TypeError("Invalid status_code: "+t);if(!(!n||typeof n=="string"||n instanceof String))throw new TypeError("Invalid reason_phrase: "+n);n=n||e.C.REASON_PHRASE[t]||"",i="SIP/2.0 "+t+" "+n+"\r\n";for(var o=0;o<s;o++)i+="Via: "+this.getHeader("via",o)+"\r\n";r=this.getHeader("To"),this.to_tag&&!this.s("to").hasParam("tag")&&(r+=";tag="+this.to_tag),i+="To: "+r+"\r\n",i+="From: "+this.getHeader("From")+"\r\n",i+="Call-ID: "+this.call_id+"\r\n",i+="CSeq: "+this.cseq+" "+this.method+"\r\n",i+="User-Agent: "+e.C.USER_AGENT+"\r\n",i+="Content-Length: 0\r\n\r\n",this.transport.send(i)},i=function(){this.headers={},this.status_code=null,this.reason_phrase=null},i.prototype=new n,e.OutgoingRequest=t,e.IncomingRequest=r,e.IncomingResponse=i}(t),function(t){var n;n=function(e,n,r,i,s,o){var u,a;if(!r)throw new TypeError('missing or invalid "host" parameter');e=e||t.C.SIP,this.parameters={},this.headers={};for(u in s)this.setParam(u,s[u]);for(a in o)this.setHeader(a,o[a]);Object.defineProperties(this,{scheme:{get:function(){return e},set:function(t){e=t.toLowerCase()}},user:{get:function(){return n},set:function(e){n=e}},host:{get:function(){return r},set:function(e){r=e.toLowerCase()}},port:{get:function(){return i},set:function(e){i=e===0?e:parseInt(e,10)||null}}})},n.prototype={setParam:function(e,t){e&&(this.parameters[e.toLowerCase()]=typeof t=="undefined"||t===null?null:t.toString().toLowerCase())},getParam:function(e){if(e)return this.parameters[e.toLowerCase()]},hasParam:function(e){if(e)return this.parameters.hasOwnProperty(e.toLowerCase())&&!0||!1},deleteParam:function(e){var t;e=e.toLowerCase();if(this.parameters.hasOwnProperty(e))return t=this.parameters[e],delete this.parameters[e],t},clearParams:function(){this.parameters={}},setHeader:function(e,n){this.headers[t.Utils.headerize(e)]=n instanceof Array?n:[n]},getHeader:function(e){if(e)return this.headers[t.Utils.headerize(e)]},hasHeader:function(e){if(e)return this.headers.hasOwnProperty(t.Utils.headerize(e))&&!0||!1},deleteHeader:function(e){var n;e=t.Utils.headerize(e);if(this.headers.hasOwnProperty(e))return n=this.headers[e],delete this.headers[e],n},clearHeaders:function(){this.headers={}},clone:function(){return new n(this.scheme,this.user,this.host,this.port,e.JSON.parse(e.JSON.stringify(this.parameters)),e.JSON.parse(e.JSON.stringify(this.headers)))},toString:function(){var e,n,r,i,s=[];i=this.scheme+":",this.user&&(i+=t.Utils.escapeUser(this.user)+"@"),i+=this.host;if(this.port||this.port===0)i+=":"+this.port;for(n in this.parameters)i+=";"+n,this.parameters[n]!==null&&(i+="="+this.parameters[n]);for(e in this.headers)for(r in this.headers[e])s.push(e+"="+this.headers[e][r]);return s.length>0&&(i+="?"+s.join("&")),i},toAor:function(e){var n;return n=this.scheme+":",this.user&&(n+=t.Utils.escapeUser(this.user)+"@"),n+=this.host,e&&(this.port||this.port===0)&&(n+=":"+this.port),n}},n.parse=function(e){return e=t.Grammar.parse(e,"SIP_URI"),e!==-1?e:undefined},t.URI=n}(t),function(t){var n;n=function(e,n,r){var i;if(!e||!(e instanceof t.URI))throw new TypeError('missing or invalid "uri" parameter');this.uri=e,this.parameters={};for(i in r)this.setParam(i,r[i]);Object.defineProperties(this,{display_name:{get:function(){return n},set:function(e){n=e===0?"0":e}}})},n.prototype={setParam:function(e,t){e&&(this.parameters[e.toLowerCase()]=typeof t=="undefined"||t===null?null:t.toString())},getParam:function(e){if(e)return this.parameters[e.toLowerCase()]},hasParam:function(e){if(e)return this.parameters.hasOwnProperty(e.toLowerCase())&&!0||!1},deleteParam:function(e){var t;e=e.toLowerCase();if(this.parameters.hasOwnProperty(e))return t=this.parameters[e],delete this.parameters[e],t},clearParams:function(){this.parameters={}},clone:function(){return new n(this.uri.clone(),this.display_name,e.JSON.parse(e.JSON.stringify(this.parameters)))},toString:function(){var e,t;e=this.display_name||this.display_name===0?'"'+this.display_name+'" ':"",e+="<"+this.uri.toString()+">";for(t in this.parameters)e+=";"+t,this.parameters[t]!==null&&(e+="="+this.parameters[t]);return e}},n.parse=function(e){return e=t.Grammar.parse(e,"Name_Addr_Header"),e!==-1?e:undefined},t.NameAddrHeader=n}(t),function(t){var n,r=t.name+" | "+"TRANSACTION"+" | ",i={STATUS_TRYING:1,STATUS_PROCEEDING:2,STATUS_CALLING:3,STATUS_ACCEPTED:4,STATUS_COMPLETED:5,STATUS_TERMINATED:6,STATUS_CONFIRMED:7};n={};var s=function(){this.init=function(e,t,n){var r;this.transport=n,this.id="z9hG4bK"+Math.floor(Math.random()*1e7),this.request_sender=e,this.request=t,r="SIP/2.0/"+(e.ua.configuration.hack_via_tcp?"TCP":n.server.scheme),r+=" "+e.ua.configuration.via_host+";branch="+this.id,this.request.setHeader("via",r)}},o=function(){this.send=function(){var n=this;this.state=i.STATUS_TRYING,this.F=e.setTimeout(function(){n.timer_F()},t.Timers.TIMER_F),this.transport.send(this.request)||this.onTransportError()},this.onTransportError=function(){console.log(r+"transport error occurred, deleting non-INVITE client transaction "+this.id),e.clearTimeout(this.F),e.clearTimeout(this.K),delete this.request_sender.ua.transactions.nict[this.id];switch(this.state){case i.STATUS_COMPLETED:case i.STATUS_TERMINATED:return}this.request_sender.onTransportError()},this.timer_F=function(){console.log(r+"Timer F expired for non-INVITE client transaction "+this.id),this.state=i.STATUS_TERMINATED,this.request_sender.onRequestTimeout(),delete this.request_sender.ua.transactions.nict[this.id]},this.timer_K=function(){this.state=i.STATUS_TERMINATED,delete this.request_sender.ua.transactions.nict[this.id]},this.receiveResponse=function(n){var r=this,s=n.status_code;if(s<200)switch(this.state){case i.STATUS_TRYING:case i.STATUS_PROCEEDING:this.state=i.STATUS_PROCEEDING,this.request_sender.receiveResponse(n)}else switch(this.state){case i.STATUS_TRYING:case i.STATUS_PROCEEDING:this.state=i.STATUS_COMPLETED,e.clearTimeout(this.F),s===408?this.request_sender.onRequestTimeout():this.request_sender.receiveResponse(n),this.K=e.setTimeout(function(){r.timer_K()},t.Timers.TIMER_K);break;case i.STATUS_COMPLETED:}}};o.prototype=new s;var u=function(){this.send=function(){var n=this;this.state=i.STATUS_CALLING,this.B=e.setTimeout(function(){n.timer_B()},t.Timers.TIMER_B),this.transport.send(this.request)||this.onTransportError()},this.onTransportError=function(){console.log(r+"transport error occurred, deleting INVITE client transaction "+this.id),e.clearTimeout(this.B),e.clearTimeout(this.D),e.clearTimeout(this.M),delete this.request_sender.ua.transactions.ict[this.id];switch(this.state){case i.STATUS_ACCEPTED:case i.STATUS_COMPLETED:case i.STATUS_TERMINATED:return}this.request_sender.onTransportError()},this.timer_M=function(){console.log(r+"Timer M expired for INVITE client transaction "+this.id),this.state===i.STATUS_ACCEPTED&&(this.state=i.STATUS_TERMINATED,e.clearTimeout(this.B),delete this.request_sender.ua.transactions.ict[this.id])},this.timer_B=function(){console.log(r+"Timer B expired for INVITE client transaction "+this.id),this.state===i.STATUS_CALLING&&(this.state=i.STATUS_TERMINATED,this.request_sender.onRequestTimeout(),delete this.request_sender.ua.transactions.ict[this.id])},this.timer_D=function(){console.log(r+"Timer D expired for INVITE client transaction "+this.id),this.state=i.STATUS_TERMINATED,e.clearTimeout(this.B),delete this.request_sender.ua.transactions.ict[this.id]},this.sendACK=function(n){var r=this;this.ack="ACK "+this.request.ruri+" SIP/2.0\r\n",this.ack+="Via: "+this.request.headers.Via.toString()+"\r\n",this.request.headers.Route&&(this.ack+="Route: "+this.request.headers.Route.toString()+"\r\n"),this.ack+="To: "+n.getHeader("to")+"\r\n",this.ack+="From: "+this.request.headers.From.toString()+"\r\n",this.ack+="Call-ID: "+this.request.headers["Call-ID"].toString()+"\r\n",this.ack+="CSeq: "+this.request.headers.CSeq.toString().split(" ")[0],this.ack+=" ACK\r\n\r\n",this.D=e.setTimeout(function(){r.timer_D()},t.Timers.TIMER_D),this.transport.send(this.ack)},this.cancel_request=function(e,n){var r=e.request;this.cancel=t.C.CANCEL+" "+r.ruri+" SIP/2.0\r\n",this.cancel+="Via: "+r.headers.Via.toString()+"\r\n",this.request.headers.Route&&(this.cancel+="Route: "+r.headers.Route.toString()+"\r\n"),this.cancel+="To: "+r.headers.To.toString()+"\r\n",this.cancel+="From: "+r.headers.From.toString()+"\r\n",this.cancel+="Call-ID: "+r.headers["Call-ID"].toString()+"\r\n",this.cancel+="CSeq: "+r.headers.CSeq.toString().split(" ")[0]+" CANCEL\r\n",n&&(this.cancel+="Reason: "+n+"\r\n"),this.cancel+="Content-Length: 0\r\n\r\n",this.state===i.STATUS_PROCEEDING&&this.transport.send(this.cancel)},this.receiveResponse=function(n){var r=this,s=n.status_code;if(s>=100&&s<=199)switch(this.state){case i.STATUS_CALLING:this.state=i.STATUS_PROCEEDING,this.request_sender.receiveResponse(n),this.cancel&&this.transport.send(this.cancel);break;case i.STATUS_PROCEEDING:this.request_sender.receiveResponse(n)}else if(s>=200&&s<=299)switch(this.state){case i.STATUS_CALLING:case i.STATUS_PROCEEDING:this.state=i.STATUS_ACCEPTED,this.M=e.setTimeout(function(){r.timer_M()},t.Timers.TIMER_M),this.request_sender.receiveResponse(n);break;case i.STATUS_ACCEPTED:this.request_sender.receiveResponse(n)}else if(s>=300&&s<=699)switch(this.state){case i.STATUS_CALLING:case i.STATUS_PROCEEDING:this.state=i.STATUS_COMPLETED,this.sendACK(n),this.request_sender.receiveResponse(n);break;case i.STATUS_COMPLETED:this.sendACK(n)}}};u.prototype=new s;var a=function(){this.init=function(e,t){this.id=e.via_branch,this.request=e,this.transport=e.transport,this.ua=t,this.last_response="",e.server_transaction=this}},f=function(){this.timer_J=function(){console.log(r+"Timer J expired for non-INVITE server transaction "+this.id),this.state=i.STATUS_TERMINATED,delete this.ua.transactions.nist[this.id]},this.onTransportError=function(){this.transportError||(this.transportError=!0,console.log(r+"transport error occurred, deleting non-INVITE server transaction "+this.id),e.clearTimeout(this.J),delete this.ua.transactions.nist[this.id])},this.receiveResponse=function(n,r,s,o){var u=this;if(n===100)switch(this.state){case i.STATUS_TRYING:this.state=i.STATUS_PROCEEDING,this.transport.send(r)||this.onTransportError();break;case i.STATUS_PROCEEDING:this.last_response=r,this.transport.send(r)?s&&s():(this.onTransportError(),o&&o())}else if(n>=200&&n<=699)switch(this.state){case i.STATUS_TRYING:case i.STATUS_PROCEEDING:this.state=i.STATUS_COMPLETED,this.last_response=r,this.J=e.setTimeout(function(){u.timer_J()},t.Timers.TIMER_J),this.transport.send(r)?s&&s():(this.onTransportError(),o&&o());break;case i.STATUS_COMPLETED:}}};f.prototype=new a;var l=function(){this.timer_H=function(){console.log(r+"Timer H expired for INVITE server transaction "+this.id),this.state===i.STATUS_COMPLETED&&(console.warn(r+"transactions","ACK for INVITE server transaction was never received, call will be terminated"),this.state=i.STATUS_TERMINATED),delete this.ua.transactions.ist[this.id]},this.timer_I=function(){this.state=i.STATUS_TERMINATED,delete this.ua.transactions.ist[this.id]},this.timer_L=function(){console.log(r+"Timer L expired for INVITE server transaction "+this.id),this.state===i.STATUS_ACCEPTED&&(this.state=i.STATUS_TERMINATED,delete this.ua.transactions.ist[this.id])},this.onTransportError=function(){this.transportError||(this.transportError=!0,console.log(r+"transport error occurred, deleting INVITE server transaction "+this.id),e.clearInterval(this.resendProvisionalTimer),e.clearTimeout(this.L),e.clearTimeout(this.H),e.clearTimeout(this.I),delete this.ua.transactions.ist[this.id])},this.resend_provisional=function(){this.transport.send(this.last_response)||this.onTransportError()},this.receiveResponse=function(n,r,s,o){var u=this;if(n>=100&&n<=199)switch(this.state){case i.STATUS_PROCEEDING:this.transport.send(r)||this.onTransportError(),this.last_response=r}if(n>100&&n<=199)this.resendProvisionalTimer||(this.resendProvisionalTimer=e.setInterval(function(){u.resend_provisional()},t.Timers.T1*60));else if(n>=200&&n<=299)switch(this.state){case i.STATUS_PROCEEDING:this.state=i.STATUS_ACCEPTED,this.last_response=r,this.L=e.setTimeout(function(){u.timer_L()},t.Timers.TIMER_L),e.clearInterval(this.resendProvisionalTimer);case i.STATUS_ACCEPTED:this.transport.send(r)?s&&s():(this.onTransportError(),o&&o())}else if(n>=300&&n<=699)switch(this.state){case i.STATUS_PROCEEDING:e.clearInterval(this.resendProvisionalTimer),this.transport.send(r)?(this.state=i.STATUS_COMPLETED,this.H=e.setTimeout(function(){u.timer_H()},t.Timers.TIMER_H),s&&s()):(this.onTransportError(),o&&o())}}};l.prototype=new a,n.NonInviteClientTransaction=function(e,t,n){this.init(e,t,n),this.request_sender.ua.transactions.nict[this.id]=this},n.NonInviteClientTransaction.prototype=new o,n.InviteClientTransaction=function(e,t,n){var r=this;this.init(e,t,n),this.request_sender.ua.transactions.ict[this.id]=this,this.request.cancel=function(e){r.cancel_request(r,e)}},n.InviteClientTransaction.prototype=new u,n.AckClientTransaction=function(e,t,n){this.init(e,t,n),this.send=function(){this.transport.send(t)}},n.AckClientTransaction.prototype=new o,n.NonInviteServerTransaction=function(e,t){this.init(e,t),this.state=i.STATUS_TRYING,t.transactions.nist[this.id]=this},n.NonInviteServerTransaction.prototype=new f,n.InviteServerTransaction=function(e,t){this.init(e,t),this.state=i.STATUS_PROCEEDING,t.transactions.ist[this.id]=this,this.resendProvisionalTimer=null,e.reply(100)},n.InviteServerTransaction.prototype=new l,n.checkTransaction=function(n,r){var s;switch(r.method){case t.C.INVITE:s=n.transactions.ist[r.via_branch];if(s){switch(s.state){case i.STATUS_PROCEEDING:s.transport.send(s.last_response);break;case i.STATUS_ACCEPTED:}return!0}break;case t.C.ACK:s=n.transactions.ist[r.via_branch];if(!s)return!1;if(s.state===i.STATUS_ACCEPTED)return!1;if(s.state===i.STATUS_COMPLETED)return s.state=i.STATUS_CONFIRMED,s.I=e.setTimeout(function(){s.timer_I()},t.Timers.TIMER_I),!0;break;case t.C.CANCEL:return s=n.transactions.ist[r.via_branch],s?s.state===i.STATUS_PROCEEDING?!1:(r.reply_sl(481),!0):(r.reply_sl(481),!0);default:s=n.transactions.nist[r.via_branch];if(s){switch(s.state){case i.STATUS_TRYING:break;case i.STATUS_PROCEEDING:case i.STATUS_COMPLETED:s.transport.send(s.last_response)}return!0}}},n.C=i,t.Transactions=n}(t),function(t){var n,r,i=t.name+" | "+"DIALOG"+" | ",s={STATUS_EARLY:1,STATUS_CONFIRMED:2,DEFAULT_MIN_SE:90};n=function(e,t,n){this.call_id=e,this.local_tag=t,this.remote_tag=n},n.prototype.toString=function(){return this.call_id+this.local_tag+this.remote_tag},n.prototype.toTargetDialogHeader=function(){return this.call_id+";remote-tag="+this.local_tag+";local-tag="+this.remote_tag},r=function(e,r,o,u){var a;if(!r.hasHeader("contact"))return console.error(i+"unable to create a Dialog without Contact header field"),!1;r instanceof t.IncomingResponse?u=r.status_code<200?s.STATUS_EARLY:s.STATUS_CONFIRMED:(u=u||s.STATUS_CONFIRMED,r.method===t.C.INVITE&&(this.last_invite_tx=r.server_transaction)),a=r.parseHeader("contact"),o==="UAS"?(this.id=new n(r.call_id,r.to_tag,r.from_tag),this.state=u,this.remote_seqnum=r.cseq,this.local_uri=r.parseHeader("to").uri,this.remote_uri=r.parseHeader("from").uri,this.remote_target=a.uri,this.route_set=r.getHeaderAll("record-route")):o==="UAC"&&(this.id=new n(r.call_id,r.from_tag,r.to_tag),this.state=u,this.local_seqnum=r.cseq,this.local_uri=r.parseHeader("from").uri,this.remote_uri=r.parseHeader("to").uri,this.remote_target=a.uri,this.route_set=r.getHeaderAll("record-route").reverse()),this.session_timer={localRefresher:!0,interval:null,min_interval:s.DEFAULT_MIN_SE,timer_id:null},this.owner=e,e.ua.dialogs[this.id.toString()]=this,console.log(i+"new "+o+" dialog created with status "+(this.state===s.STATUS_EARLY?"EARLY":"CONFIRMED"))},r.prototype={update:function(e,t){this.state=s.STATUS_CONFIRMED,console.log(i+"dialog "+this.id.toString()+"  changed to CONFIRMED state"),t==="UAC"&&(this.route_set=e.getHeaderAll("record-route").reverse())},isConfirmed:function(){return this.state===s.STATUS_CONFIRMED},terminate:function(){console.log(i+"dialog "+this.id.toString()+" deleted"),this.clearSessionRefreshTimer(),delete this.owner.ua.dialogs[this.id.toString()]},createRequest:function(e,n){var r,i,o=null;n=n||[],this.local_seqnum||(this.local_seqnum=Math.floor(Math.random()*1e4)),r=e===t.C.CANCEL||e===t.C.ACK?this.local_seqnum:this.local_seqnum+=1;if(e===t.C.INVITE||e===t.C.UPDATE){var u=this.session_timer.min_interval,a=this.session_timer.interval;u>s.DEFAULT_MIN_SE&&n.push("Min-SE: "+u);if(a!==null){var f=u>a?u:a,l=this.session_timer.localRefresher?"uac":"uas";n.push("Session-Expires: "+f+";refresher="+l)}}return this.owner instanceof t.RTCSession&&(o=t.Utils.getSessionExtensions(this.owner,e)),i=new t.OutgoingRequest(e,this.remote_target,this.owner.ua,{cseq:r,call_id:this.id.call_id,from_uri:this.local_uri,from_tag:this.id.local_tag,to_uri:this.remote_uri,to_tag:this.id.remote_tag,route_set:this.route_set,extra_supported:o},n),i.dialog=this,i},checkInDialogRequest:function(e){var n;if(!this.remote_seqnum)this.remote_seqnum=e.cseq;else{if(e.cseq<this.remote_seqnum)return e.method!==t.C.ACK&&e.reply(500),!1;e.cseq>this.remote_seqnum&&(this.remote_seqnum=e.cseq)}switch(e.method){case t.C.INVITE:if(this.last_invite_tx&&this.last_invite_tx.state===t.Transactions.C.STATUS_PROCEEDING)return n=(Math.random()*10|0)+1,e.reply(500,null,["Retry-After:"+n]),!1;this.last_invite_tx=e.server_transaction;break;case t.C.UPDATE:if(this.last_update_tx)switch(this.last_update_tx.state){case t.Transactions.C.STATUS_TRYING:case t.Transactions.C.STATUS_PROCEEDING:return n=(Math.random()*10|0)+1,e.reply(500,null,["Retry-After:"+n]),!1;default:}this.last_update_tx=e.server_transaction}return!0},receiveRequest:function(e){if(!this.checkInDialogRequest(e))return;if(!this.owner.receiveRequest(e))return;switch(e.method){case t.C.INVITE:case t.C.UPDATE:case t.C.NOTIFY:e.hasHeader("contact")&&(this.remote_target=e.parseHeader("contact").uri)}},updateMinSessionExpires:function(e){e>this.session_timer.min_interval&&(this.session_timer.min_interval=e)},setSessionRefreshTimer:function(){var n=this.session_timer.localRefresher,r=this.session_timer.interval,i,s,o=this;n?(i=r/2,s=function(){o.session_timer.timer_id=null,o.owner.emit("refresh",o.owner,{})}):(i=r-Math.max(r/3,32),s=function(){o.session_timer.timer_id=null,o.owner.sendBye({status_code:408,reason_phrase:t.C.causes.SESSION_TIMER}),o.owner.ended("system",null,t.C.causes.SESSION_TIMER)}),this.session_timer.timer_id=e.setTimeout(s,i*1e3)},clearSessionRefreshTimer:function(){this.session_timer.timer_id!==null&&(e.clearTimeout(this.session_timer.timer_id),this.session_timer.timer_id=null)},disableSessionRefresh:function(){this.session_timer.interval=null,this.clearSessionRefreshTimer()},processSessionTimerHeaders:function(e){e.hasHeader("min-se")&&this.updateMinSessionExpires(e.parseHeader("min-se"));if(!e.hasHeader("session-expires")){this.disableSessionRefresh();return}this.clearSessionRefreshTimer();var n=e.parseHeader("session-expires"),r=!0;if(e instanceof t.IncomingRequest)n.params&&n.params.refresher&&(r=n.params.refresher==="uas");else{if(!(e instanceof t.IncomingResponse))throw new TypeError("Unexpected message type");r=n.params.refresher==="uac"}this.session_timer.interval=n.interval,this.session_timer.localRefresher=r,this.setSessionRefreshTimer()},addSessionTimerResponseHeaders:function(e){var t=this.session_timer.interval;if(t){var n=this.session_timer.localRefresher?"uas":"uac";e.push("Session-Expires: "+t+";refresher="+n)}}},r.C=s,t.DialogId=n,t.Dialog=r}(t),function(e){var t,n=e.name+" | "+"REQUEST SENDER"+" | ";t=function(t,n){this.ua=n,this.applicant=t,this.method=t.request.method,this.request=t.request,this.credentials=null,this.challenged=!1,this.staled=!1,n.status===e.UA.C.STATUS_USER_CLOSED&&(this.method!==e.C.BYE||this.method!==e.C.ACK)&&this.onTransportError()},t.prototype={send:function(){switch(this.method){case"INVITE":this.clientTransaction=new e.Transactions.InviteClientTransaction(this,this.request,this.ua.transport);break;case"ACK":this.clientTransaction=new e.Transactions.AckClientTransaction(this,this.request,this.ua.transport);break;default:this.clientTransaction=new e.Transactions.NonInviteClientTransaction(this,this.request,this.ua.transport)}this.clientTransaction.send()},onRequestTimeout:function(){this.applicant.onRequestTimeout()},onTransportError:function(){this.applicant.onTransportError()},receiveResponse:function(t){var r,i,s,o=t.status_code;if(o!==401&&o!==407||this.ua.configuration.password===null)this.applicant.receiveResponse(t);else{t.status_code===401?(i=t.parseHeader("www-authenticate"),s="authorization"):(i=t.parseHeader("proxy-authenticate"),s="proxy-authorization");if(!i){console.warn(n+t.status_code+" with wrong or missing challenge, cannot authenticate"),this.applicant.receiveResponse(t);return}if(!this.challenged||!this.staled&&i.stale===!0){this.credentials||(this.credentials=new e.DigestAuthentication(this.ua));if(!this.credentials.authenticate(this.request,i)){this.applicant.receiveResponse(t);return}this.challenged=!0,i.stale&&(this.staled=!0),t.method===e.C.REGISTER?r=this.applicant.cseq+=1:this.request.dialog?r=this.request.dialog.local_seqnum+=1:(r=this.request.cseq+1,this.request.cseq=r),this.request.setHeader("cseq",r+" "+this.method),this.request.setHeader(s,this.credentials.toString()),this.send()}else this.applicant.receiveResponse(t)}}},e.RequestSender=t}(t),function(e){var t;t=function(e){this.applicant=e,this.request=e.request},t.prototype={send:function(){var t=new e.RequestSender(this,this.applicant.session.ua);t.send()},onRequestTimeout:function(){this.applicant.session.onRequestTimeout(),this.applicant.onRequestTimeout()},onTransportError:function(){this.applicant.session.onTransportError(),this.applicant.onTransportError()},receiveResponse:function(t){if(t.status_code===408||t.status_code===481)this.request.method!==e.C.BYE&&this.applicant.session.sendBye({status_code:t.status_code,reason_phrase:t.reason_phrase}),this.applicant.session.ended("remote",t,e.C.causes.DIALOG_ERROR);this.applicant.receiveResponse(t)}},e.InDialogRequestSender=t}(t),function(t){var n,r=t.name+" | "+"REGISTRATOR"+" | ";n=function(e,n){var r=1;this.ua=e,this.transport=n,this.registrar=e.configuration.registrar_server,this.expires=e.configuration.register_expires,this.call_id=t.Utils.createRandomToken(22),this.cseq=80,this.to_uri=e.configuration.uri,this.registrationTimer=null,this.registered=this.registered_before=!1,this.ua.registrator=this,this.contact=this.ua.contact.toString(),r&&(this.contact+=";reg-id="+r,this.contact+=';+sip.instance="<urn:'+this.ua.configuration.instance_id+'>"')},n.prototype={register:function(n){var i,s,o,u=this;n=n||{},o=n.extraHeaders||[],o.push("Contact: "+this.contact+";expires="+this.expires),this.request=new t.OutgoingRequest(t.C.REGISTER,this.registrar,this.ua,{to_uri:this.to_uri,call_id:this.call_id,cseq:this.cseq+=1},o),i=new t.RequestSender(this,this.ua),this.receiveResponse=function(n){var i,o,a=n.countHeader("contact");if(n.cseq!==this.cseq)return;switch(!0){case/^1[0-9]{2}$/.test(n.status_code):break;case/^2[0-9]{2}$/.test(n.status_code):n.hasHeader("expires")&&(o=n.getHeader("expires"));if(!a){console.warn(r+"no Contact header in response to REGISTER, response ignored");break}while(a--){i=n.parseHeader("contact",a);if(i.uri.user===this.ua.contact.uri.user){o=i.getParam("expires");break}i=null}if(!i){console.warn(r+"no Contact header pointing to us, response ignored");break}o||(o=this.expires),this.registrationTimer=e.setTimeout(function(){u.register()},o*1e3-3e3),i.hasParam("temp-gruu")&&(this.ua.contact.temp_gruu=i.getParam("temp-gruu").replace(/"/g,"")),i.hasParam("pub-gruu")&&(this.ua.contact.pub_gruu=i.getParam("pub-gruu").replace(/"/g,"")),this.registered=!0,this.ua.emit("registered",this.ua,{response:n});break;case/^423$/.test(n.status_code):n.hasHeader("min-expires")?(this.expires=n.getHeader("min-expires"),this.registrationTimer=e.setTimeout(function(){u.register()},0)):(console.warn(r+"423 response received for REGISTER without Min-Expires"),this.registrationFailure(n,t.C.causes.SIP_FAILURE_CODE));break;default:s=t.Utils.sipErrorCause(n.status_code),this.registrationFailure(n,s)}},this.onRequestTimeout=function(){this.registrationFailure(null,t.C.causes.REQUEST_TIMEOUT)},this.onTransportError=function(){this.registrationFailure(null,t.C.causes.CONNECTION_ERROR)},i.send()},unregister:function(n){var i;if(!this.registered){console.warn(r+"already unregistered");return}n=n||{},i=n.extraHeaders||[],this.registered=!1,e.clearTimeout(this.registrationTimer),n.all?(i.push("Contact: *"),i.push("Expires: 0"),this.request=new t.OutgoingRequest(t.C.REGISTER,this.registrar,this.ua,{to_uri:this.to_uri,call_id:this.call_id,cseq:this.cseq+=1},i)):(i.push("Contact: "+this.contact+";expires=0"),this.request=new t.OutgoingRequest(t.C.REGISTER,this.registrar,this.ua,{to_uri:this.to_uri,call_id:this.call_id,cseq:this.cseq+=1},i));var s=new t.RequestSender(this,this.ua);this.receiveResponse=function(e){var n;switch(!0){case/^1[0-9]{2}$/.test(e.status_code):break;case/^2[0-9]{2}$/.test(e.status_code):this.unregistered(e);break;default:n=t.Utils.sipErrorCause(e.status_code),this.unregistered(e,n)}},this.onRequestTimeout=function(){this.unregistered(null,t.C.causes.REQUEST_TIMEOUT)},this.onTransportError=function(){this.unregistered(null,t.C.causes.CONNECTION_ERROR)},s.send()},registrationFailure:function(e,t){this.ua.emit("registrationFailed",this.ua,{response:e||null,cause:t}),this.registered&&(this.registered=!1,this.ua.emit("unregistered",this.ua,{response:e||null,cause:t}))},unregistered:function(e,t){this.registered=!1,this.ua.emit("unregistered",this.ua,{response:e||null,cause:t||null})},onTransportClosed:function(){this.registered_before=this.registered,e.clearTimeout(this.registrationTimer),this.registered&&(this.registered=!1,this.ua.emit("unregistered",this.ua))},onTransportConnected:function(){this.register()},close:function(){this.registered_before=this.registered,this.unregister()}},t.Registrator=n}(t),function(t){var n=function(t){var n=function(e,n){this.applicant=e,this.request=n||e.request,this.session=e instanceof t.RTCSession?e:e.session,this.reattempt=!1,this.reatemptTimer=null,this.request_sender=new t.InDialogRequestSender(this)};return n.prototype={receiveResponse:function(n){var r=this,i=n.status_code;n.method===t.C.INVITE&&i===491?this.reattempt?this.applicant.receiveResponse(n):(this.request.cseq.value=this.request.dialog.local_seqnum+=1,this.reatemptTimer=e.setTimeout(function(){r.session.status!==t.RTCSession.C.STATUS_TERMINATED&&(r.reattempt=!0,r.request_sender.send())},this.getReattemptTimeout())):this.applicant.receiveResponse(n)},send:function(){this.request_sender.send()},onRequestTimeout:function(){this.applicant.onRequestTimeout()},onTransportError:function(){this.applicant.onTransportError()},getReattemptTimeout:function(){return this.session.direction==="outgoing"?(Math.random()*1.9+2.1).toFixed(2):(Math.random()*2).toFixed(2)}},n}(t),r=function(e){var t=function(e,t){t=t||{},this.session=e,this.localMedia=null,this.peerConnection=null,this.init(t)};return t.prototype={createOffer:function(e,t){var n=this,r=!1;this.onIceCompleted=function(){r||(r=!0,e(n.peerConnection.localDescription.sdp))},this.peerConnection.createOffer(function(e){n.setLocalDescription(e,t)},function(e){console.error(f+"unable to create offer"),console.error(e),t()})},createAnswer:function(e,t){var n=this,r=!1;this.onIceCompleted=function(){r||(r=!0,e(n.peerConnection.localDescription.sdp))},this.peerConnection.createAnswer(function(e){n.setLocalDescription(e,t)},function(e){console.error(f+"unable to create answer"),console.error(e),t()})},setLocalDescription:function(e,t){this.peerConnection.setLocalDescription(e,null,function(e){console.error(f+"unable to set local description"),console.error(e),t()})},addStream:function(e,t,n,r){try{this.peerConnection.addStream(e,r)}catch(i){console.error(f+"error adding stream"),console.error(i),n();return}t()},init:function(t){var n,r,i,s,o=this,u=[];for(n in this.session.ua.configuration.stun_servers)r=this.session.ua.configuration.stun_servers[n],u.push({url:r});for(n in this.session.ua.configuration.turn_servers)r=this.session.ua.configuration.turn_servers[n],s=r.server,i=s.substr(0,s.indexOf(":")),u.push({url:i+":"+r.username+"@"+s.substr(i.length+1),credential:r.password});this.peerConnection=new e.WebRTC.RTCPeerConnection({iceServers:u},t),this.peerConnection.onaddstream=function(e){console.log(f+"stream added: "+e.stream.id)},this.peerConnection.onremovestream=function(e){console.log(f+"stream removed: "+e.stream.id)},this.peerConnection.onicecandidate=function(e){e.candidate?console.log(f+"ICE candidate received: "+e.candidate.candidate):o.onIceCompleted()},this.peerConnection.ongatheringchange=function(e){e.currentTarget.iceGatheringState==="complete"&&this.iceConnectionState!=="closed"&&o.onIceCompleted()},this.peerConnection.onicechange=function(){console.log(f+'ICE connection state changed to "'+this.iceConnectionState+'"')},this.peerConnection.onstatechange=function(){console.log(f+'PeerConnection state changed to "'+this.readyState+'"')}},close:function(){console.log(f+"closing PeerConnection"),this.peerConnection&&(this.peerConnection.close(),this.localMedia&&this.localMedia.stop())},getUserMedia:function(t,n,r){var i=this;console.log(f+"requesting access to local media"),e.WebRTC.getUserMedia(r,function(e){console.log(f+"got local media stream"),i.localMedia=e,t(e)},function(e){console.error(f+"unable to get user media"),console.error(e),n()})},onMessage:function(t,n,r,i){this.peerConnection.setRemoteDescription(new e.WebRTC.RTCSessionDescription({type:t,sdp:n}),r,i)}},t}(t),i=function(e){var t,r={MIN_DURATION:70,MAX_DURATION:6e3,DEFAULT_DURATION:100,MIN_INTER_TONE_GAP:50,DEFAULT_INTER_TONE_GAP:500};return t=function(e){var t=["succeeded","failed"];this.session=e,this.direction=null,this.tone=null,this.duration=null,this.initEvents(t)},t.prototype=new e.EventEmitter,t.prototype.send=function(t,r){var i,s,o,u;if(t===undefined)throw new TypeError("Not enough arguments");this.direction="outgoing";if(this.session.status!==e.RTCSession.C.STATUS_CONFIRMED&&this.session.status!==e.RTCSession.C.STATUS_WAITING_FOR_ACK)throw new e.Exceptions.InvalidStateError(this.session.status);r=r||{},u=r.extraHeaders?r.extraHeaders.slice():[],o=r.eventHandlers||{};if(typeof t=="string")t=t.toUpperCase();else{if(typeof t!="number")throw new TypeError("Invalid tone: "+t);t=t.toString()}if(!t.match(/^[0-9A-D#*]$/))throw new TypeError("Invalid tone: "+t);this.tone=t,this.duration=r.duration;for(s in o)this.on(s,o[s]);u.push("Content-Type: application/dtmf-relay"),this.request=this.session.dialog.createRequest(e.C.INFO,u),this.request.body="Signal= "+this.tone+"\r\n",this.request.body+="Duration= "+this.duration,i=new n(this),this.session.emit("newDTMF",this.session,{originator:"local",dtmf:this,request:this.request}),i.send()},t.prototype.receiveResponse=function(t){var n;switch(!0){case/^1[0-9]{2}$/.test(t.status_code):break;case/^2[0-9]{2}$/.test(t.status_code):this.emit("succeeded",this,{originator:"remote",response:t});break;default:n=e.Utils.sipErrorCause(t.status_code),this.emit("failed",this,{originator:"remote",response:t,cause:n})}},t.prototype.onRequestTimeout=function(){this.emit("failed",this,{originator:"system",cause:e.C.causes.REQUEST_TIMEOUT})},t.prototype.onTransportError=function(){this.emit("failed",this,{originator:"system",cause:e.C.causes.CONNECTION_ERROR})},t.prototype.init_incoming=function(e){var t,n=/^(Signal\s*?=\s*?)([0-9A-D#*]{1})(\s)?.*/,r=/^(Duration\s?=\s?)([0-9]{1,4})(\s)?.*/;this.direction="incoming",this.request=e,e.reply(200),e.body&&(t=e.body.split("\r\n"),t.length===2&&(n.test(t[0])&&(this.tone=t[0].replace(n,"$2")),r.test(t[1])&&(this.duration=parseInt(t[1].replace(r,"$2"),10)))),!this.tone||!this.duration?console.warn(f+"invalid INFO DTMF received, discarded"):this.session.emit("newDTMF",this.session,{originator:"remote",dtmf:this,request:e})},t.C=r,t}(t),s=function(t){var r,i=t.name+" | "+"REINVITE"+" | ";return r=function(e){var n=["succeeded","failed","completed"];this.session=e,this.direction=null,this.status=t.RTCSession.C.STATUS_NULL,this.timers={},this.initEvents(n)},r.prototype=new t.EventEmitter,r.prototype.send=function(e,r){var i,s,o,u;if(e===undefined)throw new TypeError("Not enough arguments");this.direction="outgoing";if(this.session.status!==t.RTCSession.C.STATUS_CONFIRMED)throw new t.Exceptions.InvalidStateError(this.session.status);r=r||{},u=r.extraHeaders?r.extraHeaders.slice():[],o=r.eventHandlers||{};for(s in o)this.on(s,o[s]);u.push("Contact: "+this.session.contact),e&&u.push("Content-Type: application/sdp"),this.request=this.session.dialog.createRequest(t.C.INVITE,u),this.request.body=e,i=new n(this),this.session.emit("reinvite",this.session,{originator:"local",reinvite:this,request:this.request}),i.send(),this.status=t.RTCSession.C.STATUS_INVITE_SENT},r.prototype.receiveResponse=function(e){var n=e.status_code,r;switch(this.status){case t.RTCSession.C.STATUS_CONFIRMED:case t.RTCSession.C.STATUS_CANCELED:this.session.status===t.RTCSession.C.STATUS_CONFIRMED&&(console.info(i+"Retransmitting ACK"),this.session.sendACK());return}if(n>=100&&n<200){this.status=t.RTCSession.C.STATUS_1XX_RECEIVED;return}n>=200&&n<300?(this.status=t.RTCSession.C.STATUS_CONFIRMED,this.session.status===t.RTCSession.C.STATUS_CONFIRMED&&(this.session.sendACK(),console.log(i+"re-INVITE ACK sent",Date.now()),this.session.dialog.processSessionTimerHeaders(e),this.emit("succeeded",this,{originator:"remote",response:e,sdp:e.body}))):(this.status=t.RTCSession.C.STATUS_CANCELED,r=t.Utils.sipErrorCause(e.status_code),this.emit("failed",this,{originator:"remote",response:e,cause:r})),this.emit("completed",this,{originator:"local"})},r.prototype.receiveAck=function(){this.status=t.RTCSession.C.STATUS_CONFIRMED,console.log(i+"re-INVITE ACK received",Date.now()),this.timers.invite2xxTimer&&(e.clearTimeout(this.timers.invite2xxTimer),delete this.timers.invite2xxTimer),this.timers.ackTimer&&(e.clearTimeout(this.timers.ackTimer),delete this.timers.ackTimer),this.emit("completed",this,{originator:"remote"})},r.prototype.onRequestTimeout=function(){this.status=t.RTCSession.C.STATUS_TERMINATED,this.emit("failed",this,{originator:"system",cause:t.C.causes.REQUEST_TIMEOUT})},r.prototype.onTransportError=function(){switch(this.status){case t.RTCSession.C.STATUS_CONFIRMED:case t.RTCSession.C.STATUS_CANCELED:case t.RTCSession.C.STATUS_TERMINATED:return}this.status=t.RTCSession.C.STATUS_TERMINATED,this.emit("failed",this,{originator:"system",cause:t.C.causes.CONNECTION_ERROR})},r.prototype.init_incoming=function(e){var n=null,r=e.getHeader("Content-Type");this.direction="incoming",this.request=e,this.status=t.RTCSession.C.STATUS_INVITE_RECEIVED,e.body&&r==="application/sdp"&&(n=e.body),this.session.emit("reinvite",this.session,{originator:"remote",reinvite:this,request:e,sdp:n})},r.prototype.successResponseSent=function(n,r,s){var o=this.session,u=1,a=t.Timers.T1;this.timers.invite2xxTimer=e.setTimeout(function f(){if(o.status!==t.RTCSession.C.STATUS_WAITING_FOR_ACK)return;console.log(i+"Retransmitting 2xx:",u++),n.reply(200,null,r,s),a<t.Timers.T2&&(a*=2,a>t.Timers.T2&&(a=t.Timers.T2)),o.timers.invite2xxTimer=e.setTimeout(f,a)},a),console.log(i+"re-INVITE response sent",Date.now()),this.timers.ackTimer=e.setTimeout(function(){o.status===t.RTCSession.C.STATUS_WAITING_FOR_ACK&&(console.log(i+"no ACK received, terminating the call"),o.timers.invite2xxTimer&&(e.clearTimeout(o.timers.invite2xxTimer),delete o.timers.invite2xxTimer),o.session.sendBye(),o.session.ended("remote",null,t.C.causes.NO_ACK))},t.Timers.TIMER_H)},r.prototype.sdpValid=function(){var n=this,r=this.request,i=null,s=n.session.ua.configuration.no_answer_timeout;if(this.direction!=="incoming")throw new TypeError('Invalid method "sdpValid" for an outgoing reINVITE');this.status=t.RTCSession.C.STATUS_WAITING_FOR_ANSWER,r.hasHeader("expires")&&(i=r.getHeader("expires")*1e3),this.timers.provisionalResponse=e.setTimeout(function(){r.reply(180,null,["Contact: "+n.session.contact]),delete n.timers.provisionalResponse},1e3),i&&i<s?this.timers.answer=e.setTimeout(function(){r.reply(487),n.emit("failed",n,{originator:"system",cause:t.C.causes.EXPIRES})},i):this.timers.answer=e.setTimeout(function(){r.reply(480),n.emit("failed",n,{originator:"local",cause:t.C.causes.NO_ANSWER})},s)},r.prototype.sdpInvalid=function(){if(this.direction!=="incoming")throw new TypeError('Invalid method "sdpInvalid" for an outgoing reINVITE');this.request.reply(488),this.status=t.RTCSession.C.STATUS_WAITING_FOR_ACK,this.emit("failed",this,{originator:"remote",cause:t.C.causes.BAD_MEDIA_DESCRIPTION})},r.prototype.accept=function(n){n=n||{};var r=this,i=this.request,s=n.extraHeaders||[],o=n.sdp;if(this.direction!=="incoming")throw new TypeError('Invalid method "accept" for an outgoing reINVITE');this.timers.provisionalResponse&&(e.clearTimeout(this.timers.provisionalResponse),delete this.timers.provisionalResponse),this.timers.answer&&(e.clearTimeout(this.timers.answer),delete this.timers.answer),this.session.dialog.processSessionTimerHeaders(i),this.session.dialog.addSessionTimerResponseHeaders(s),s.push("Contact: "+r.session.contact),s.push("Allow: "+t.Utils.getAllowedMethods(r.session.ua)),s.push("Content-Type: application/sdp");var u=function(){r.session.onTransportError(),r.onTransportError()};i.reply(200,null,s,o,this.successResponseSent.bind(this,i,s,o),u),this.status=t.RTCSession.C.STATUS_WAITING_FOR_ACK},r.prototype.reject=function(n){n=n||{};var r=n.status_code||480,i=n.reason_phrase,s=n.extraHeaders||[];if(this.direction!=="incoming")throw new TypeError('Invalid method "reject" for an outgoing reINVITE');if(r<300||r>=700)throw new TypeError("Invalid status_code: "+r);this.timers.provisionalResponse&&(e.clearTimeout(this.timers.provisionalResponse),delete this.timers.provisionalResponse),this.timers.answer&&(e.clearTimeout(this.timers.answer),delete this.timers.answer),this.request.reply(r,i,s),this.status=t.RTCSession.C.STATUS_WAITING_FOR_ACK},r.C=l,r}(t),o=function(e){var t;return t=function(e){var t=["succeeded","failed"];this.session=e,this.direction=null,this.accepted=null,this.initEvents(t)},t.prototype=new e.EventEmitter,t.prototype.send=function(t){var r,i,s,o,u;this.direction="outgoing";if(this.session.status!==e.RTCSession.C.STATUS_CONFIRMED&&this.session.status!==e.RTCSession.C.STATUS_WAITING_FOR_ACK)throw new e.Exceptions.InvalidStateError(this.session.status);t=t||{},o=t.extraHeaders?t.extraHeaders.slice():[],s=t.eventHandlers||{},u=t.sdp;for(i in s)this.on(i,s[i]);o.push("Contact: "+this.session.contact),u&&o.push("Content-Type: application/sdp"),this.request=this.session.dialog.createRequest(e.C.UPDATE,o),this.request.body=u,r=new n(this),this.session.emit("update",this.session,{originator:"local",update:this,request:this.request}),r.send()},t.prototype.receiveResponse=function(t){var n;if(this.session.status!==e.RTCSession.C.STATUS_CONFIRMED)return;switch(!0){case/^1[0-9]{2}$/.test(t.status_code):break;case/^2[0-9]{2}$/.test(t.status_code):this.session.dialog.processSessionTimerHeaders(t),this.emit("succeeded",this,{originator:"remote",response:t});break;default:n=e.Utils.sipErrorCause(t.status_code),this.emit("failed",this,{originator:"remote",response:t,cause:n})}},t.prototype.onRequestTimeout=function(){this.emit("failed",this,{originator:"system",cause:e.C.causes.REQUEST_TIMEOUT})},t.prototype.onTransportError=function(){this.emit("failed",this,{originator:"system",cause:e.C.causes.CONNECTION_ERROR})},t.prototype.init_incoming=function(e){this.direction="incoming",this.request=e,this.session.emit("update",this.session,{originator:"remote",update:this,request:e});if(this.accepted===null){var t=e.getHeader("content-type");t||e.body?this.reject({status_code:488}):this.accept()}return this.accepted},t.prototype.accept=function(e){e=e||{};var t=e.extraHeaders||[],n=e.body;if(this.direction!=="incoming")throw new TypeError('Invalid method "accept" for an outgoing update');this.session.dialog.processSessionTimerHeaders(this.request),this.session.dialog.addSessionTimerResponseHeaders(t),t.push("Contact: "+this.session.contact),this.request.reply(200,null,t,n),this.accepted=!0},t.prototype.reject=function(e){e=e||{};var t=e.status_code||480,n=e.reason_phrase,r=e.extraHeaders||[],i=e.body;if(this.direction!=="incoming")throw new TypeError('Invalid method "reject" for an outgoing update');if(t<300||t>=700)throw new TypeError("Invalid status_code: "+t);this.request.reply(t,n,r,i),this.accepted=!1},t}(t),u=function(e){var t,r=e.name+" | "+"IN-DIALOG REFER"+" | ",i=18e4;return t=function(e){var t=["accepted","failed","notify"];this.session=e,this.ua=e.ua,this.closed=!1,this.request=null,this.id=null,this.contact=e.contact,this.notify_timer=null,this.dialog=e.dialog,this.subscription_state="pending",this.subscription_expires=null,this.expire_timer=null,this.last_notify_body=null,this.accepted=!1,this.rejected=!1,this.direction=null,this.refer_uri=null,this.data={},this.initEvents(t)},t.prototype=new e.EventEmitter,t.prototype.send=function(t,i){var s,o,u,a,f,l,c=null;if(t===undefined)throw new TypeError("Not enough arguments");if(this.session.status!==e.RTCSession.C.STATUS_CONFIRMED&&this.session.status!==e.RTCSession.C.STATUS_WAITING_FOR_ACK)throw new e.Exceptions.InvalidStateError(this.session.status);i=i||{},f=i.extraHeaders||[],a=i.eventHandlers||{},u=i.contentType||"text/plain";for(o in a)this.on(o,a[o]);try{t=e.Utils.normalizeURI(t,this.ua.configuration.hostport_params)}catch(h){t=e.URI.parse(e.C.INVALID_TARGET_URI),c=e.C.causes.INVALID_REFER_TO_TARGET}this.direction="outgoing",this.refer_uri=t,l=this.dialog.createRequest(e.C.REFER,f),this.request=l,this.id=l.call_id+this.dialog.id.local_tag,l.setHeader("contact",this.contact),l.setHeader("refer-to",t),i.body&&(l.setHeader("content-type",u),l.body=i.body),s=new n(this),this.ua.emit("newRefer",this.ua,{originator:"local",refer:this,request:this.request}),c?this.emit("failed",this,{originator:"local",cause:c}):(s.send(),console.log(r+this.id+" sent"),this.notify_timer=setTimeout(this.onNotifyTimeout.bind(this),e.Timers.TIMER_F))},t.prototype.receiveResponse=function(t){var n;if(this.closed)return;switch(!0){case/^1[0-9]{2}$/.test(t.status_code):break;case/^2[0-9]{2}$/.test(t.status_code):console.log(r+this.id+" accepted"),this.emit("accepted",this,{originator:"remote",response:t});break;default:console.log(r+this.id+" rejected (early)"),this.close(),n=e.Utils.sipErrorCause(t.status_code),this.emit("failed",this,{originator:"remote",message:t,cause:n})}},t.prototype.onRequestTimeout=function(){if(this.closed)return;console.log(r+this.id+" request timeout"),this.close(),this.emit("failed",this,{originator:"system",cause:e.C.causes.REQUEST_TIMEOUT})},t.prototype.onTransportError=function(){if(this.closed)return;console.log(r+this.id+" transport error"),this.close(),this.emit("failed",this,{originator:"system",cause:e.C.causes.CONNECTION_ERROR})},t.prototype.onNotifyTimeout=function(){if(this.closed||this.subscription_state!=="pending")return;console.log(r+this.id+" notify timeout"),this.emitFinalNotify(),this.close()},t.prototype.emitFinalNotify=function(){var t,n=this.last_notify_body;n||(n=e.Parser.parseMessage("SIP/2.0 100 Trying\r\n",!0)),n.status_code<200?t="progress":n.status_code<300?t="started":t="failed",this.emit("notify",this,{originator:"system",request:null,sipFrag:n,sessionEvent:t,finalNotify:!0})},t.prototype.close=function(){this.subscription_state==="active"&&(console.warn(r+this.id+" closed with active subscription"),this.direction==="incoming"?this.notify({body:this.last_notify_body,finalNotify:!0}):this.emitFinalNotify()),this.expire_timer!==null&&(clearTimeout(this.expire_timer),this.expire_timer=null),this.notify_timer!==null&&(clearTimeout(this.notify_timer),this.notify_timer=null),this.closed=!0,console.log(r+this.id+" closed")},t.prototype.subscriptionExpired=function(){if(this.subscription_state==="terminated")return;this.notify({body:this.last_notify_body,finalNotify:!0,terminateReason:"timeout"}),this.expire_timer=null,console.log(r+this.id+" subscription expired")},t.prototype.init_incoming=function(e){return this.direction="incoming",this.request=e,this.id=e.call_id+e.from_tag,e.hasHeader("refer-to")?e.countHeader("refer-to")>1?(e.reply(400,"Too many Refer-To header fields"),!1):(this.refer_uri=e.parseHeader("refer-to").uri,console.log(r+this.id+" received"),this.ua.emit("newRefer",this.ua,{originator:"remote",refer:this,request:e,session:this.session}),!this.accepted&&!this.rejected&&this.accept(),this.accepted):(e.reply(400,"Missing Refer-To header field"),!1)},t.prototype.call=function(t){var n,r=this.refer_uri;if(r.scheme!==e.C.SIP)throw new e.Exceptions.InvalidTargetError(r);return this.accepted||this.accept(),n=new e.RTCSession(this.ua),n.connect(r,t),this.addSessionNotifyHandlers(n),n},t.prototype.addSessionNotifyHandlers=function(t){var n=this;t.on("progress",function(e){var t=e.data.response;n.notify({status_code:t.status_code,reason_phrase:t.reason_phrase})}),t.once("started",function(e){var t=e.data.response;n.notify({status_code:t.status_code,reason_phrase:t.reason_phrase}),n.close()}),t.once("failed",function(t){var r=500,i=null,s=t.data.message;s&&s instanceof e.IncomingResponse&&(r=s.status_code,i=s.reason_phrase),n.notify({status_code:r,reason_phrase:i}),n.close()})},t.prototype.accept=function(e){e=e||{};var t=e.extraHeaders||[],n=e.body;if(this.direction!=="incoming")throw new TypeError('Invalid method "accept" for an outgoing refer');if(this.closed)return;this.subscription_state="active",this.subscription_expires=Date.now()+i,this.expire_timer=setTimeout(this.subscriptionExpired.bind(this),i),t.push("Contact: "+this.contact),this.request.reply(202,null,t,n),this.notify(),this.accepted=!0,console.log(r+this.id+" accepted")},t.prototype.reject=function(e){e=e||{};var t=e.status_code||603,n=e.reason_phrase,i=e.extraHeaders||[],s=e.body;if(this.direction!=="incoming")throw new TypeError('Invalid method "reject" for an outgoing refer');if(t<300||t>=700)throw new TypeError("Invalid status_code: "+t);if(this.closed)return;this.accepted?(console.log(r+this.id+" rejected (late)"),this.notify({status_code:t,reason_phrase:n})):(console.log(r+this.id+" rejected (early)"),this.request.reply(t,n,i,s),this.rejected=!0),this.close()},t.prototype.notify=function(t){var n,i,s,o,u,a,f,l,c=this;if(this.direction!=="incoming")throw new TypeError('Invalid method "notify" for an outgoing refer');t=t||{};if(t.body&&typeof t.finalNotify=="undefined")throw new TypeError("Must specify finalNotify when providing notify body");if(this.subscription_state!=="active")return;n=t.status_code||100,i=t.reason_phrase||e.C.REASON_PHRASE[n]||"",s=t.finalNotify||n>=200,s?(o="terminated",u=t.terminateReason||"noresource",a=o+";reason="+u):(o="active",a=o+";expires="+Math.round((this.subscription_expires-Date.now())/1e3)),f=t.body||"SIP/2.0 "+n+" "+i+"\r\n",this.last_notify_body=f,l=new e.Notify(this),l.send("refer;id="+this.request.cseq,a,{extraHeaders:t.extraHeaders,eventHandlers:t.eventHandlers,content_type:"message/sipfrag",body:f}),this.subscription_state=o,s||l.on("failed",function(){c.subscription_state="terminated",console.log(r+c.id+" unsubscribed (rejected notify)"),c.close()})},t.prototype.receiveRequest=function(t){switch(t.method){case e.C.NOTIFY:return this.receiveNotify(t);case e.C.SUBSCRIBE:return this.receiveSubscribe(t)}return t.reply(405,null,["Allow: "+e.Utils.getAllowedMethods(this.ua)]),!1},t.prototype.receiveNotify=function(t){var n,i,s,o,u,a,f,l=!1;return this.direction!=="outgoing"||this.subscription_state!=="active"&&this.subscription_state!=="pending"?(t.reply(481,"Subscription Does Not Exist"),!1):(n=t.parseHeader("event"),!n||n.event!=="refer"?(t.reply(489),this.close(),!1):(i=t.parseHeader("subscription-state"),i?(s=t.getHeader("content-type"),s&&s.indexOf("message/sipfrag")<0?(t.reply(415),this.close(),!1):(f=t.body,/\r\n$/.test(f)||(f+="\r\n"),o=e.Parser.parseMessage(f,!0),!o||!o instanceof e.IncomingResponse?(t.reply(400,"Bad Message Body"),this.close(),!1):this.listeners("notify").length===0?(console.log(r+this.id+" no notify listeners; unsubscribing"),t.reply(603),this.subscription_state="terminated",this.close(),!1):(this.subscription_state=i.state,this.subscription_expires=Date.now()+i.expires*1e3,this.last_notify_body=o,this.notify_timer!==null&&(clearTimeout(this.notify_timer),this.notify_timer=null),this.expire_timer!==null&&(clearTimeout(this.expire_timer),this.expire_timer=null),a=["Contact: "+this.contact],t.reply(200,null,a),o.status_code<200?u="progress":o.status_code<300?u="started":u="failed",console.log(r+this.id+" notify: "+u),this.subscription_state==="terminated"?(l=!0,this.close()):this.expire_timer=setTimeout(this.close.bind(this),(i.expires+e.Timers.T4)*1e3),this.emit("notify",this,{originator:"remote",request:t,sipFrag:o,sessionEvent:u,finalNotify:l}),!0))):(t.reply(400,"Missing Subscription-State Header"),this.close(),!1)))},t.prototype.receiveSubscribe=function(e){var t,n,s;return this.direction!=="incoming"?(e.reply(481),!1):this.subscription_state!=="active"&&this.subscription_state!=="terminated"?(e.reply(403),!1):(t=e.parseHeader("event"),!t||t.event!=="refer"?(e.reply(489),!1):(n=e.parseHeader("expires"),n===0?(console.log(r+this.id+" unsubscribed (expires=0)"),this.notify({body:this.last_notify_body,finalNotify:!0}),s=["Contact: "+this.contact],e.reply(200,null,s),this.close(),!0):(n>0?n*=1e3:n=i,this.subscription_state="active",this.subscription_expires=Date.now()+n,this.expire_timer!==null&&clearTimeout(this.expire_timer),this.expire_timer=setTimeout(this.subscriptionExpired.bind(this),n),s=["Contact: "+this.contact,"Expires: "+n/1e3],e.reply(200,null,s),console.log(r+this.id+" subscription extended"),!0)))},t}(t),a,f=t.name+" | "+"RTC SESSION"+" | ",l={STATUS_NULL:0,STATUS_INVITE_SENT:1,STATUS_1XX_RECEIVED:2,STATUS_INVITE_RECEIVED:3,STATUS_WAITING_FOR_ANSWER:4,STATUS_WAITING_FOR_ACK:5,STATUS_CANCELED:6,STATUS_TERMINATED:7,STATUS_CONFIRMED:8};a=function(e){var t=["progress","failed","started","ended","newDTMF","reinvite","refresh","update"];this.ua=e,this.status=l.STATUS_NULL,this.lastReinvite=null,this.dialog=null,this.earlyDialogs={},this.rtcMediaHandler=null,this.tones=null,this.allowed=null,this.supported=null,this.incoming_refer=null,this.outgoing_refer=null,this.timers={ackTimer:null,expiresTimer:null,invite2xxTimer:null,userNoAnswerTimer:null},this.direction=null,this.local_identity=null,this.remote_identity=null,this.start_time=null,this.end_time=null,this.data={},this.initEvents(t)},a.prototype=new t.EventEmitter,a.prototype.terminate=function(e){e=e||{};var n,r=e.status_code,i=e.reason_phrase,s=e.extraHeaders||[],o=e.body;if(this.status===l.STATUS_TERMINATED)throw new t.Exceptions.InvalidStateError(this.status);switch(this.status){case l.STATUS_NULL:case l.STATUS_INVITE_SENT:case l.STATUS_1XX_RECEIVED:console.log(f+"canceling RTCSession");if(r&&(r<200||r>=700))throw new TypeError("Invalid status_code: "+r);r&&(i=i||t.C.REASON_PHRASE[r]||"",n="SIP ;cause="+r+' ;text="'+i+'"'),this.status===l.STATUS_NULL?(this.isCanceled=!0,this.cancelReason=n):this.status===l.STATUS_INVITE_SENT?this.received_100?this.request.cancel(n):(this.isCanceled=!0,this.cancelReason=n):this.status===l.STATUS_1XX_RECEIVED&&this.request.cancel(n),this.failed("local",null,t.C.causes.CANCELED);break;case l.STATUS_WAITING_FOR_ANSWER:console.log(f+"rejecting RTCSession"),r=r||480;if(r<300||r>=700)throw new TypeError("Invalid status_code: "+r);this.request.reply(r,i,s,o),this.failed("local",null,t.C.causes.REJECTED);break;case l.STATUS_WAITING_FOR_ACK:case l.STATUS_CONFIRMED:console.log(f+"terminating RTCSession"),this.sendBye(e),this.ended("local",null,t.C.causes.BYE)}this.close()},a.prototype.answer=function(n){n=n||{};var r=this,i=this.request,s=n.extraHeaders||[],o=n.mediaConstraints||{audio:!0,video:!0},u=n.sdp,a=function(e){r.rtcMediaHandler.addStream(e,h,p)},c=function(){i.reply(480),r.failed("local",null,t.C.causes.USER_DENIED_MEDIA_ACCESS)},h=function(){r.rtcMediaHandler.createAnswer(d,v)},p=function(){if(r.status===l.STATUS_TERMINATED)return;r.failed("local",null,t.C.causes.WEBRTC_ERROR)},d=function(n){var o,u=function(){var s=1,o=t.Timers.T1;r.status=l.STATUS_WAITING_FOR_ACK,r.timers.invite2xxTimer=e.setTimeout(function u(){if(r.status!==t.RTCSession.C.STATUS_WAITING_FOR_ACK)return;console.log(f+"Retransmitting 2xx:",s++),i.reply(200,null,["Contact: "+r.contact],n),o<t.Timers.T2&&(o*=2,o>t.Timers.T2&&(o=t.Timers.T2)),r.timers.invite2xxTimer=e.setTimeout(u,o)},o),r.timers.ackTimer=e.setTimeout(function(){r.status===l.STATUS_WAITING_FOR_ACK&&(console.log(f+"no ACK received, terminating the call"),e.clearTimeout(r.timers.invite2xxTimer),r.sendBye(),r.ended("remote",null,t.C.causes.NO_ACK))},t.Timers.TIMER_H),r.started("local")},a=function(){r.failed("system",null,t.C.causes.CONNECTION_ERROR)};s.push("Contact: "+r.contact),s.push("Allow: "+t.Utils.getAllowedMethods(r.ua)),o=t.Utils.getSupportedExtensions(r.ua,t.Utils.getSessionExtensions(r,t.C.INVITE)),s.push("Supported: "+o.join(",")),i.reply(200,null,s,n,u,a)},v=function(){if(r.status===l.STATUS_TERMINATED)return;r.failed("local",null,t.C.causes.WEBRTC_ERROR)};if(this.direction!=="incoming")throw new TypeError('Invalid method "answer" for an outgoing call');if(this.status!==l.STATUS_WAITING_FOR_ANSWER)throw new t.Exceptions.InvalidStateError(this.status);if(!this.createDialog(i,"UAS")){i.reply(500,"Missing Contact header field");return}e.clearTimeout(this.timers.userNoAnswerTimer),this.dialog.processSessionTimerHeaders(i),this.dialog.addSessionTimerResponseHeaders(s),u?d(u):this.rtcMediaHandler.getUserMedia(a,c,o)},a.prototype.sendDTMF=function(n,r){var s,o,u=0,a=this;r=r||{},s=r.duration||null,o=r.interToneGap||null;if(n===undefined)throw new TypeError("Not enough arguments");if(this.status!==l.STATUS_CONFIRMED&&this.status!==l.STATUS_WAITING_FOR_ACK)throw new t.Exceptions.InvalidStateError(this.status);if(!n||typeof n!="string"&&typeof n!="number"||!n.toString().match(/^[0-9A-D#*,]+$/i))throw new TypeError("Invalid tones: "+n);n=n.toString();if(s&&!t.Utils.isDecimal(s))throw new TypeError("Invalid tone duration: "+s);s?s<i.C.MIN_DURATION?(console.warn(f+'"duration" value is lower than the minimum allowed, setting it to '+i.C.MIN_DURATION+" milliseconds"),s=i.C.MIN_DURATION):s>i.C.MAX_DURATION?(console.warn(f+'"duration" value is greater than the maximum allowed, setting it to '+i.C.MAX_DURATION+" milliseconds"),s=i.C.MAX_DURATION):s=Math.abs(s):s=i.C.DEFAULT_DURATION,r.duration=s;if(o&&!t.Utils.isDecimal(o))throw new TypeError("Invalid interToneGap: "+o);o?o<i.C.MIN_INTER_TONE_GAP?(console.warn(f+'"interToneGap" value is lower than the minimum allowed, setting it to '+i.C.MIN_INTER_TONE_GAP+" milliseconds"),o=i.C.MIN_INTER_TONE_GAP):o=Math.abs(o):o=i.C.DEFAULT_INTER_TONE_GAP;if(this.tones){this.tones+=n;return}this.tones=n;var c=function(){var t,n,f=a.tones;if(a.status===l.STATUS_TERMINATED||!f||u>=f.length){a.tones=null;return}t=f[u],u+=1;if(t===",")n=2e3;else{var h=new i(a);h.on("failed",function(){a.tones=null}),h.send(t,r),n=s+o}e.setTimeout(c,n)};c()},a.prototype.sendReinvite=function(e){var n;e=e||{},n=e.sdp;if(this.lastReinvite)switch(this.lastReinvite.status){case l.STATUS_CONFIRMED:case l.STATUS_CANCELED:case l.STATUS_TERMINATED:break;default:throw new t.Exceptions.InvalidStateError(this.lastReinvite.status)}var r=new s(this);r.send(n,e),this.lastReinvite=r},a.prototype.sendUpdate=function(e){var t;e=e||{},t=e.sdp,t;var n=new o(this);n.send(e)},a.prototype.sendRefer=function(e,n){var r,i=this.dialog.remote_target;n=n||{},n.targetDialog=this.dialog;if(!this.isMethodAllowed(t.C.REFER,!1))throw new t.Exceptions.RemoteSupportError(t.C.REFER);if(this.isOptionSupported(t.C.SIP_EXTENSIONS.GRUU)&&i.hasParam("gr")&&this.isOptionSupported(t.C.SIP_EXTENSIONS.TARGET_DIALOG)){r=new t.Refer(this.ua),r.send(i,e,n);return}r=this.outgoing_refer;if(r&&!r.closed)throw new t.Exceptions.InvalidStateError("Refer in progress");r=new u(this),r.send(e,n),this.outgoing_refer=r},a.prototype.isMethodAllowed=function(e,t){return this.allowed?this.allowed.indexOf(e)>=0?!0:!1:t},a.prototype.isOptionSupported=function(e){return this.supported&&this.supported.indexOf(e)>=0?!0:!1},a.prototype.getLocalStreams=function(){return this.rtcMediaHandler&&this.rtcMediaHandler.peerConnection&&this.rtcMediaHandler.peerConnection.getLocalStreams()||[]},a.prototype.getRemoteStreams=function(){return this.rtcMediaHandler&&this.rtcMediaHandler.peerConnection&&this.rtcMediaHandler.peerConnection.getRemoteStreams()||[]},a.prototype.init_incoming=function(n){var i,s=this,o=n.getHeader("Content-Type");if(!n.body||o!=="application/sdp"){n.reply(415);return}this.status=l.STATUS_INVITE_RECEIVED,this.from_tag=n.from_tag,this.id=n.call_id+this.from_tag,this.request=n,this.contact=this.ua.contact.toString(),this.ua.sessions[this.id]=this,n.hasHeader("allow")&&(this.allowed=n.parseHeader("allow")),n.hasHeader("supported")&&(this.supported=n.parseHeader("supported")),n.hasHeader("expires")&&(i=n.getHeader("expires")*1e3),n.to_tag=t.Utils.newTag();if(!this.createDialog(n,"UAS",!0)){n.reply(500,"Missing Contact header field");return}var u=function(){n.reply(180,null,["Contact: "+s.contact]),s.status=l.STATUS_WAITING_FOR_ANSWER,s.timers.userNoAnswerTimer=e.setTimeout(function(){n.reply(480),s.failed("local",null,t.C.causes.NO_ANSWER)},s.ua.configuration.no_answer_timeout),i&&(s.timers.expiresTimer=e.setTimeout(function(){s.status===l.STATUS_WAITING_FOR_ANSWER&&(n.reply(487),s.failed("system",null,t.C.causes.EXPIRES))},i))},a=function(){n.reply(488),s.failed("remote",n,t.C.causes.BAD_MEDIA_DESCRIPTION)},c=function(){s.rtcMediaHandler=new r(s),s.rtcMediaHandler.onMessage("offer",n.body,function(){u(),s.newRTCSession("remote",n)},function(e){console.warn(f+"invalid SDP"),console.warn(e),a()})};this.ua.configuration.handle_media?c():this.newRTCSession("remote",n,u,a,c)},a.prototype.connect=function(e,n){n=n||{};var i,s,o,u=!1,a=n.eventHandlers||{},f=n.extraHeaders||[],c=n.mediaConstraints||{audio:!0,video:!0},h=n.RTCConstraints||{},p=n.featureTags||"",d=n.sdp;if(e===undefined)throw new TypeError("Not enough arguments");if(this.status!==l.STATUS_NULL)throw new t.Exceptions.InvalidStateError(this.status);for(i in a)this.on(i,a[i]);try{e=t.Utils.normalizeURI(e,this.ua.configuration.hostport_params)}catch(v){e=t.URI.parse(t.C.INVALID_TARGET_URI),u=!0}this.from_tag=t.Utils.newTag(),d||(this.rtcMediaHandler=new r(this,h)),this.anonymous=n.anonymous,this.isCanceled=!1,this.received_100=!1,s={from_tag:this.from_tag,extra_supported:t.Utils.getSessionExtensions(this,t.C.INVITE)},this.contact=this.ua.contact.toString({anonymous:this.anonymous,outbound:!0})+p,this.anonymous&&(s.from_display_name="Anonymous",s.from_uri="sip:anonymous@anonymous.invalid",f.push("P-Preferred-Identity: "+this.ua.configuration.uri.toString()),f.push("Privacy: id")),o=new t.OutgoingRequest(t.C.INVITE,e,this.ua,s,f),this.request=o,o.setHeader("contact",this.contact),o.setHeader("content-type","application/sdp"),this.id=this.request.call_id+this.from_tag,this.ua.sessions[this.id]=this,this.newRTCSession("local",this.request);if(u)this.failed("local",null,t.C.causes.INVALID_TARGET);else if(d){var m=new t.RequestSender(this,this.ua);this.request.body=d,this.status=l.STATUS_INVITE_SENT,m.send()}else this.sendInitialRequest(c)},a.prototype.close=function(){var t;if(this.status===l.STATUS_TERMINATED)return;console.log(f+"closing INVITE session "+this.id),this.rtcMediaHandler&&this.rtcMediaHandler.close(),this.incoming_refer&&this.incoming_refer.close(),this.outgoing_refer&&this.outgoing_refer.close();for(t in this.timers)e.clearTimeout(this.timers[t]);this.dialog&&(this.dialog.terminate(),delete this.dialog);for(t in this.earlyDialogs)this.earlyDialogs[t].terminate(),delete this.earlyDialogs[t];this.status=l.STATUS_TERMINATED,delete this.ua.sessions[this.id]},a.prototype.calcDialogId=function(e,t){var n=t==="UAS"?e.to_tag:e.from_tag,r=t==="UAS"?e.from_tag:e.to_tag;return e.call_id+n+r},a.prototype.createDialog=function(e,n,r){var i,s,o=this.calcDialogId(e,n);return s=this.earlyDialogs[o],r?s?!0:(s=new t.Dialog(this,e,n,t.Dialog.C.STATUS_EARLY),s.id?(this.earlyDialogs[o]=s,!0):(this.failed("remote",e,t.C.causes.INTERNAL_ERROR),!1)):s?(s.update(e,n),this.dialog=s,delete this.earlyDialogs[o],!0):(i=new t.Dialog(this,e,n),i.id?(this.to_tag=e.to_tag,this.dialog=i,!0):(this.failed("remote",e,t.C.causes.INTERNAL_ERROR),!1))},a.prototype.receiveRequest=function(n){var r,a,f,c,h;if(n.method===t.C.CANCEL)return this.status===l.STATUS_WAITING_FOR_ANSWER?(this.status=l.STATUS_CANCELED,this.request.reply(487),n.reply(200),this.failed("remote",n,t.C.causes.CANCELED),!0):(n.reply(481),!1);switch(n.method){case t.C.ACK:this.status===l.STATUS_WAITING_FOR_ACK?(e.clearTimeout(this.timers.ackTimer),e.clearTimeout(this.timers.invite2xxTimer),this.status=l.STATUS_CONFIRMED):this.lastReinvite&&this.lastReinvite.status===l.STATUS_WAITING_FOR_ACK&&this.lastReinvite.receiveAck();break;case t.C.BYE:this.status===l.STATUS_CONFIRMED&&(n.reply(200),this.ended("remote",n,t.C.causes.BYE));break;case t.C.INVITE:if(this.status!==l.STATUS_CONFIRMED)return n.reply(491),!1;if(this.lastReinvite)switch(this.lastReinvite.status){case l.STATUS_CONFIRMED:case l.STATUS_CANCELED:case l.STATUS_TERMINATED:break;default:return n.reply(491),!1}a=new s(this),a.init_incoming(n),this.lastReinvite=a;break;case t.C.INFO:if(this.status===l.STATUS_CONFIRMED||this.status===l.STATUS_WAITING_FOR_ACK)r=n.getHeader("content-type"),r&&r.match(/^application\/dtmf-relay/i)&&(new i(this)).init_incoming(n);break;case t.C.UPDATE:return f=new o(this),f.init_incoming(n);case t.C.REFER:if(this.incoming_refer&&!this.incoming_refer.closed)return n.reply(491,"Existing Refer In Progress"),!1;return c=new u(this),this.incoming_refer=c,c.init_incoming(n);case t.C.NOTIFY:if(!n.hasHeader("event"))return n.reply(400,"Missing Event Header"),!1;h=n.parseHeader("event");if(h&&h.event==="refer")return c=this.outgoing_refer,c?c.receiveRequest(n):(n.reply(481,"Subscription Does Not Exist"),!1);return n.reply(489),!1;case t.C.SUBSCRIBE:if(!n.hasHeader("event"))return n.reply(400,"Missing Event Header"),!1;h=n.parseHeader("event");if(h&&h.event==="refer")return c=this.incoming_refer,c?c.receiveRequest(n):(n.reply(403),!1);return n.reply(489),!1}return!0},a.prototype.sendInitialRequest=function(e){var n=this,r=new t.RequestSender(n,this.ua),i=function(e){n.rtcMediaHandler.addStream(e,o,u)},s=function(){if(n.status===l.STATUS_TERMINATED)return;n.failed("local",null,t.C.causes.USER_DENIED_MEDIA_ACCESS)},o=function(){n.rtcMediaHandler.createOffer(a,f)},u=function(){if(n.status===l.STATUS_TERMINATED)return;n.failed("local",null,t.C.causes.WEBRTC_ERROR)},a=function(e){if(n.isCanceled||n.status===l.STATUS_TERMINATED)return;n.request.body=e,n.status=l.STATUS_INVITE_SENT,r.send()},f=function(){if(n.status===l.STATUS_TERMINATED)return;n.failed("local",null,t.C.causes.WEBRTC_ERROR)};this.rtcMediaHandler.getUserMedia(i,s,e)},a.prototype.receiveResponse=function(e){switch(e.method){case t.C.INVITE:this.receiveInviteResponse(e);break;case t.C.BYE:break;default:console.warn(f+"Unexpected response received:",e)}},a.prototype.receiveInviteResponse=function(e){var n,r=this;if(this.status!==l.STATUS_INVITE_SENT&&this.status!==l.STATUS_1XX_RECEIVED&&this.status!==l.STATUS_CONFIRMED){console.warn(f+"Unexpected INVITE response:",e);return}if(this.isCanceled){e.status_code>=100&&e.status_code<200?this.request.cancel(this.cancelReason):e.status_code>=200&&e.status_code<299&&this.acceptAndTerminate(e);return}switch(!0){case/^100$/.test(e.status_code):this.received_100=!0;break;case/^1[0-9]{2}$/.test(e.status_code):if(!e.to_tag){console.warn(f+"1xx response received without to tag");break}e.hasHeader("contact")&&this.createDialog(e,"UAC",!0),this.status=l.STATUS_1XX_RECEIVED,this.progress("remote",e);break;case/^2[0-9]{2}$/.test(e.status_code):if(this.status===l.STATUS_CONFIRMED){var i=this.calcDialogId(e,"UAC");i===this.dialog.id.toString()?(console.info(f+"Retransmitting ACK"),this.sendACK()):(console.info(f+"Accepting and terminating fork, did:",i),this.acceptAndTerminate(e));break}this.status=l.STATUS_CONFIRMED;if(!e.body){this.acceptAndTerminate(e,400,"Missing session description"),this.failed("remote",e,t.C.causes.BAD_MEDIA_DESCRIPTION);break}if(!this.createDialog(e,"UAC"))break;this.sendACK(),e.hasHeader("allow")&&(this.allowed=e.parseHeader("allow")),e.hasHeader("supported")&&(this.supported=e.parseHeader("supported")),this.dialog.processSessionTimerHeaders(e),this.rtcMediaHandler?this.rtcMediaHandler.onMessage("answer",e.body,function(){r.started("remote",e)},function(n){console.warn(n),r.sendBye({status_code:488,reason_phrase:"Not Acceptable Here"}),r.failed("remote",e,t.C.causes.BAD_MEDIA_DESCRIPTION)}):r.started("remote",e);break;default:n=t.Utils.sipErrorCause(e.status_code),this.failed("remote",e,n)}},a.prototype.acceptAndTerminate=function(e,t,n){var r=this.calcDialogId(e,"UAC"),i=null;this.dialog?this.dialog&&r===this.dialog.id.toString()?i=this.dialog:this.earlyDialogs[r]?i=this.earlyDialogs[r]:this.createDialog(e,"UAC",!0)&&(i=this.earlyDialogs[r]):this.createDialog(e,"UAC")&&(i=this.dialog),i&&(this.sendACK({dialog:i}),this.sendBye({dialog:i,status_code:t,reason_phrase:n}))},a.prototype.sendACK=function(e){e=e||{};var n=e.dialog||this.dialog,r=n.createRequest(t.C.ACK);this.sendRequest(r)},a.prototype.sendBye=function(e){e=e||{};var n,r,i=e.status_code,s=e.reason_phrase||t.C.REASON_PHRASE[i]||"",o=e.extraHeaders||[],u=e.body,a=e.dialog||this.dialog;if(i&&(i<200||i>=700))throw new TypeError("Invalid status_code: "+i);i&&(r="SIP ;cause="+i+'; text="'+s+'"',o.push("Reason: "+r)),n=a.createRequest(t.C.BYE,o),n.body=u,this.sendRequest(n)},a.prototype.sendRequest=function(e){var t=new n(this,e);t.send()},a.prototype.onTransportError=function(){this.status!==l.STATUS_TERMINATED&&(this.status===l.STATUS_CONFIRMED?this.ended("system",null,t.C.causes.CONNECTION_ERROR):this.failed("system",null,t.C.causes.CONNECTION_ERROR))},a.prototype.onRequestTimeout=function(){this.status!==l.STATUS_TERMINATED&&(this.status===l.STATUS_CONFIRMED?this.ended("system",null,t.C.causes.REQUEST_TIMEOUT):this.failed("system",null,t.C.causes.CONNECTION_ERROR))},a.prototype.newRTCSession=function(e,t,n,r,i){var s=this,o="newRTCSession";e==="remote"?(s.direction="incoming",s.local_identity=t.to,s.remote_identity=t.from):e==="local"&&(s.direction="outgoing",s.local_identity=t.from,s.remote_identity=t.to),s.ua.emit(o,s.ua,{originator:e,session:s,request:t,sdpValid:n||null,sdpInvalid:r||null,handleMedia:i||null})},a.prototype.connecting=function(e,t){var n=this,r="connecting";n.emit(r,n,{originator:"local",request:t})},a.prototype.progress=function(e,t){var n=this,r="progress";n.emit(r,n,{originator:e,response:t||null})},a.prototype.started=function(e,t){var n=this,r="started";n.start_time=new Date,n.emit(r,n,{originator:e,response:t||null})},a.prototype.ended=function(e,t,n){var r=this,i="ended";r.end_time=new Date,r.close(),r.emit(i,r,{originator:e,message:t||null,cause:n})},a.prototype.failed=function(e,t,n){var r=this,i="failed";r.close(),r.emit(i,r,{originator:e,message:t||null,cause:n})},a.C=l,t.RTCSession=a}(t),function(e){var t;t=function(e){this.ua=e,this.direction=null,this.local_identity=null,this.remote_identity=null,this.data={}},t.prototype=new e.EventEmitter,t.prototype.send=function(t,n,r){var i,s,o,u,a,f=["succeeded","failed"],l=!1;if(t===undefined||n===undefined)throw new TypeError("Not enough arguments");this.initEvents(f),r=r||{},a=r.extraHeaders||[],u=r.eventHandlers||{},o=r.contentType||"text/plain";for(s in u)this.on(s,u[s]);try{t=e.Utils.normalizeURI(t,this.ua.configuration.hostport_params)}catch(c){t=e.URI.parse(e.C.INVALID_TARGET_URI),l=!0}this.direction="outgoing",this.local_identity=this.ua.configuration.uri,this.remote_identity=t,this.closed=!1,this.ua.applicants[this]=this,a.push("Content-Type: "+o),this.request=new e.OutgoingRequest(e.C.MESSAGE,t,this.ua,null,a),n&&(this.request.body=n),i=new e.RequestSender(this,this.ua),this.ua.emit("newMessage",this.ua,{originator:"local",message:this,request:this.request}),l?this.emit("failed",this,{originator:"local",cause:e.C.causes.INVALID_TARGET}):i.send()},t.prototype.receiveResponse=function(t){var n;if(this.closed)return;switch(!0){case/^1[0-9]{2}$/.test(t.status_code):break;case/^2[0-9]{2}$/.test(t.status_code):delete this.ua.applicants[this],this.emit("succeeded",this,{originator:"remote",response:t});break;default:delete this.ua.applicants[this],n=e.Utils.sipErrorCause(t.status_code),this.emit("failed",this,{originator:"remote",response:t,cause:n})}},t.prototype.onRequestTimeout=function(){if(this.closed)return;this.emit("failed",this,{originator:"system",cause:e.C.causes.REQUEST_TIMEOUT})},t.prototype.onTransportError=function(){if(this.closed)return;this.emit("failed",this,{originator:"system",cause:e.C.causes.CONNECTION_ERROR})},t.prototype.close=function(){this.closed=!0,delete this.ua.applicants[this]},t.prototype.init_incoming=function(t){var n;this.direction="incoming",this.request=t,this.local_identity=t.to.uri,this.remote_identity=t.from.uri,this.ua.emit("newMessage",this.ua,{originator:"remote",message:this,request:t}),n=this.ua.transactions.nist[t.via_branch],n&&(n.state===e.Transactions.C.STATUS_TRYING||n.state===e.Transactions.C.STATUS_PROCEEDING)&&t.reply(200)},t.prototype.accept=function(e){e=e||{};var t=e.extraHeaders||[],n=e.body;if(this.direction!=="incoming")throw new TypeError('Invalid method "accept" for an outgoing message');this.request.reply(200,null,t,n)},t.prototype.reject=function(e){e=e||{};var t=e.status_code||480,n=e.reason_phrase,r=e.extraHeaders||[],i=e.body;if(this.direction!=="incoming")throw new TypeError('Invalid method "reject" for an outgoing message');if(t<300||t>=700)throw new TypeError("Invalid status_code: "+t);this.request.reply(t,n,r,i)},e.Message=t}(t),function(t){var n,r=t.name+" | "+"UA"+" | ",i={STATUS_INIT:0,STATUS_READY:1,STATUS_USER_CLOSED:2,STATUS_NOT_READY:3,CONFIGURATION_ERROR:1,NETWORK_ERROR:2,EVENT_METHODS:{newRTCSession:"INVITE,UPDATE",newMessage:"MESSAGE",newRefer:"REFER"},ALLOWED_METHODS:["ACK","CANCEL","BYE","OPTIONS","NOTIFY"],ACCEPTED_BODY_TYPES:["application/sdp","application/dtmf-relay"],SUPPORTED_EXTENSIONS:["path","outbound","gruu"],EVENT_EXTENSIONS:{tdialog:"newRefer"},SESSION_EVENT_EXTENSIONS:{timer:"refresh"},MAX_FORWARDS:69,TAG_LENGTH:10};n=function(e){var t=["connected","disconnected","registered","unregistered","registrationFailed","newRTCSession","newMessage","newOptions","newRefer"];i.ACCEPTED_BODY_TYPES=i.ACCEPTED_BODY_TYPES.toString(),this.cache={credentials:{}},this.configuration={},this.dialogs={},this.registrator=null,this.applicants={},this.sessions={},this.refers={},this.transport=null,this.contact=null,this.status=i.STATUS_INIT,this.error=null,this.transactions={nist:{},nict:{},ist:{},ict:{}},this.transportRecoverAttempts=0,this.transportRecoverTimer=null;if(e===undefined)throw new TypeError("Not enough arguments");try{this.loadConfig(e),this.initEvents(t)}catch(n){throw this.status=i.STATUS_NOT_READY,this.error=i.CONFIGURATION_ERROR,n}},n.prototype=new t.EventEmitter,n.prototype.register=function(e){this.configuration.register=!0,this.registrator.register(e)},n.prototype.unregister=function(e){this.configuration.register=!1,this.registrator.unregister(e)},n.prototype.isRegistered=function(){return this.registrator&&this.registrator.registered?!0:!1},n.prototype.isConnected=function(){return this.transport?this.transport.connected:!1},n.prototype.updateConfiguration=function(e){if(e.ws_servers){var t=n.configuration_check.mandatory.ws_servers(e.ws_servers);t&&(this.configuration.ws_servers=t)}if(e.authorization_user){var r=n.configuration_check.optional.authorization_user(e.authorization_user);r&&(this.configuration.authorization_user=r)}if(e.password){var i=n.configuration_check.optional.password(e.password);i&&(this.configuration.password=i)}},n.prototype.call=function(e,n){var r;r=new t.RTCSession(this),r.connect(e,n)},n.prototype.sendMessage=function(e,n,r){var i;i=new t.Message(this),i.send(e,n,r)},n.prototype.sendRefer=function(e,n,r){var i;i=new t.Refer(this),i.send(e,n,r)},n.prototype.stop=function(){var t,n,s,o=this;console.log(r+"user requested closure...");if(this.status===i.STATUS_USER_CLOSED){console.warn("UA already closed");return}this.transportRecoverTimer&&(e.clearTimeout(this.transportRecoverTimer),this.transportRecoverTimer=null),this.registrator&&(console.log(r+"closing registrator"),this.registrator.close());for(t in this.sessions)console.log(r+"closing session "+t),this.sessions[t].terminate();for(n in this.refers)this.refers[n].close();for(s in this.applicants)this.applicants[s].close();this.status=i.STATUS_USER_CLOSED,this.isAnyTransactionOutstanding()?(this.transactionCheckTimer=e.setInterval(function(){o.isAnyTransactionOutstanding()||(e.clearInterval(o.transactionCheckTimer),e.clearTimeout(o.shutdownGraceTimer),o.transport.disconnect())},500),this.shutdownGraceTimer=e.setTimeout(function(){e.clearInterval(o.transactionCheckTimer),o.transport.disconnect()},"5000")):o.transport.disconnect()},n.prototype.start=function(){var e;console.log(r+"user requested startup..."),this.status===i.STATUS_INIT?(e=this.getNextWsServer(),new t.Transport(this,e)):this.status===i.STATUS_USER_CLOSED?(console.log(r+"resuming"),this.status=i.STATUS_READY,this.transport.connect()):this.status===i.STATUS_READY?console.log(r+"UA is in READY status, not resuming"):console.error("Connection is down. Auto-Recovery system is trying to connect")},n.prototype.saveCredentials=function(e){this.cache.credentials[e.realm]=this.cache.credentials[e.realm]||{},this.cache.credentials[e.realm][e.uri]=e},n.prototype.getCredentials=function(e){var t,n;return t=e.ruri.host,this.cache.credentials[t]&&this.cache.credentials[t][e.ruri]&&(n=this.cache.credentials[t][e.ruri],n.method=e.method),n},n.prototype.isAnyTransactionOutstanding=function(){var e=["nict","ict","nist","ist"];for(var t in e)for(var n in this.transactions[e[t]])return!!n;return!1},n.prototype.onTransportClosed=function(e){var n,i,s=["nict","ict","nist","ist"];e.server.status=t.Transport.C.STATUS_DISCONNECTED,console.log(r+"connection state set to "+t.Transport.C.STATUS_DISCONNECTED);for(n in s)for(i in this.transactions[s[n]])this.transactions[s[n]][i].onTransportError();this.contact.pub_gruu||this.closeSessionsOnTransportError()},n.prototype.onTransportError=function(e){var n;console.log(r+"transport "+e.server.ws_uri+" failed | connection state set to "+t.Transport.C.STATUS_ERROR),e.server.status=t.Transport.C.STATUS_ERROR,this.emit("disconnected",this,{transport:e,code:e.lastTransportError.code,reason:e.lastTransportError.reason});if(this.status===i.STATUS_USER_CLOSED)return;n=this.getNextWsServer();if(n)new t.Transport(this,n);else{this.closeSessionsOnTransportError();if(!this.error||this.error!==i.NETWORK_ERROR)this.status=i.STATUS_NOT_READY,this.error=i.NETWORK_ERROR;this.recoverTransport()}},n.prototype.onTransportConnected=function(e){this.transport=e,this.transportRecoverAttempts=0,e.server.status=t.Transport.C.STATUS_READY,console.log(r+"connection state set to "+t.Transport.C.STATUS_READY);if(this.status===i.STATUS_USER_CLOSED)return;this.status=i.STATUS_READY,this.error=null,this.emit("connected",this,{transport:e}),this.configuration.register?this.registrator?this.registrator.onTransportConnected():(this.registrator=new t.Registrator(this,e),this.register()):this.registrator=new t.Registrator(this,e)},n.prototype.receiveRequest=function(e){var n,s,o,u,a=e.method;if(e.ruri.user!==this.configuration.uri.user&&e.ruri.user!==this.contact.uri.user){console.warn(r+"Request-URI does not point to us"),e.method!==t.C.ACK&&e.reply_sl(404);return}if(t.Transactions.checkTransaction(this,e))return;if(e.hasHeader("require")){var f=t.Utils.getSupportedExtensions(this),l=e.parseHeader("require");for(var c=0,h=l.length;c<h;c++){var p=l[c];if(f.indexOf(p)<0&&!i.SESSION_EVENT_EXTENSIONS[p]){e.method!==t.C.ACK&&e.reply_sl(420);return}}}a===t.C.INVITE?new t.Transactions.InviteServerTransaction(e,this):a!==t.C.ACK&&new t.Transactions.NonInviteServerTransaction(e,this);if(a===t.C.OPTIONS){var d=["Allow: "+t.Utils.getAllowedMethods(this),"Accept: "+i.ACCEPTED_BODY_TYPES,"Supported: "+t.Utils.getSupportedExtensions(this).join(",")];!this.checkEvent("newOptions")||this.listeners("newOptions").length===0?e.reply(200,null,d):this.emit("newOptions",this,{originator:"remote",request:e,extraHeaders:d});return}if(a===t.C.MESSAGE){if(!this.checkEvent("newMessage")||this.listeners("newMessage").length===0){e.reply(405,null,["Allow: "+t.Utils.getAllowedMethods(this)]);return}o=new t.Message(this),o.init_incoming(e);return}if(!e.to_tag){if(!this.isRegistered()){e.reply(410);return}switch(a){case t.C.INVITE:!this.configuration.handle_media||t.WebRTC.isSupported?(s=new t.RTCSession(this),s.init_incoming(e)):(console.warn(r+"INVITE received but WebRTC is not supported"),e.reply(488));break;case t.C.BYE:e.reply(481);break;case t.C.CANCEL:s=this.findSession(e),s?s.receiveRequest(e):(e.reply(481),console.warn(r+"received CANCEL request for a non existent session"));break;case t.C.ACK:break;case t.C.REFER:u=new t.Refer(this),u.init_incoming(e);break;default:e.reply(405,null,["Allow: "+t.Utils.getAllowedMethods(this)])}}else{n=this.findDialog(e);if(n){n.receiveRequest(e);return}if(a===t.C.NOTIFY){s=this.findSession(e);if(s){s.receiveRequest(e);return}u=this.refers[e.call_id+e.to_tag];if(u){u.receiveRequest(e);return}console.warn(r+"received NOTIFY request for a non existent session"),e.reply(481,"Subscription does not exist");return}if(a!==t.C.ACK){e.reply(481);return}}},n.prototype.findSession=function(e){var t=e.call_id+e.from_tag,n=this.sessions[t],r=e.call_id+e.to_tag,i=this.sessions[r];return n?n:i?i:null},n.prototype.findDialog=function(e){var t=e.call_id+e.from_tag+e.to_tag,n=this.dialogs[t];return n?n:(t=e.call_id+e.to_tag+e.from_tag,n=this.dialogs[t],n?n:null)},n.prototype.getNextWsServer=function(){var e,n,r=[];for(e in this.configuration.ws_servers){n=this.configuration.ws_servers[e];if(n.status===t.Transport.C.STATUS_ERROR)continue;r.length===0?r.push(n):n.weight>r[0].weight?r=[n]:n.weight===r[0].weight&&r.push(n)}return e=Math.floor(Math.random()*r.length),r[e]},n.prototype.closeSessionsOnTransportError=function(){var e;for(e in this.sessions)this.sessions[e].onTransportError();this.registrator&&this.registrator.onTransportClosed()},n.prototype.recoverTransport=function(n){var i,s,o,u,a;n=n||this,u=n.transportRecoverAttempts;for(i in n.configuration.ws_servers)n.configuration.ws_servers[i].status=0;a=n.getNextWsServer(),s=Math.floor(Math.random()*Math.pow(2,u)+1),o=s*n.configuration.connection_recovery_min_interval,o>n.configuration.connection_recovery_max_interval&&(console.log(r+"time for next connection attempt exceeds connection_recovery_max_interval, resetting counter"),o=n.configuration.connection_recovery_min_interval,u=0),console.log(r+"next connection attempt in "+o+" seconds"),this.transportRecoverTimer=e.setTimeout(function(){n.transportRecoverAttempts=u+1,n.transportRecoverTimer=null,new t.Transport(n,a)},o*1e3)},n.prototype.loadConfig=function(i){var s,o,u,a,f,l={via_host:t.Utils.createRandomToken(12)+".invalid",password:null,register_expires:600,register_min_expires:120,register:!0,registrar_server:null,ws_server_max_reconnection:3,ws_server_reconnection_timeout:4,connection_recovery_min_interval:2,connection_recovery_max_interval:30,use_preloaded_route:!1,no_answer_timeout:60,stun_servers:["stun:stun.l.google.com:19302"],turn_servers:[],handle_media:!0,trace_sip:!1,hack_via_tcp:!1,hack_ip_in_contact:!1};for(s in n.configuration_check.mandatory){if(!i.hasOwnProperty(s))throw new t.Exceptions.ConfigurationError(s);o=i[s],u=n.configuration_check.mandatory[s](o);if(u===undefined)throw new t.Exceptions.ConfigurationError(s,o);l[s]=u}for(s in n.configuration_check.optional)if(i.hasOwnProperty(s)){o=i[s];if(o===null||o===""||o===undefined)continue;if(typeof o=="number"&&e.isNaN(o))continue;u=n.configuration_check.optional[s](o);if(u===undefined)throw new t.Exceptions.ConfigurationError(s,o);l[s]=u}if(l.connection_recovery_max_interval<l.connection_recovery_min_interval)throw new t.Exceptions.ConfigurationError("connection_recovery_max_interval",l.connection_recovery_max_interval);l.display_name===0&&(l.display_name="0"),l.instance_id||(l.instance_id="uuid:"+t.Utils.newUUID()),l.jssip_id=t.Utils.createRandomToken(5),a=l.uri.clone(),a.user=null,l.hostport_params=a.toString().replace(/^sip:/i,""),l.authorization_user||(l.authorization_user=l.uri.user),l.registrar_server||(f=l.uri.clone(),f.user=null,l.registrar_server=f),l.no_answer_timeout=l.no_answer_timeout*1e3,l.hack_ip_in_contact&&(l.via_host=t.Utils.getRandomTestNetIP()),this.contact={pub_gruu:null,temp_gruu:null,uri:new t.URI("sip",t.Utils.createRandomToken(8),l.via_host,null,{transport:"ws"}),toString:function(e){e=e||{};var t=e.anonymous||null,n=e.outbound||null,r="<";return t?r+=this.temp_gruu||"sip:anonymous@anonymous.invalid;transport=ws":r+=this.pub_gruu||this.uri.toString(),n&&(r+=";ob"),r+=">",r}},console.log(r+"configuration parameters after validation:");for(s in l){switch(s){case"uri":case"registrar_server":console.log("· "+s+": "+l[s]);break;default:console.log("· "+s+": "+e.JSON.stringify(l[s]))}n.configuration_skeleton[s].value=l[s]}Object.defineProperties(this.configuration,n.configuration_skeleton);for(s in l)n.configuration_skeleton[s].value="";return},n.configuration_skeleton=function(){var e,t,n={},r=["jssip_id","register_min_expires","ws_server_max_reconnection","ws_server_reconnection_timeout","hostport_params","uri","connection_recovery_max_interval","connection_recovery_min_interval","display_name","hack_via_tcp","hack_ip_in_contact","handle_media","instance_id","no_answer_timeout","register_expires","registrar_server","stun_servers","trace_sip","turn_servers","use_preloaded_route","via_core_value","via_host"],i=["ws_servers","authorization_user","password","register"];for(e in r)t=r[e],n[t]={value:"",writable:!1,configurable:!1};for(e in i)t=i[e],n[t]={value:"",writable:!0,configurable:!1};return n}(),n.configuration_check={mandatory:{uri:function(e){var n;/^sip:/i.test(e)||(e=t.C.SIP+":"+e),n=t.URI.parse(e);if(!n)return;if(!n.user)return;return n},ws_servers:function(e){var n,i;if(typeof e=="string")e=[{ws_uri:e}];else{if(!(e instanceof Array))return;for(n in e)typeof e[n]=="string"&&(e[n]={ws_uri:e[n]})}if(e.length===0)return!1;for(n in e){if(!e[n].ws_uri){console.error(r+'missing "ws_uri" attribute in ws_servers parameter');return}if(e[n].weight&&!Number(e[n].weight)){console.error(r+'"weight" attribute in ws_servers parameter must be a Number');return}i=t.Grammar.parse(e[n].ws_uri,"absoluteURI");if(i===-1){console.error(r+'invalid "ws_uri" attribute in ws_servers parameter: '+e[n].ws_uri);return}if(i.scheme!=="wss"&&i.scheme!=="ws"){console.error(r+"invalid URI scheme in ws_servers parameter: "+i.scheme);return}e[n].sip_uri="<sip:"+i.host+(i.port?":"+i.port:"")+";transport=ws;lr>",e[n].weight||(e[n].weight=0),e[n].status=0,e[n].scheme=i.scheme.toUpperCase()}return e}},optional:{authorization_user:function(e){if(t.Grammar.parse('"'+e+'"',"quoted_string")===-1)return;return e},connection_recovery_max_interval:function(n){var r;if(t.Utils.isDecimal(n)){r=e.Number(n);if(r>0)return r}},connection_recovery_min_interval:function(n){var r;if(t.Utils.isDecimal(n)){r=e.Number(n);if(r>0)return r}},display_name:function(e){if(t.Grammar.parse('"'+e+'"',"display_name")===-1)return;return e},hack_via_tcp:function(e){if(typeof e=="boolean")return e},hack_ip_in_contact:function(e){if(typeof e=="boolean")return e},handle_media:function(e){if(typeof e=="boolean")return e},instance_id:function(e){/^uuid?:/.test(e)||(e="uuid:"+e);if(t.Grammar.parse(e,"uuid_URI")===-1)return;return e},no_answer_timeout:function(n){var r;if(t.Utils.isDecimal(n)){r=e.Number(n);if(r>0)return r}},password:function(e){return String(e)},register:function(e){if(typeof e=="boolean")return e},register_expires:function(n){var r;if(t.Utils.isDecimal(n)){r=e.Number(n);if(r>0)return r}},registrar_server:function(e){var n;/^sip:/i.test(e)||(e=t.C.SIP+":"+e),n=t.URI.parse(e);if(!n)return;if(n.user)return;return n},stun_servers:function(e){var n,r;if(typeof e=="string")e=[e];else if(!(e instanceof Array))return;for(n in e){r=e[n],/^stuns?:/.test(r)||(r="stun:"+r);if(t.Grammar.parse(r,"stun_URI")===-1)return;e[n]=r}return e},trace_sip:function(e){if(typeof e=="boolean")return e},turn_servers:function(e){var n,r;e instanceof Array||(e=[e]);for(n in e){r=e[n];if(!r.server||!r.username||!r.password)return;/^turns?:/.test(r.server)||(r.server="turn:"+r.server);if(t.Grammar.parse(r.server,"turn_URI")===-1)return;if(t.Grammar.parse(r.username,"user")===-1)return;if(t.Grammar.parse(r.password,"password")===-1)return}return e},use_preloaded_route:function(e){if(typeof e=="boolean")return e}}},n.C=i,t.UA=n}(t),function(t){var n;n={str_utf8_length:function(t){return e.unescape(encodeURIComponent(t)).length},isFunction:function(e){return e!==undefined?Object.prototype.toString.call(e)==="[object Function]"?!0:!1:!1},isDecimal:function(e){return!isNaN(e)&&parseFloat(e)===parseInt(e,10)},createRandomToken:function(e,t){var n,r,i="";t=t||32;for(n=0;n<e;n++)r=Math.random()*t|0,i+=r.toString(t);return i},newTag:function(){return t.Utils.createRandomToken(t.UA.C.TAG_LENGTH)},newUUID:function(){var e="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,n=e==="x"?t:t&3|8;return n.toString(16)});return e},hostType:function(e){if(!e)return;e=t.Grammar.parse(e,"host");if(e!==-1)return e.host_type},normalizeURI:function(e,n){var r,i,s,o,u=e;if(!e)throw new t.Exceptions.InvalidTargetError(u);if(e instanceof t.URI)return e;if(typeof e=="string"){i=e.split("@");switch(i.length){case 1:if(!n)throw new t.Exceptions.InvalidTargetError(u);s=e,o=n;break;case 2:s=i[0],o=i[1];break;default:s=i.slice(0,i.length-1).join("@"),o=i[i.length-1]}s=s.replace(/^(sips?|tel):/i,""),/^[\-\.\(\)]*\+?[0-9\-\.\(\)]+$/.test(s)&&(s=s.replace(/[\-\.\(\)]/g,"")),e=t.C.SIP+":"+t.Utils.escapeUser(s)+"@"+o;if(r=t.URI.parse(e))return r;throw new t.Exceptions.InvalidTargetError(u)}throw new t.Exceptions.InvalidTargetError(u)},escapeUser:function(t){return e.encodeURIComponent(e.decodeURIComponent(t)).replace(/%3A/ig,":").replace(/%2B/ig,"+").replace(/%3F/ig,"?").replace(/%2F/ig,"/")},headerize:function(e){var t={"Call-Id":"Call-ID",Cseq:"CSeq","Www-Authenticate":"WWW-Authenticate","Min-Se":"Min-SE"},n=e.toLowerCase().replace(/_/g,"-").split("-"),r="",i;for(i in n)i!=="0"&&(r+="-"),r+=n[i].charAt(0).toUpperCase()+n[i].substring(1);return t[r]&&(r=t[r]),r},sipErrorCause:function(e){var n;for(n in t.C.SIP_ERROR_CAUSES)if(t.C.SIP_ERROR_CAUSES[n].indexOf(e)!==-1)return t.C.causes[n];return t.C.causes.SIP_FAILURE_CODE},getRandomTestNetIP:function(){function t(t,n){return e.Math.floor(e.Math.random()*(n-t+1)+t)}return"192.0.2."+t(1,254)},getAllowedMethods:function(e){var n,r=t.UA.C.ALLOWED_METHODS.toString();for(n in t.UA.C.EVENT_METHODS)e.checkEvent(n)&&e.listeners(n).length>0&&(r+=","+t.UA.C.EVENT_METHODS[n]);return r},getSupportedExtensions:function(e,n){var r,i,s=t.UA.C.SUPPORTED_EXTENSIONS.slice();for(r in t.UA.C.EVENT_EXTENSIONS)i=t.UA.C.EVENT_EXTENSIONS[r],e.checkEvent(i)&&e.listeners(i).length>0&&s.push(r);return n?s.concat(n):s},getSessionExtensions:function(e){var n,r,i=[];for(n in t.UA.C.SESSION_EVENT_EXTENSIONS)r=t.UA.C.SESSION_EVENT_EXTENSIONS[n],e.checkEvent(r)&&e.listeners(r).length>0&&i.push(n);return i},calculateMD5:function(e){function t(e,t){return e<<t|e>>>32-t}function n(e,t){var n,r,i,s,o;return i=e&2147483648,s=t&2147483648,n=e&1073741824,r=t&1073741824,o=(e&1073741823)+(t&1073741823),n&r?o^2147483648^i^s:n|r?o&1073741824?o^3221225472^i^s:o^1073741824^i^s:o^i^s}function r(e,t,n){return e&t|~e&n}function i(e,t,n){return e&n|t&~n}function s(e,t,n){return e^t^n}function o(e,t,n){return t^(e|~n)}function u(e,i,s,o,u,a,f){return e=n(e,n(n(r(i,s,o),u),f)),n(t(e,a),i)}function a(e,r,s,o,u,a,f){return e=n(e,n(n(i(r,s,o),u),f)),n(t(e,a),r)}function f(e,r,i,o,u,a,f){return e=n(e,n(n(s(r,i,o),u),f)),n(t(e,a),r)}function l(e,r,i,s,u,a,f){return e=n(e,n(n(o(r,i,s),u),f)),n(t(e,a),r)}function c(e){var t,n=e.length,r=n+8,i=(r-r%64)/64,s=(i+1)*16,o=Array(s-1),u=0,a=0;while(a<n)t=(a-a%4)/4,u=a%4*8,o[t]=o[t]|e.charCodeAt(a)<<u,a++;return t=(a-a%4)/4,u=a%4*8,o[t]=o[t]|128<<u,o[s-2]=n<<3,o[s-1]=n>>>29,o}function h(e){var t="",n="",r,i;for(i=0;i<=3;i++)r=e>>>i*8&255,n="0"+r.toString(16),t+=n.substr(n.length-2,2);return t}function p(e){e=e.replace(/\r\n/g,"\n");var t="";for(var n=0;n<e.length;n++){var r=e.charCodeAt(n);r<128?t+=String.fromCharCode(r):r>127&&r<2048?(t+=String.fromCharCode(r>>6|192),t+=String.fromCharCode(r&63|128)):(t+=String.fromCharCode(r>>12|224),t+=String.fromCharCode(r>>6&63|128),t+=String.fromCharCode(r&63|128))}return t}var d=[],v,m,g,y,b,w,E,S,x,T=7,N=12,C=17,k=22,L=5,A=9,O=14,M=20,_=4,D=11,P=16,H=23,B=6,j=10,F=15,I=21;e=p(e),d=c(e),w=1732584193,E=4023233417,S=2562383102,x=271733878;for(v=0;v<d.length;v+=16)m=w,g=E,y=S,b=x,w=u(w,E,S,x,d[v+0],T,3614090360),x=u(x,w,E,S,d[v+1],N,3905402710),S=u(S,x,w,E,d[v+2],C,606105819),E=u(E,S,x,w,d[v+3],k,3250441966),w=u(w,E,S,x,d[v+4],T,4118548399),x=u(x,w,E,S,d[v+5],N,1200080426),S=u(S,x,w,E,d[v+6],C,2821735955),E=u(E,S,x,w,d[v+7],k,4249261313),w=u(w,E,S,x,d[v+8],T,1770035416),x=u(x,w,E,S,d[v+9],N,2336552879),S=u(S,x,w,E,d[v+10],C,4294925233),E=u(E,S,x,w,d[v+11],k,2304563134),w=u(w,E,S,x,d[v+12],T,1804603682),x=u(x,w,E,S,d[v+13],N,4254626195),S=u(S,x,w,E,d[v+14],C,2792965006),E=u(E,S,x,w,d[v+15],k,1236535329),w=a(w,E,S,x,d[v+1],L,4129170786),x=a(x,w,E,S,d[v+6],A,3225465664),S=a(S,x,w,E,d[v+11],O,643717713),E=a(E,S,x,w,d[v+0],M,3921069994),w=a(w,E,S,x,d[v+5],L,3593408605),x=a(x,w,E,S,d[v+10],A,38016083),S=a(S,x,w,E,d[v+15],O,3634488961),E=a(E,S,x,w,d[v+4],M,3889429448),w=a(w,E,S,x,d[v+9],L,568446438),x=a(x,w,E,S,d[v+14],A,3275163606),S=a(S,x,w,E,d[v+3],O,4107603335),E=a(E,S,x,w,d[v+8],M,1163531501),w=a(w,E,S,x,d[v+13],L,2850285829),x=a(x,w,E,S,d[v+2],A,4243563512),S=a(S,x,w,E,d[v+7],O,1735328473),E=a(E,S,x,w,d[v+12],M,2368359562),w=f(w,E,S,x,d[v+5],_,4294588738),x=f(x,w,E,S,d[v+8],D,2272392833),S=f(S,x,w,E,d[v+11],P,1839030562),E=f(E,S,x,w,d[v+14],H,4259657740),w=f(w,E,S,x,d[v+1],_,2763975236),x=f(x,w,E,S,d[v+4],D,1272893353),S=f(S,x,w,E,d[v+7],P,4139469664),E=f(E,S,x,w,d[v+10],H,3200236656),w=f(w,E,S,x,d[v+13],_,681279174),x=f(x,w,E,S,d[v+0],D,3936430074),S=f(S,x,w,E,d[v+3],P,3572445317),E=f(E,S,x,w,d[v+6],H,76029189),w=f(w,E,S,x,d[v+9],_,3654602809),x=f(x,w,E,S,d[v+12],D,3873151461),S=f(S,x,w,E,d[v+15],P,530742520),E=f(E,S,x,w,d[v+2],H,3299628645),w=l(w,E,S,x,d[v+0],B,4096336452),x=l(x,w,E,S,d[v+7],j,1126891415),S=l(S,x,w,E,d[v+14],F,2878612391),E=l(E,S,x,w,d[v+5],I,4237533241),w=l(w,E,S,x,d[v+12],B,1700485571),x=l(x,w,E,S,d[v+3],j,2399980690),S=l(S,x,w,E,d[v+10],F,4293915773),E=l(E,S,x,w,d[v+1],I,2240044497),w=l(w,E,S,x,d[v+8],B,1873313359),x=l(x,w,E,S,d[v+15],j,4264355552),S=l(S,x,w,E,d[v+6],F,2734768916),E=l(E,S,x,w,d[v+13],I,1309151649),w=l(w,E,S,x,d[v+4],B,4149444226),x=l(x,w,E,S,d[v+11],j,3174756917),S=l(S,x,w,E,d[v+2],F,718787259),E=l(E,S,x,w,d[v+9],I,3951481745),w=n(w,m),E=n(E,g),S=n(S,y),x=n(x,b);var q=h(w)+h(E)+h(S)+h(x);return q.toLowerCase()}},t.Utils=n}(t),function(e){function f(){if(r.s("to").uri.scheme!=="sip")return g(416),!1}function l(){if(!r.to_tag&&r.call_id.substr(0,5)===i.configuration.jssip_id)return g(482),!1}function c(){var t=e.Utils.str_utf8_length(r.body),n=r.getHeader("content-length");if(t<n)return g(400),!1}function h(){var t,n,s=r.from_tag,o=r.call_id,u=r.cseq;if(!r.to_tag)if(r.method===e.C.INVITE){t=i.transactions.ist[r.via_branch];if(!t)return;for(n in i.transactions.ist){t=i.transactions.ist[n];if(t.request.from_tag===s&&t.request.call_id===o&&t.request.cseq===u)return g(482),!1}}else{t=i.transactions.nist[r.via_branch];if(!t)return;for(n in i.transactions.nist){t=i.transactions.nist[n];if(t.request.from_tag===s&&t.request.call_id===o&&t.request.cseq===u)return g(482),!1}}}function p(){if(r.countHeader("via")>1)return console.warn(n+"More than one Via header field present in the response. Dropping the response"),!1}function d(){var e=i.configuration.via_host;if(r.via.host!==e)return console.warn(n+"Via host in the response does not match UA Via host value. Dropping the response"),!1}function v(){var t=e.Utils.str_utf8_length(r.body),i=r.getHeader("content-length");if(t<i)return console.warn(n+"Message body length is lower than the value in Content-Length header field. Dropping the response"),!1}function m(){var e=["from","to","call_id","cseq","via"],t=e.length;while(t--)if(!r.hasHeader(e[t]))return console.warn(n+"Missing mandatory header field : "+e[t]+". Dropping the response"),!1}function g(t){var n,i="SIP/2.0 "+t+" "+e.C.REASON_PHRASE[t]+"\r\n",o=r.countHeader("via"),u=0;for(u;u<o;u++)i+="Via: "+r.getHeader("via",u)+"\r\n";n=r.getHeader("To"),r.to_tag||(n+=";tag="+e.Utils.newTag()),i+="To: "+n+"\r\n",i+="From: "+r.getHeader("From")+"\r\n",i+="Call-ID: "+r.call_id+"\r\n",i+="CSeq: "+r.cseq+" "+r.method+"\r\n",i+="\r\n",s.send(i)}var t,n=e.name+" | "+"SANITY CHECK"+" | ",r,i,s,o=[],u=[],a=[];o.push(f),o.push(l),o.push(c),o.push(h),u.push(p),u.push(d),u.push(v),a.push(m),t=function(t,n,f){var l,c;r=t,i=n,s=f,l=a.length;while(l--){c=a[l](r);if(c===!1)return!1}if(r instanceof e.IncomingRequest){l=o.length;while(l--){c=o[l](r);if(c===!1)return!1}}else if(r instanceof e.IncomingResponse){l=u.length;while(l--){c=u[l](r);if(c===!1)return!1}}return!0},e.sanityCheck=t}(t),function(e){var t,n=e.name+" | "+"DIGEST AUTHENTICATION"+" | ";t=function(e){this.username=e.configuration.authorization_user,this.password=e.configuration.password,this.cnonce=null,this.nc=0,this.ncHex="00000000",this.response=null},t.prototype.authenticate=function(t,r){this.algorithm=r.algorithm,this.realm=r.realm,this.nonce=r.nonce,this.opaque=r.opaque,this.stale=r.stale;if(this.algorithm){if(this.algorithm!=="MD5")return console.warn(n+'challenge with Digest algorithm different than "MD5", authentication aborted'),!1}else this.algorithm="MD5";if(!this.realm)return console.warn(n+"challenge without Digest realm, authentication aborted"),!1;if(!this.nonce)return console.warn(n+"challenge without Digest nonce, authentication aborted"),!1;if(r.qop)if(r.qop.indexOf("auth")>-1)this.qop="auth";else{if(!(r.qop.indexOf("auth-int")>-1))return console.warn(n+'challenge without Digest qop different than "auth" or "auth-int", authentication aborted'),!1;this.qop="auth-int"}else this.qop=null;return this.method=t.method,this.uri=t.ruri,this.cnonce=e.Utils.createRandomToken(12),this.nc+=1,this.updateNcHex(),this.nc===4294967296&&(this.nc=1,this.ncHex="00000001"),this.calculateResponse(),!0},t.prototype.calculateResponse=function(){var t,n;t=e.Utils.calculateMD5(this.username+":"+this.realm+":"+this.password),this.qop==="auth"?(n=e.Utils.calculateMD5(this.method+":"+this.uri),this.response=e.Utils.calculateMD5(t+":"+this.nonce+":"+this.ncHex+":"+this.cnonce+":auth:"+n)):this.qop==="auth-int"?(n=e.Utils.calculateMD5(this.method+":"+this.uri+":"+e.Utils.calculateMD5(this.body?this.body:"")),this.response=e.Utils.calculateMD5(t+":"+this.nonce+":"+this.ncHex+":"+this.cnonce+":auth-int:"+n)):this.qop===null&&(n=e.Utils.calculateMD5(this.method+":"+this.uri),this.response=e.Utils.calculateMD5(t+":"+this.nonce+":"+n))},t.prototype.toString=function(){var e=[];if(!this.response)throw new Error("response field does not exist, cannot generate Authorization header");return e.push("algorithm="+this.algorithm),e.push('username="'+this.username+'"'),e.push('realm="'+this.realm+'"'),e.push('nonce="'+this.nonce+'"'),e.push('uri="'+this.uri+'"'),e.push('response="'+this.response+'"'),this.opaque&&e.push('opaque="'+this.opaque+'"'),this.qop&&(e.push("qop="+this.qop),e.push('cnonce="'+this.cnonce+'"'),e.push("nc="+this.ncHex)),"Digest "+e.join(", ")},t.prototype.updateNcHex=function(){var e=Number(this.nc).toString(16);this.ncHex="00000000".substr(0,8-e.length)+e},e.DigestAuthentication=t}(t),function(t){var n;n={},e.navigator.webkitGetUserMedia?n.getUserMedia=e.navigator.webkitGetUserMedia.bind(navigator):e.navigator.mozGetUserMedia?n.getUserMedia=e.navigator.mozGetUserMedia.bind(navigator):e.navigator.getUserMedia&&(n.getUserMedia=e.navigator.getUserMedia.bind(navigator)),e.webkitRTCPeerConnection?n.RTCPeerConnection=e.webkitRTCPeerConnection:e.mozRTCPeerConnection?n.RTCPeerConnection=e.mozRTCPeerConnection:e.RTCPeerConnection&&(n.RTCPeerConnection=e.RTCPeerConnection),e.webkitRTCSessionDescription?n.RTCSessionDescription=e.webkitRTCSessionDescription:e.mozRTCSessionDescription?n.RTCSessionDescription=e.mozRTCSessionDescription:e.RTCSessionDescription&&(n.RTCSessionDescription=e.RTCSessionDescription),n.RTCPeerConnection&&n.RTCPeerConnection.prototype&&(n.RTCPeerConnection.prototype.getLocalStreams||(n.RTCPeerConnection.prototype.getLocalStreams=function(){return this.localStreams},n.RTCPeerConnection.prototype.getRemoteStreams=function(){return this.remoteStreams})),n.getUserMedia&&n.RTCPeerConnection&&n.RTCSessionDescription?n.isSupported=!0:n.isSupported=!1,t.WebRTC=n}(t),function(e){var t,n=e.name+" | "+"REFER"+" | ",r=18e4;t=function(e){var t=["accepted","failed","notify"];this.ua=e,this.targetDialog=null,this.closed=!1,this.request=null,this.local_tag=null,this.remote_tag=null,this.id=null,this.contact=null,this.notify_timer=null,this.dialog=null,this.subscription_state="pending",this.subscription_expires=null,this.expire_timer=null,this.last_notify_body=null,this.accepted=!1,this.rejected=!1,this.direction=null,this.local_identity=null,this.remote_identity=null,this.refer_uri=null,this.data={},this.initEvents(t)},t.prototype=new e.EventEmitter,t.prototype.send=function(t,r,i){var s,o,u,a,f,l,c=null;if(t===undefined||r===undefined)throw new TypeError("Not enough arguments");i=i||{},f=i.extraHeaders||[],a=i.eventHandlers||{},u=i.contentType||"text/plain";for(o in a)this.on(o,a[o]);try{t=e.Utils.normalizeURI(t,this.ua.configuration.hostport_params)}catch(h){t=e.URI.parse(e.C.INVALID_TARGET_URI),c=e.C.causes.INVALID_TARGET}try{r=e.Utils.normalizeURI(r,this.ua.configuration.hostport_params)}catch(h){r=e.URI.parse(e.C.INVALID_TARGET_URI),c=e.C.causes.INVALID_REFER_TO_TARGET}this.direction="outgoing",this.local_identity=this.ua.configuration.uri,this.remote_identity=t,this.refer_uri=r,this.local_tag=e.Utils.newTag(),this.contact=this.ua.contact.toString({outbound:!0}),l=new e.OutgoingRequest(e.C.REFER,t,this.ua,{from_tag:this.local_tag},f,i.body),this.request=l,this.id=l.call_id+this.local_tag,this.ua.refers[this.id]=this,l.setHeader("contact",this.contact),l.setHeader("refer-to",r),i.targetDialog&&(this.targetDialog=i.targetDialog,l.setHeader("require",e.C.SIP_EXTENSIONS.TARGET_DIALOG),l.setHeader("target-dialog",i.targetDialog.id.toTargetDialogHeader())),i.body&&l.setHeader("content-type",u),s=new e.RequestSender(this,this.ua),this.ua.emit("newRefer",this.ua,{originator:"local",refer:this,request:this.request}),c?this.emit("failed",this,{originator:"local",cause:c}):(s.send(),console.log(n+this.id+" sent"),this.notify_timer=setTimeout(this.onNotifyTimeout.bind(this),e.Timers.TIMER_F))},t.prototype.receiveResponse=function(t){var r;if(this.closed)return;switch(!0){case/^1[0-9]{2}$/.test(t.status_code):break;case/^2[0-9]{2}$/.test(t.status_code):console.log(n+this.id+" accepted"),this.emit("accepted",this,{originator:"remote",response:t});break;default:console.log(n+this.id+" rejected (early)"),this.close(),r=e.Utils.sipErrorCause(t.status_code),this.emit("failed",this,{originator:"remote",message:t,cause:r})}},t.prototype.onRequestTimeout=function(){if(this.closed)return;console.log(n+this.id+" request timeout"),this.close(),this.emit("failed",this,{originator:"system",cause:e.C.causes.REQUEST_TIMEOUT})},t.prototype.onTransportError=function(){if(this.closed)return;console.log(n+this.id+" transport error"),this.close(),this.emit("failed",this,{originator:"system",cause:e.C.causes.CONNECTION_ERROR})},t.prototype.onNotifyTimeout=function(){if(this.closed||this.subscription_state!=="pending")return;console.log(n+this.id+" notify timeout"),this.emitFinalNotify(),this.close()},t.prototype.emitFinalNotify=function(){var t,n=this.last_notify_body;n||(n=e.Parser.parseMessage("SIP/2.0 100 Trying\r\n",!0)),n.status_code<200?t="progress":n.status_code<300?t="started":t="failed",this.emit("notify",this,{originator:"system",request:null,sipFrag:n,sessionEvent:t,finalNotify:!0})},t.prototype.close=function(){this.subscription_state==="active"&&(console.warn(n+this.id+" closed with active subscription"),this.direction==="incoming"?this.notify({body:this.last_notify_body,finalNotify:!0}):this.emitFinalNotify()),this.expire_timer!==null&&(clearTimeout(this.expire_timer),this.expire_timer=null),this.notify_timer!==null&&(clearTimeout(this.notify_timer),this.notify_timer=null),this.dialog&&(this.dialog.terminate(),delete this.dialog),this.closed=!0,delete this.ua.refers[this],console.log(n+this.id+" closed")},t.prototype.subscriptionExpired=function(){if(this.subscription_state==="terminated")return;this.notify({body:this.last_notify_body,finalNotify:!0,terminateReason:"timeout"}),this.expire_timer=null,console.log(n+this.id+" subscription expired")},t.prototype.init_incoming=function(t){var r=null;this.direction="incoming",this.request=t,this.remote_tag=t.from_tag,this.id=t.call_id+t.from_tag,this.contact=this.ua.contact.toString(),this.local_identity=t.to.uri,this.remote_identity=t.from.uri;if(!t.hasHeader("refer-to")){t.reply(400,"Missing Refer-To header field");return}if(t.countHeader("refer-to")>1){t.reply(400,"Too many Refer-To header fields");return}this.refer_uri=t.parseHeader("refer-to").uri;if(t.hasHeader("target-dialog")){var i=t.parseHeader("target-dialog"),s=new e.DialogId(i.call_id,i.local_tag,i.remote_tag);this.targetDialog=this.ua.dialogs[s.toString()]||null}if(this.targetDialog&&this.targetDialog.isConfirmed()){r=this.targetDialog.owner;if(r.dialog!==this.targetDialog||!r instanceof e.RTCSession)r=null}this.local_tag=t.to_tag=e.Utils.newTag(),this.dialog=new e.Dialog(this,t,"UAS");if(!this.dialog.id){t.reply(500,"Missing Contact header field");return}this.ua.refers[this.id]=this,console.log(n+this.id+" received"),this.ua.emit("newRefer",this.ua,{originator:"remote",refer:this,request:t,session:r}),!this.accepted&&!this.rejected&&this.accept()},t.prototype.call=function(t){var n,r=this.refer_uri;if(r.scheme!==e.C.SIP)throw new e.Exceptions.InvalidTargetError(r);return this.accepted||this.accept(),n=new e.RTCSession(this.ua),n.connect(r,t),this.addSessionNotifyHandlers(n),n},t.prototype.addSessionNotifyHandlers=function(t){var n=this;t.on("progress",function(e){var t=e.data.response;n.notify({status_code:t.status_code,reason_phrase:t.reason_phrase})}),t.once("started",function(e){var t=e.data.response;n.notify({status_code:t.status_code,reason_phrase:t.reason_phrase}),n.close()}),t.once("failed",function(t){var r=500,i=null,s=t.data.message;s&&s instanceof e.IncomingResponse&&(r=s.status_code,i=s.reason_phrase),n.notify({status_code:r,reason_phrase:i}),n.close()})},t.prototype.accept=function(e){e=e||{};var t=e.extraHeaders||[],i=e.body;if(this.direction!=="incoming")throw new TypeError('Invalid method "accept" for an outgoing refer');if(this.closed)return;this.subscription_state="active",this.subscription_expires=Date.now()+r,this.expire_timer=setTimeout(this.subscriptionExpired.bind(this),r),t.push("Contact: "+this.contact),this.request.reply(202,null,t,i),this.notify(),this.accepted=!0,console.log(n+this.id+" accepted")},t.prototype.reject=function(e){e=e||{};var t=e.status_code||603,r=e.reason_phrase,i=e.extraHeaders||[],s=e.body;if(this.direction!=="incoming")throw new TypeError('Invalid method "reject" for an outgoing refer');if(t<300||t>=700)throw new TypeError("Invalid status_code: "+t);if(this.closed)return;this.accepted?(console.log(n+this.id+" rejected (late)"),this.notify({status_code:t,reason_phrase:r})):(console.log(n+this.id+" rejected (early)"),this.request.reply(t,r,i,s),this.rejected=!0),this.close()},t.prototype.notify=function(t){var r,i,s,o,u,a,f,l,c=this;if(this.direction!=="incoming")throw new TypeError('Invalid method "notify" for an outgoing refer');t=t||{};if(t.body&&typeof t.finalNotify=="undefined")throw new TypeError("Must specify finalNotify when providing notify body");if(this.subscription_state!=="active")return;r=t.status_code||100,i=t.reason_phrase||e.C.REASON_PHRASE[r]||"",s=t.finalNotify||r>=200,s?(o="terminated",u=t.terminateReason||"noresource",a=o+";reason="+u):(o="active",a=o+";expires="+Math.round((this.subscription_expires-Date.now())/1e3)),f=t.body||"SIP/2.0 "+r+" "+i+"\r\n",this.last_notify_body=f,l=new e.Notify(this),l.send("refer",a,{extraHeaders:t.extraHeaders,eventHandlers:t.eventHandlers,content_type:"message/sipfrag",body:f}),this.subscription_state=o,s||l.on("failed",function(){c.subscription_state="terminated",console.log(n+c.id+" unsubscribed (rejected notify)"),c.close()})},t.prototype.receiveRequest=function(t){switch(t.method){case e.C.NOTIFY:this.receiveNotify(t);return;case e.C.SUBSCRIBE:this.receiveSubscribe(t);return}t.reply(405,null,["Allow: "+e.Utils.getAllowedMethods(this.ua)])},t.prototype.receiveNotify=function(t){var r,i,s,o,u,a,f,l=!1;if(this.direction!=="outgoing"||this.subscription_state!=="active"&&this.subscription_state!=="pending"){t.reply(481,"Subscription Does Not Exist");return}r=t.parseHeader("event");if(!r||r.event!=="refer"){t.reply(489),this.close();return}i=t.parseHeader("subscription-state");if(!i){t.reply(400,"Missing Subscription-State Header"),this.close();return}s=t.getHeader("content-type");if(s&&s.indexOf("message/sipfrag")<0){t.reply(415),this.close();return}f=t.body,/\r\n$/.test(f)||(f+="\r\n"),o=e.Parser.parseMessage(f,!0);if(!o||!o instanceof e.IncomingResponse){t.reply(400,"Bad Message Body"),this.close();return}if(this.listeners("notify").length===0){console.log(n+this.id+" no notify listeners; unsubscribing"),t.reply(603),this.subscription_state="terminated",this.close();return}if(!this.dialog){this.remote_tag=t.from_tag,this.dialog=new e.Dialog(this,t,"UAS");if(!this.dialog.id){console.warn(n+this.id+" dialog creation failed"),this.close(),this.emit("failed",this,{originator:"remote",message:t,cause:e.C.causes.INTERNAL_ERROR});return}}this.subscription_state=i.state,this.subscription_expires=Date.now()+i.expires*1e3,this.last_notify_body=o,this.notify_timer!==null&&(clearTimeout(this.notify_timer),this.notify_timer=null),this.expire_timer!==null&&(clearTimeout(this.expire_timer),this.expire_timer=null),a=["Contact: "+this.contact],t.reply(200,null,a),o.status_code<200?u="progress":o.status_code<300?u="started":u="failed",console.log(n+this.id+" notify: "+u),this.subscription_state==="terminated"?(l=!0,this.close()):this.expire_timer=setTimeout(this.close.bind(this),(i.expires+e.Timers.T4)*1e3),this.emit("notify",this,{originator:"remote",request:t,sipFrag:o,sessionEvent:u,finalNotify:l})},t.prototype.receiveSubscribe=function(e){var t,i,s;if(this.direction!=="incoming"){e.reply(481);return}if(this.subscription_state!=="active"&&this.subscription_state!=="terminated"){e.reply(403);return}t=e.parseHeader("event");if(!t||t.event!=="refer"){e.reply(489);return}i=e.parseHeader("expires");if(i===0){console.log(n+this.id+" unsubscribed (expires=0)"),this.notify({body:this.last_notify_body,finalNotify:!0}),s=["Contact: "+this.contact],e.reply(200,null,s),this.close();return}i>0?i*=1e3:i=r,this.subscription_state="active",this.subscription_expires=Date.now()+i,this.expire_timer!==null&&clearTimeout(this.expire_timer),this.expire_timer=setTimeout(this.subscriptionExpired.bind(this),i),s=["Contact: "+this.contact,"Expires: "+i/1e3],e.reply(200,null,s),console.log(n+this.id+" subscription extended")},e.Refer=t}(t),function(e){var t;t=function(e){var t=["succeeded","failed"];this.session=e,this.direction=null,this.request=null,this.initEvents(t)},t.prototype=new e.EventEmitter,t.prototype.send=function(t,n,r){var i,s,o,u,a;this.direction="outgoing";if(this.session.subscription_state!=="active"&&this.session.subscription_state!=="pending")throw new e.Exceptions.InvalidStateError(this.session.subscription_state);r=r||{},u=r.extraHeaders?r.extraHeaders.slice():[],o=r.eventHandlers||{};for(s in o)this.on(s,o[s]);a=this.session.dialog.createRequest(e.C.NOTIFY,u),this.request=a,a.setHeader("contact",this.session.contact),a.setHeader("event",t),a.setHeader("subscription-state",n),r.content_type&&a.setHeader("content-type",r.content_type),r.body&&(a.body=r.body),i=new e.RequestSender(this,this.session.ua),this.session.emit("notify",this.session,{originator:"local",notify:this,request:a}),i.send()},t.prototype.receiveResponse=function(t){var n;if(this.session.subscription_state==="terminated")return;switch(!0){case/^1[0-9]{2}$/.test(t.status_code):break;case/^2[0-9]{2}$/.test(t.status_code):this.emit("succeeded",this,{originator:"remote",response:t});break;default:n=e.Utils.sipErrorCause(t.status_code),this.emit("failed",this,{originator:"remote",response:t,cause:n})}},t.prototype.onRequestTimeout=function(){this.emit("failed",this,{originator:"system",cause:e.C.causes.REQUEST_TIMEOUT})},t.prototype.onTransportError=function(){this.emit("failed",this,{originator:"system",cause:e.C.causes.CONNECTION_ERROR})},e.Notify=t}(t),typeof module=="object"&&module&&typeof module.exports=="object"?module.exports=t:(e.JsSIP=t,typeof r=="function"&&r.amd&&r("jssip",[],function(){return t}))}(window),JsSIP.Grammar=function(){function e(e){return'"'+e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E-\x1F\x80-\uFFFF]/g,escape)+'"'}var t={parse:function(t,n){function a(e,t,n){var r=e,i=n-e.length;for(var s=0;s<i;s++)r=t+r;return r}function f(e){var t=e.charCodeAt(0),n,r;return t<=255?(n="x",r=2):(n="u",r=4),"\\"+n+a(t.toString(16).toUpperCase(),"0",r)}function l(e){if(i<o)return;i>o&&(o=i,u=[]),u.push(e)}function c(){var e;return t.substr(i,2)==="\r\n"?(e="\r\n",i+=2):(e=null,s===0&&l('"\\r\\n"')),e}function h(){var e;return/^[0-9]/.test(t.charAt(i))?(e=t.charAt(i),i++):(e=null,s===0&&l("[0-9]")),e}function p(){var e;return/^[a-zA-Z]/.test(t.charAt(i))?(e=t.charAt(i),i++):(e=null,s===0&&l("[a-zA-Z]")),e}function d(){var e;return/^[0-9a-fA-F]/.test(t.charAt(i))?(e=t.charAt(i),i++):(e=null,s===0&&l("[0-9a-fA-F]")),e}function v(){var e;return e=y(),e===null&&(e=b()),e}function m(){var e;return/^[\0-\xFF]/.test(t.charAt(i))?(e=t.charAt(i),i++):(e=null,s===0&&l("[\\0-\\xFF]")),e}function g(){var e;return/^["]/.test(t.charAt(i))?(e=t.charAt(i),i++):(e=null,s===0&&l('["]')),e}function y(){var e;return t.charCodeAt(i)===32?(e=" ",i++):(e=null,s===0&&l('" "')),e}function b(){var e;return t.charCodeAt(i)===9?(e="	",i++):(e=null,s===0&&l('"\\t"')),e}function w(){var e;return/^[a-zA-Z0-9]/.test(t.charAt(i))?(e=t.charAt(i),i++):(e=null,s===0&&l("[a-zA-Z0-9]")),e}function E(){var e;return t.charCodeAt(i)===59?(e=";",i++):(e=null,s===0&&l('";"')),e===null&&(t.charCodeAt(i)===47?(e="/",i++):(e=null,s===0&&l('"/"')),e===null&&(t.charCodeAt(i)===63?(e="?",i++):(e=null,s===0&&l('"?"')),e===null&&(t.charCodeAt(i)===58?(e=":",i++):(e=null,s===0&&l('":"')),e===null&&(t.charCodeAt(i)===64?(e="@",i++):(e=null,s===0&&l('"@"')),e===null&&(t.charCodeAt(i)===38?(e="&",i++):(e=null,s===0&&l('"&"')),e===null&&(t.charCodeAt(i)===61?(e="=",i++):(e=null,s===0&&l('"="')),e===null&&(t.charCodeAt(i)===43?(e="+",i++):(e=null,s===0&&l('"+"')),e===null&&(t.charCodeAt(i)===36?(e="$",i++):(e=null,s===0&&l('"$"')),e===null&&(t.charCodeAt(i)===44?(e=",",i++):(e=null,s===0&&l('","'))))))))))),e}function S(){var e;return e=w(),e===null&&(e=x()),e}function x(){var e;return t.charCodeAt(i)===45?(e="-",i++):(e=null,s===0&&l('"-"')),e===null&&(t.charCodeAt(i)===95?(e="_",i++):(e=null,s===0&&l('"_"')),e===null&&(t.charCodeAt(i)===46?(e=".",i++):(e=null,s===0&&l('"."')),e===null&&(t.charCodeAt(i)===33?(e="!",i++):(e=null,s===0&&l('"!"')),e===null&&(t.charCodeAt(i)===126?(e="~",i++):(e=null,s===0&&l('"~"')),e===null&&(t.charCodeAt(i)===42?(e="*",i++):(e=null,s===0&&l('"*"')),e===null&&(t.charCodeAt(i)===39?(e="'",i++):(e=null,s===0&&l('"\'"')),e===null&&(t.charCodeAt(i)===40?(e="(",i++):(e=null,s===0&&l('"("')),e===null&&(t.charCodeAt(i)===41?(e=")",i++):(e=null,s===0&&l('")"')))))))))),e}function T(){var e,n,r,o;return o=i,t.charCodeAt(i)===37?(e="%",i++):(e=null,s===0&&l('"%"')),e!==null?(n=d(),n!==null?(r=d(),r!==null?e=[e,n,r]:(e=null,i=o)):(e=null,i=o)):(e=null,i=o),e}function N(){var e,t,n,r,s,o;r=i,s=i,o=i,e=[],t=v();while(t!==null)e.push(t),t=v();e!==null?(t=c(),t!==null?e=[e,t]:(e=null,i=o)):(e=null,i=o),e=e!==null?e:"";if(e!==null){n=v();if(n!==null){t=[];while(n!==null)t.push(n),n=v()}else t=null;t!==null?e=[e,t]:(e=null,i=s)}else e=null,i=s;return e!==null&&(e=function(e){return" "}(r)),e===null&&(i=r),e}function C(){var e;return e=N(),e=e!==null?e:"",e}function k(){var e,n,r,o,u;o=i,u=i,e=[],n=y(),n===null&&(n=b());while(n!==null)e.push(n),n=y(),n===null&&(n=b());return e!==null?(t.charCodeAt(i)===58?(n=":",i++):(n=null,s===0&&l('":"')),n!==null?(r=C(),r!==null?e=[e,n,r]:(e=null,i=u)):(e=null,i=u)):(e=null,i=u),e!==null&&(e=function(e){return":"}(o)),e===null&&(i=o),e}function L(){var e,n,r,s,o,u,a;o=i,u=i,n=A();if(n!==null){e=[];while(n!==null)e.push(n),n=A()}else e=null;if(e!==null){n=[],a=i,r=[],s=N();while(s!==null)r.push(s),s=N();r!==null?(s=A(),s!==null?r=[r,s]:(r=null,i=a)):(r=null,i=a);while(r!==null){n.push(r),a=i,r=[],s=N();while(s!==null)r.push(s),s=N();r!==null?(s=A(),s!==null?r=[r,s]:(r=null,i=a)):(r=null,i=a)}n!==null?e=[e,n]:(e=null,i=u)}else e=null,i=u;return e!==null&&(e=function(e){return t.substring(i,e)}(o)),e===null&&(i=o),e}function A(){var e;return/^[!-~]/.test(t.charAt(i))?(e=t.charAt(i),i++):(e=null,s===0&&l("[!-~]")),e===null&&(e=O()),e}function O(){var e;return/^[\x80-\uFFFF]/.test(t.charAt(i))?(e=t.charAt(i),i++):(e=null,s===0&&l("[\\x80-\\uFFFF]")),e}function M(){var e;return/^[\x80-\xBF]/.test(t.charAt(i))?(e=t.charAt(i),i++):(e=null,s===0&&l("[\\x80-\\xBF]")),e}function _(){var e;return e=h(),e===null&&(/^[a-f]/.test(t.charAt(i))?(e=t.charAt(i),i++):(e=null,s===0&&l("[a-f]"))),e}function D(){var e,n,r;r=i,n=w(),n===null&&(t.charCodeAt(i)===45?(n="-",i++):(n=null,s===0&&l('"-"')),n===null&&(t.charCodeAt(i)===46?(n=".",i++):(n=null,s===0&&l('"."')),n===null&&(t.charCodeAt(i)===33?(n="!",i++):(n=null,s===0&&l('"!"')),n===null&&(t.charCodeAt(i)===37?(n="%",i++):(n=null,s===0&&l('"%"')),n===null&&(t.charCodeAt(i)===42?(n="*",i++):(n=null,s===0&&l('"*"')),n===null&&(t.charCodeAt(i)===95?(n="_",i++):(n=null,s===0&&l('"_"')),n===null&&(t.charCodeAt(i)===43?(n="+",i++):(n=null,s===0&&l('"+"')),n===null&&(t.charCodeAt(i)===96?(n="`",i++):(n=null,s===0&&l('"`"')),n===null&&(t.charCodeAt(i)===39?(n="'",i++):(n=null,s===0&&l('"\'"')),n===null&&(t.charCodeAt(i)===126?(n="~",i++):(n=null,s===0&&l('"~"'))))))))))));if(n!==null){e=[];while(n!==null)e.push(n),n=w(),n===null&&(t.charCodeAt(i)===45?(n="-",i++):(n=null,s===0&&l('"-"')),n===null&&(t.charCodeAt(i)===46?(n=".",i++):(n=null,s===0&&l('"."')),n===null&&(t.charCodeAt(i)===33?(n="!",i++):(n=null,s===0&&l('"!"')),n===null&&(t.charCodeAt(i)===37?(n="%",i++):(n=null,s===0&&l('"%"')),n===null&&(t.charCodeAt(i)===42?(n="*",i++):(n=null,s===0&&l('"*"')),n===null&&(t.charCodeAt(i)===95?(n="_",i++):(n=null,s===0&&l('"_"')),n===null&&(t.charCodeAt(i)===43?(n="+",i++):(n=null,s===0&&l('"+"')),n===null&&(t.charCodeAt(i)===96?(n="`",i++):(n=null,s===0&&l('"`"')),n===null&&(t.charCodeAt(i)===39?(n="'",i++):(n=null,s===0&&l('"\'"')),n===null&&(t.charCodeAt(i)===126?(n="~",i++):(n=null,s===0&&l('"~"'))))))))))))}else e=null;return e!==null&&(e=function(e){return t.substring(i,e)}(r)),e===null&&(i=r),e}function P(){var e,n,r;r=i,n=w(),n===null&&(t.charCodeAt(i)===45?(n="-",i++):(n=null,s===0&&l('"-"')),n===null&&(t.charCodeAt(i)===33?(n="!",i++):(n=null,s===0&&l('"!"')),n===null&&(t.charCodeAt(i)===37?(n="%",i++):(n=null,s===0&&l('"%"')),n===null&&(t.charCodeAt(i)===42?(n="*",i++):(n=null,s===0&&l('"*"')),n===null&&(t.charCodeAt(i)===95?(n="_",i++):(n=null,s===0&&l('"_"')),n===null&&(t.charCodeAt(i)===43?(n="+",i++):(n=null,s===0&&l('"+"')),n===null&&(t.charCodeAt(i)===96?(n="`",i++):(n=null,s===0&&l('"`"')),n===null&&(t.charCodeAt(i)===39?(n="'",i++):(n=null,s===0&&l('"\'"')),n===null&&(t.charCodeAt(i)===126?(n="~",i++):(n=null,s===0&&l('"~"')))))))))));if(n!==null){e=[];while(n!==null)e.push(n),n=w(),n===null&&(t.charCodeAt(i)===45?(n="-",i++):(n=null,s===0&&l('"-"')),n===null&&(t.charCodeAt(i)===33?(n="!",i++):(n=null,s===0&&l('"!"')),n===null&&(t.charCodeAt(i)===37?(n="%",i++):(n=null,s===0&&l('"%"')),n===null&&(t.charCodeAt(i)===42?(n="*",i++):(n=null,s===0&&l('"*"')),n===null&&(t.charCodeAt(i)===95?(n="_",i++):(n=null,s===0&&l('"_"')),n===null&&(t.charCodeAt(i)===43?(n="+",i++):(n=null,s===0&&l('"+"')),n===null&&(t.charCodeAt(i)===96?(n="`",i++):(n=null,s===0&&l('"`"')),n===null&&(t.charCodeAt(i)===39?(n="'",i++):(n=null,s===0&&l('"\'"')),n===null&&(t.charCodeAt(i)===126?(n="~",i++):(n=null,s===0&&l('"~"')))))))))))}else e=null;return e!==null&&(e=function(e){return t.substring(i,e)}(r)),e===null&&(i=r),e}function H(){var e;return t.charCodeAt(i)===40?(e="(",i++):(e=null,s===0&&l('"("')),e===null&&(t.charCodeAt(i)===41?(e=")",i++):(e=null,s===0&&l('")"')),e===null&&(t.charCodeAt(i)===60?(e="<",i++):(e=null,s===0&&l('"<"')),e===null&&(t.charCodeAt(i)===62?(e=">",i++):(e=null,s===0&&l('">"')),e===null&&(t.charCodeAt(i)===64?(e="@",i++):(e=null,s===0&&l('"@"')),e===null&&(t.charCodeAt(i)===44?(e=",",i++):(e=null,s===0&&l('","')),e===null&&(t.charCodeAt(i)===59?(e=";",i++):(e=null,s===0&&l('";"')),e===null&&(t.charCodeAt(i)===58?(e=":",i++):(e=null,s===0&&l('":"')),e===null&&(t.charCodeAt(i)===92?(e="\\",i++):(e=null,s===0&&l('"\\\\"')),e===null&&(e=g(),e===null&&(t.charCodeAt(i)===47?(e="/",i++):(e=null,s===0&&l('"/"')),e===null&&(t.charCodeAt(i)===91?(e="[",i++):(e=null,s===0&&l('"["')),e===null&&(t.charCodeAt(i)===93?(e="]",i++):(e=null,s===0&&l('"]"')),e===null&&(t.charCodeAt(i)===63?(e="?",i++):(e=null,s===0&&l('"?"')),e===null&&(t.charCodeAt(i)===61?(e="=",i++):(e=null,s===0&&l('"="')),e===null&&(t.charCodeAt(i)===123?(e="{",i++):(e=null,s===0&&l('"{"')),e===null&&(t.charCodeAt(i)===125?(e="}",i++):(e=null,s===0&&l('"}"')),e===null&&(e=y(),e===null&&(e=b())))))))))))))))))),e}function B(){var e,n,r;r=i,n=w(),n===null&&(t.charCodeAt(i)===45?(n="-",i++):(n=null,s===0&&l('"-"')),n===null&&(t.charCodeAt(i)===46?(n=".",i++):(n=null,s===0&&l('"."')),n===null&&(t.charCodeAt(i)===33?(n="!",i++):(n=null,s===0&&l('"!"')),n===null&&(t.charCodeAt(i)===37?(n="%",i++):(n=null,s===0&&l('"%"')),n===null&&(t.charCodeAt(i)===42?(n="*",i++):(n=null,s===0&&l('"*"')),n===null&&(t.charCodeAt(i)===95?(n="_",i++):(n=null,s===0&&l('"_"')),n===null&&(t.charCodeAt(i)===43?(n="+",i++):(n=null,s===0&&l('"+"')),n===null&&(t.charCodeAt(i)===96?(n="`",i++):(n=null,s===0&&l('"`"')),n===null&&(t.charCodeAt(i)===39?(n="'",i++):(n=null,s===0&&l('"\'"')),n===null&&(t.charCodeAt(i)===126?(n="~",i++):(n=null,s===0&&l('"~"')),n===null&&(t.charCodeAt(i)===40?(n="(",i++):(n=null,s===0&&l('"("')),n===null&&(t.charCodeAt(i)===41?(n=")",i++):(n=null,s===0&&l('")"')),n===null&&(t.charCodeAt(i)===60?(n="<",i++):(n=null,s===0&&l('"<"')),n===null&&(t.charCodeAt(i)===62?(n=">",i++):(n=null,s===0&&l('">"')),n===null&&(t.charCodeAt(i)===58?(n=":",i++):(n=null,s===0&&l('":"')),n===null&&(t.charCodeAt(i)===92?(n="\\",i++):(n=null,s===0&&l('"\\\\"')),n===null&&(n=g(),n===null&&(t.charCodeAt(i)===47?(n="/",i++):(n=null,s===0&&l('"/"')),n===null&&(t.charCodeAt(i)===91?(n="[",i++):(n=null,s===0&&l('"["')),n===null&&(t.charCodeAt(i)===93?(n="]",i++):(n=null,s===0&&l('"]"')),n===null&&(t.charCodeAt(i)===63?(n="?",i++):(n=null,s===0&&l('"?"')),n===null&&(t.charCodeAt(i)===123?(n="{",i++):(n=null,s===0&&l('"{"')),n===null&&(t.charCodeAt(i)===125?(n="}",i++):(n=null,s===0&&l('"}"')))))))))))))))))))))))));if(n!==null){e=[];while(n!==null)e.push(n),n=w(),n===null&&(t.charCodeAt(i)===45?(n="-",i++):(n=null,s===0&&l('"-"')),n===null&&(t.charCodeAt(i)===46?(n=".",i++):(n=null,s===0&&l('"."')),n===null&&(t.charCodeAt(i)===33?(n="!",i++):(n=null,s===0&&l('"!"')),n===null&&(t.charCodeAt(i)===37?(n="%",i++):(n=null,s===0&&l('"%"')),n===null&&(t.charCodeAt(i)===42?(n="*",i++):(n=null,s===0&&l('"*"')),n===null&&(t.charCodeAt(i)===95?(n="_",i++):(n=null,s===0&&l('"_"')),n===null&&(t.charCodeAt(i)===43?(n="+",i++):(n=null,s===0&&l('"+"')),n===null&&(t.charCodeAt(i)===96?(n="`",i++):(n=null,s===0&&l('"`"')),n===null&&(t.charCodeAt(i)===39?(n="'",i++):(n=null,s===0&&l('"\'"')),n===null&&(t.charCodeAt(i)===126?(n="~",i++):(n=null,s===0&&l('"~"')),n===null&&(t.charCodeAt(i)===40?(n="(",i++):(n=null,s===0&&l('"("')),n===null&&(t.charCodeAt(i)===41?(n=")",i++):(n=null,s===0&&l('")"')),n===null&&(t.charCodeAt(i)===60?(n="<",i++):(n=null,s===0&&l('"<"')),n===null&&(t.charCodeAt(i)===62?(n=">",i++):(n=null,s===0&&l('">"')),n===null&&(t.charCodeAt(i)===58?(n=":",i++):(n=null,s===0&&l('":"')),n===null&&(t.charCodeAt(i)===92?(n="\\",i++):(n=null,s===0&&l('"\\\\"')),n===null&&(n=g(),n===null&&(t.charCodeAt(i)===47?(n="/",i++):(n=null,s===0&&l('"/"')),n===null&&(t.charCodeAt(i)===91?(n="[",i++):(n=null,s===0&&l('"["')),n===null&&(t.charCodeAt(i)===93?(n="]",i++):(n=null,s===0&&l('"]"')),n===null&&(t.charCodeAt(i)===63?(n="?",i++):(n=null,s===0&&l('"?"')),n===null&&(t.charCodeAt(i)===123?(n="{",i++):(n=null,s===0&&l('"{"')),n===null&&(t.charCodeAt(i)===125?(n="}",i++):(n=null,s===0&&l('"}"')))))))))))))))))))))))))}else e=null;return e!==null&&(e=function(e){return t.substring(i,e)}(r)),e===null&&(i=r),e}function j(){var e,n,r,o,u;return o=i,u=i,e=C(),e!==null?(t.charCodeAt(i)===42?(n="*",i++):(n=null,s===0&&l('"*"')),n!==null?(r=C(),r!==null?e=[e,n,r]:(e=null,i=u)):(e=null,i=u)):(e=null,i=u),e!==null&&(e=function(e){return"*"}(o)),e===null&&(i=o),e}function F(){var e,n,r,o,u;return o=i,u=i,e=C(),e!==null?(t.charCodeAt(i)===47?(n="/",i++):(n=null,s===0&&l('"/"')),n!==null?(r=C(),r!==null?e=[e,n,r]:(e=null,i=u)):(e=null,i=u)):(e=null,i=u),e!==null&&(e=function(e){return"/"}(o)),e===null&&(i=o),e}function I(){var e,n,r,o,u;return o=i,u=i,e=C(),e!==null?(t.charCodeAt(i)===61?(n="=",i++):(n=null,s===0&&l('"="')),n!==null?(r=C(),r!==null?e=[e,n,r]:(e=null,i=u)):(e=null,i=u)):(e=null,i=u),e!==null&&(e=function(e){return"="}(o)),e===null&&(i=o),e}function q(){var e,n,r,o,u;return o=i,u=i,e=C(),e!==null?(t.charCodeAt(i)===40?(n="(",i++):(n=null,s===0&&l('"("')),n!==null?(r=C(),r!==null?e=[e,n,r]:(e=null,i=u)):(e=null,i=u)):(e=null,i=u),e!==null&&(e=function(e){return"("}(o)),e===null&&(i=o),e}function R(){var e,n,r,o,u;return o=i,u=i,e=C(),e!==null?(t.charCodeAt(i)===41?(n=")",i++):(n=null,s===0&&l('")"')),n!==null?(r=C(),r!==null?e=[e,n,r]:(e=null,i=u)):(e=null,i=u)):(e=null,i=u),e!==null&&(e=function(e){return")"}(o)),e===null&&(i=o),e}function U(){var e,n,r,o;return r=i,o=i,t.charCodeAt(i)===62?(e=">",i++):(e=null,s===0&&l('">"')),e!==null?(n=C(),n!==null?e=[e,n]:(e=null,i=o)):(e=null,i=o),e!==null&&(e=function(e){return">"}(r)),e===null&&(i=r),e}function z(){var e,n,r,o;return r=i,o=i,e=C(),e!==null?(t.charCodeAt(i)===60?(n="<",i++):(n=null,s===0&&l('"<"')),n!==null?e=[e,n]:(e=null,i=o)):(e=null,i=o),e!==null&&(e=function(e){return"<"}(r)),e===null&&(i=r),e}function W(){var e,n,r,o,u;return o=i,u=i,e=C(),e!==null?(t.charCodeAt(i)===44?(n=",",i++):(n=null,s===0&&l('","')),n!==null?(r=C(),r!==null?e=[e,n,r]:(e=null,i=u)):(e=null,i=u)):(e=null,i=u),e!==null&&(e=function(e){return","}(o)),e===null&&(i=o),e}function X(){var e,n,r,o,u;return o=i,u=i,e=C(),e!==null?(t.charCodeAt(i)===59?(n=";",i++):(n=null,s===0&&l('";"')),n!==null?(r=C(),r!==null?e=[e,n,r]:(e=null,i=u)):(e=null,i=u)):(e=null,i=u),e!==null&&(e=function(e){return";"}(o)),e===null&&(i=o),e}function V(){var e,n,r,o,u;return o=i,u=i,e=C(),e!==null?(t.charCodeAt(i)===58?(n=":",i++):(n=null,s===0&&l('":"')),n!==null?(r=C(),r!==null?e=[e,n,r]:(e=null,i=u)):(e=null,i=u)):(e=null,i=u),e!==null&&(e=function(e){return":"}(o)),e===null&&(i=o),e}function $(){var e,t,n,r;return n=i,r=i,e=C(),e!==null?(t=g(),t!==null?e=[e,t]:(e=null,i=r)):(e=null,i=r),e!==null&&(e=function(e){return'"'}(n)),e===null&&(i=n),e}function J(){var e,t,n,r;return n=i,r=i,e=g(),e!==null?(t=C(),t!==null?e=[e,t]:(e=null,i=r)):(e=null,i=r),e!==null&&(e=function(e){return'"'}(n)),e===null&&(i=n),e}function K(){var e,t,n,r;r=i,e=q();if(e!==null){t=[],n=Q(),n===null&&(n=et(),n===null&&(n=K()));while(n!==null)t.push(n),n=Q(),n===null&&(n=et(),n===null&&(n=K()));t!==null?(n=R(),n!==null?e=[e,t,n]:(e=null,i=r)):(e=null,i=r)}else e=null,i=r;return e}function Q(){var e;return/^[!-']/.test(t.charAt(i))?(e=t.charAt(i),i++):(e=null,s===0&&l("[!-']")),e===null&&(/^[*-[]/.test(t.charAt(i))?(e=t.charAt(i),i++):(e=null,s===0&&l("[*-[]")),e===null&&(/^[\]-~]/.test(t.charAt(i))?(e=t.charAt(i),i++):(e=null,s===0&&l("[\\]-~]")),e===null&&(e=O(),e===null&&(e=N())))),e}function G(){var e,n,r,s,o,u;o=i,u=i,e=C();if(e!==null){n=g();if(n!==null){r=[],s=Z(),s===null&&(s=et());while(s!==null)r.push(s),s=Z(),s===null&&(s=et());r!==null?(s=g(),s!==null?e=[e,n,r,s]:(e=null,i=u)):(e=null,i=u)}else e=null,i=u}else e=null,i=u;return e!==null&&(e=function(e){return t.substring(i,e)}(o)),e===null&&(i=o),e}function Y(){var e,n,r,s,o,u;o=i,u=i,e=C();if(e!==null){n=g();if(n!==null){r=[],s=Z(),s===null&&(s=et());while(s!==null)r.push(s),s=Z(),s===null&&(s=et());r!==null?(s=g(),s!==null?e=[e,n,r,s]:(e=null,i=u)):(e=null,i=u)}else e=null,i=u}else e=null,i=u;return e!==null&&(e=function(e){return t.substring(i-1,e+1)}(o)),e===null&&(i=o),e}function Z(){var e;return e=N(),e===null&&(t.charCodeAt(i)===33?(e="!",i++):(e=null,s===0&&l('"!"')),e===null&&(/^[#-[]/.test(t.charAt(i))?(e=t.charAt(i),i++):(e=null,s===0&&l("[#-[]")),e===null&&(/^[\]-~]/.test(t.charAt(i))?(e=t.charAt(i),i++):(e=null,s===0&&l("[\\]-~]")),e===null&&(e=O())))),e}function et(){var e,n,r;return r=i,t.charCodeAt(i)===92?(e="\\",i++):(e=null,s===0&&l('"\\\\"')),e!==null?(/^[\0-\t]/.test(t.charAt(i))?(n=t.charAt(i),i++):(n=null,s===0&&l("[\\0-\\t]")),n===null&&(/^[\x0B-\f]/.test(t.charAt(i))?(n=t.charAt(i),i++):(n=null,s===0&&l("[\\x0B-\\f]")),n===null&&(/^[\x0E-]/.test(t.charAt(i))?(n=t.charAt(i),i++):(n=null,s===0&&l("[\\x0E-]")))),n!==null?e=[e,n]:(e=null,i=r)):(e=null,i=r),e}function tt(){var e,n,r,o,u,a;return u=i,a=i,e=rt(),e!==null?(t.charCodeAt(i)===58?(n=":",i++):(n=null,s===0&&l('":"')),n!==null?(r=it(),r=r!==null?r:"",r!==null?(o=at(),o!==null?e=[e,n,r,o]:(e=null,i=a)):(e=null,i=a)):(e=null,i=a)):(e=null,i=a),e!==null&&(e=function(e){try{Li.uri=new JsSIP.URI(Li.scheme,Li.user,Li.host,Li.port),delete Li.scheme,delete Li.user,delete Li.host,delete Li.host_type,delete Li.port}catch(t){Li=-1}}(u)),e===null&&(i=u),e}function nt(){var e,r,o,u,a,f,c,h;return c=i,h=i,e=rt(),e!==null?(t.charCodeAt(i)===58?(r=":",i++):(r=null,s===0&&l('":"')),r!==null?(o=it(),o=o!==null?o:"",o!==null?(u=at(),u!==null?(a=wt(),a!==null?(f=Dt(),f=f!==null?f:"",f!==null?e=[e,r,o,u,a,f]:(e=null,i=h)):(e=null,i=h)):(e=null,i=h)):(e=null,i=h)):(e=null,i=h)):(e=null,i=h),e!==null&&(e=function(e){var t;try{Li.uri=new JsSIP.URI(Li.scheme,Li.user,Li.host,Li.port,Li.uri_params,Li.uri_headers),delete Li.scheme,delete Li.user,delete Li.host,delete Li.host_type,delete Li.port,delete Li.uri_params,n==="SIP_URI"&&(Li=Li.uri)}catch(r){Li=-1}}(c)),e===null&&(i=c),e}function rt(){var e,n;return n=i,t.substr(i,3).toLowerCase()==="sip"?(e=t.substr(i,3),i+=3):(e=null,s===0&&l('"sip"')),e!==null&&(e=function(e,t){Li.scheme=t.toLowerCase()}(n,e)),e===null&&(i=n),e}function it(){var e,n,r,o,u,a;return o=i,u=i,e=st(),e!==null?(a=i,t.charCodeAt(i)===58?(n=":",i++):(n=null,s===0&&l('":"')),n!==null?(r=ut(),r!==null?n=[n,r]:(n=null,i=a)):(n=null,i=a),n=n!==null?n:"",n!==null?(t.charCodeAt(i)===64?(r="@",i++):(r=null,s===0&&l('"@"')),r!==null?e=[e,n,r]:(e=null,i=u)):(e=null,i=u)):(e=null,i=u),e!==null&&(e=function(e){Li.user=window.decodeURIComponent(t.substring(i-1,e))}(o)),e===null&&(i=o),e}function st(){var e,t;t=S(),t===null&&(t=T(),t===null&&(t=ot()));if(t!==null){e=[];while(t!==null)e.push(t),t=S(),t===null&&(t=T(),t===null&&(t=ot()))}else e=null;return e}function ot(){var e;return t.charCodeAt(i)===38?(e="&",i++):(e=null,s===0&&l('"&"')),e===null&&(t.charCodeAt(i)===61?(e="=",i++):(e=null,s===0&&l('"="')),e===null&&(t.charCodeAt(i)===43?(e="+",i++):(e=null,s===0&&l('"+"')),e===null&&(t.charCodeAt(i)===36?(e="$",i++):(e=null,s===0&&l('"$"')),e===null&&(t.charCodeAt(i)===44?(e=",",i++):(e=null,s===0&&l('","')),e===null&&(t.charCodeAt(i)===59?(e=";",i++):(e=null,s===0&&l('";"')),e===null&&(t.charCodeAt(i)===63?(e="?",i++):(e=null,s===0&&l('"?"')),e===null&&(t.charCodeAt(i)===47?(e="/",i++):(e=null,s===0&&l('"/"'))))))))),e}function ut(){var e,n,r;r=i,e=[],n=S(),n===null&&(n=T(),n===null&&(t.charCodeAt(i)===38?(n="&",i++):(n=null,s===0&&l('"&"')),n===null&&(t.charCodeAt(i)===61?(n="=",i++):(n=null,s===0&&l('"="')),n===null&&(t.charCodeAt(i)===43?(n="+",i++):(n=null,s===0&&l('"+"')),n===null&&(t.charCodeAt(i)===36?(n="$",i++):(n=null,s===0&&l('"$"')),n===null&&(t.charCodeAt(i)===44?(n=",",i++):(n=null,s===0&&l('","'))))))));while(n!==null)e.push(n),n=S(),n===null&&(n=T(),n===null&&(t.charCodeAt(i)===38?(n="&",i++):(n=null,s===0&&l('"&"')),n===null&&(t.charCodeAt(i)===61?(n="=",i++):(n=null,s===0&&l('"="')),n===null&&(t.charCodeAt(i)===43?(n="+",i++):(n=null,s===0&&l('"+"')),n===null&&(t.charCodeAt(i)===36?(n="$",i++):(n=null,s===0&&l('"$"')),n===null&&(t.charCodeAt(i)===44?(n=",",i++):(n=null,s===0&&l('","'))))))));return e!==null&&(e=function(e){Li.password=t.substring(i,e)}(r)),e===null&&(i=r),e}function at(){var e,n,r,o,u;return o=i,e=ft(),e!==null?(u=i,t.charCodeAt(i)===58?(n=":",i++):(n=null,s===0&&l('":"')),n!==null?(r=bt(),r!==null?n=[n,r]:(n=null,i=u)):(n=null,i=u),n=n!==null?n:"",n!==null?e=[e,n]:(e=null,i=o)):(e=null,i=o),e}function ft(){var e,n;return n=i,e=lt(),e===null&&(e=gt(),e===null&&(e=pt())),e!==null&&(e=function(e){return Li.host=t.substring(i,e).toLowerCase(),Li.host}(n)),e===null&&(i=n),e}function lt(){var e,n,r,o,u,a;o=i,u=i,e=[],a=i,n=ct(),n!==null?(t.charCodeAt(i)===46?(r=".",i++):(r=null,s===0&&l('"."')),r!==null?n=[n,r]:(n=null,i=a)):(n=null,i=a);while(n!==null)e.push(n),a=i,n=ct(),n!==null?(t.charCodeAt(i)===46?(r=".",i++):(r=null,s===0&&l('"."')),r!==null?n=[n,r]:(n=null,i=a)):(n=null,i=a);return e!==null?(n=ht(),n!==null?(t.charCodeAt(i)===46?(r=".",i++):(r=null,s===0&&l('"."')),r=r!==null?r:"",r!==null?e=[e,n,r]:(e=null,i=u)):(e=null,i=u)):(e=null,i=u),e!==null&&(e=function(e){return Li.host_type="domain",t.substring(i,e)}(o)),e===null&&(i=o),e}function ct(){var e,n;/^[a-zA-Z0-9_\-]/.test(t.charAt(i))?(n=t.charAt(i),i++):(n=null,s===0&&l("[a-zA-Z0-9_\\-]"));if(n!==null){e=[];while(n!==null)e.push(n),/^[a-zA-Z0-9_\-]/.test(t.charAt(i))?(n=t.charAt(i),i++):(n=null,s===0&&l("[a-zA-Z0-9_\\-]"))}else e=null;return e}function ht(){var e,n;/^[a-zA-Z_\-]/.test(t.charAt(i))?(n=t.charAt(i),i++):(n=null,s===0&&l("[a-zA-Z_\\-]"));if(n!==null){e=[];while(n!==null)e.push(n),/^[a-zA-Z_\-]/.test(t.charAt(i))?(n=t.charAt(i),i++):(n=null,s===0&&l("[a-zA-Z_\\-]"))}else e=null;return e}function pt(){var e,n,r,o,u;return o=i,u=i,t.charCodeAt(i)===91?(e="[",i++):(e=null,s===0&&l('"["')),e!==null?(n=dt(),n!==null?(t.charCodeAt(i)===93?(r="]",i++):(r=null,s===0&&l('"]"')),r!==null?e=[e,n,r]:(e=null,i=u)):(e=null,i=u)):(e=null,i=u),e!==null&&(e=function(e){return Li.host_type="IPv6",t.substring(i,e)}(o)),e===null&&(i=o),e}function dt(){var e,n,r,o,u,a,f,c,h,p,d,v,m,g,y,b;return g=i,y=i,e=vt(),e!==null?(t.charCodeAt(i)===58?(n=":",i++):(n=null,s===0&&l('":"')),n!==null?(r=vt(),r!==null?(t.charCodeAt(i)===58?(o=":",i++):(o=null,s===0&&l('":"')),o!==null?(u=vt(),u!==null?(t.charCodeAt(i)===58?(a=":",i++):(a=null,s===0&&l('":"')),a!==null?(f=vt(),f!==null?(t.charCodeAt(i)===58?(c=":",i++):(c=null,s===0&&l('":"')),c!==null?(h=vt(),h!==null?(t.charCodeAt(i)===58?(p=":",i++):(p=null,s===0&&l('":"')),p!==null?(d=vt(),d!==null?(t.charCodeAt(i)===58?(v=":",i++):(v=null,s===0&&l('":"')),v!==null?(m=mt(),m!==null?e=[e,n,r,o,u,a,f,c,h,p,d,v,m]:(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y),e===null&&(y=i,t.substr(i,2)==="::"?(e="::",i+=2):(e=null,s===0&&l('"::"')),e!==null?(n=vt(),n!==null?(t.charCodeAt(i)===58?(r=":",i++):(r=null,s===0&&l('":"')),r!==null?(o=vt(),o!==null?(t.charCodeAt(i)===58?(u=":",i++):(u=null,s===0&&l('":"')),u!==null?(a=vt(),a!==null?(t.charCodeAt(i)===58?(f=":",i++):(f=null,s===0&&l('":"')),f!==null?(c=vt(),c!==null?(t.charCodeAt(i)===58?(h=":",i++):(h=null,s===0&&l('":"')),h!==null?(p=vt(),p!==null?(t.charCodeAt(i)===58?(d=":",i++):(d=null,s===0&&l('":"')),d!==null?(v=mt(),v!==null?e=[e,n,r,o,u,a,f,c,h,p,d,v]:(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y),e===null&&(y=i,t.substr(i,2)==="::"?(e="::",i+=2):(e=null,s===0&&l('"::"')),e!==null?(n=vt(),n!==null?(t.charCodeAt(i)===58?(r=":",i++):(r=null,s===0&&l('":"')),r!==null?(o=vt(),o!==null?(t.charCodeAt(i)===58?(u=":",i++):(u=null,s===0&&l('":"')),u!==null?(a=vt(),a!==null?(t.charCodeAt(i)===58?(f=":",i++):(f=null,s===0&&l('":"')),f!==null?(c=vt(),c!==null?(t.charCodeAt(i)===58?(h=":",i++):(h=null,s===0&&l('":"')),h!==null?(p=mt(),p!==null?e=[e,n,r,o,u,a,f,c,h,p]:(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y),e===null&&(y=i,t.substr(i,2)==="::"?(e="::",i+=2):(e=null,s===0&&l('"::"')),e!==null?(n=vt(),n!==null?(t.charCodeAt(i)===58?(r=":",i++):(r=null,s===0&&l('":"')),r!==null?(o=vt(),o!==null?(t.charCodeAt(i)===58?(u=":",i++):(u=null,s===0&&l('":"')),u!==null?(a=vt(),a!==null?(t.charCodeAt(i)===58?(f=":",i++):(f=null,s===0&&l('":"')),f!==null?(c=mt(),c!==null?e=[e,n,r,o,u,a,f,c]:(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y),e===null&&(y=i,t.substr(i,2)==="::"?(e="::",i+=2):(e=null,s===0&&l('"::"')),e!==null?(n=vt(),n!==null?(t.charCodeAt(i)===58?(r=":",i++):(r=null,s===0&&l('":"')),r!==null?(o=vt(),o!==null?(t.charCodeAt(i)===58?(u=":",i++):(u=null,s===0&&l('":"')),u!==null?(a=mt(),a!==null?e=[e,n,r,o,u,a]:(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y),e===null&&(y=i,t.substr(i,2)==="::"?(e="::",i+=2):(e=null,s===0&&l('"::"')),e!==null?(n=vt(),n!==null?(t.charCodeAt(i)===58?(r=":",i++):(r=null,s===0&&l('":"')),r!==null?(o=mt(),o!==null?e=[e,n,r,o]:(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y),e===null&&(y=i,t.substr(i,2)==="::"?(e="::",i+=2):(e=null,s===0&&l('"::"')),e!==null?(n=mt(),n!==null?e=[e,n]:(e=null,i=y)):(e=null,i=y),e===null&&(y=i,t.substr(i,2)==="::"?(e="::",i+=2):(e=null,s===0&&l('"::"')),e!==null?(n=vt(),n!==null?e=[e,n]:(e=null,i=y)):(e=null,i=y),e===null&&(y=i,e=vt(),e!==null?(t.substr(i,2)==="::"?(n="::",i+=2):(n=null,s===0&&l('"::"')),n!==null?(r=vt(),r!==null?(t.charCodeAt(i)===58?(o=":",i++):(o=null,s===0&&l('":"')),o!==null?(u=vt(),u!==null?(t.charCodeAt(i)===58?(a=":",i++):(a=null,s===0&&l('":"')),a!==null?(f=vt(),f!==null?(t.charCodeAt(i)===58?(c=":",i++):(c=null,s===0&&l('":"')),c!==null?(h=vt(),h!==null?(t.charCodeAt(i)===58?(p=":",i++):(p=null,s===0&&l('":"')),p!==null?(d=mt(),d!==null?e=[e,n,r,o,u,a,f,c,h,p,d]:(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y),e===null&&(y=i,e=vt(),e!==null?(b=i,t.charCodeAt(i)===58?(n=":",i++):(n=null,s===0&&l('":"')),n!==null?(r=vt(),r!==null?n=[n,r]:(n=null,i=b)):(n=null,i=b),n=n!==null?n:"",n!==null?(t.substr(i,2)==="::"?(r="::",i+=2):(r=null,s===0&&l('"::"')),r!==null?(o=vt(),o!==null?(t.charCodeAt(i)===58?(u=":",i++):(u=null,s===0&&l('":"')),u!==null?(a=vt(),a!==null?(t.charCodeAt(i)===58?(f=":",i++):(f=null,s===0&&l('":"')),f!==null?(c=vt(),c!==null?(t.charCodeAt(i)===58?(h=":",i++):(h=null,s===0&&l('":"')),h!==null?(p=mt(),p!==null?e=[e,n,r,o,u,a,f,c,h,p]:(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y),e===null&&(y=i,e=vt(),e!==null?(b=i,t.charCodeAt(i)===58?(n=":",i++):(n=null,s===0&&l('":"')),n!==null?(r=vt(),r!==null?n=[n,r]:(n=null,i=b)):(n=null,i=b),n=n!==null?n:"",n!==null?(b=i,t.charCodeAt(i)===58?(r=":",i++):(r=null,s===0&&l('":"')),r!==null?(o=vt(),o!==null?r=[r,o]:(r=null,i=b)):(r=null,i=b),r=r!==null?r:"",r!==null?(t.substr(i,2)==="::"?(o="::",i+=2):(o=null,s===0&&l('"::"')),o!==null?(u=vt(),u!==null?(t.charCodeAt(i)===58?(a=":",i++):(a=null,s===0&&l('":"')),a!==null?(f=vt(),f!==null?(t.charCodeAt(i)===58?(c=":",i++):(c=null,s===0&&l('":"')),c!==null?(h=mt(),h!==null?e=[e,n,r,o,u,a,f,c,h]:(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y),e===null&&(y=i,e=vt(),e!==null?(b=i,t.charCodeAt(i)===58?(n=":",i++):(n=null,s===0&&l('":"')),n!==null?(r=vt(),r!==null?n=[n,r]:(n=null,i=b)):(n=null,i=b),n=n!==null?n:"",n!==null?(b=i,t.charCodeAt(i)===58?(r=":",i++):(r=null,s===0&&l('":"')),r!==null?(o=vt(),o!==null?r=[r,o]:(r=null,i=b)):(r=null,i=b),r=r!==null?r:"",r!==null?(b=i,t.charCodeAt(i)===58?(o=":",i++):(o=null,s===0&&l('":"')),o!==null?(u=vt(),u!==null?o=[o,u]:(o=null,i=b)):(o=null,i=b),o=o!==null?o:"",o!==null?(t.substr(i,2)==="::"?(u="::",i+=2):(u=null,s===0&&l('"::"')),u!==null?(a=vt(),a!==null?(t.charCodeAt(i)===58?(f=":",i++):(f=null,s===0&&l('":"')),f!==null?(c=mt(),c!==null?e=[e,n,r,o,u,a,f,c]:(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y),e===null&&(y=i,e=vt(),e!==null?(b=i,t.charCodeAt(i)===58?(n=":",i++):(n=null,s===0&&l('":"')),n!==null?(r=vt(),r!==null?n=[n,r]:(n=null,i=b)):(n=null,i=b),n=n!==null?n:"",n!==null?(b=i,t.charCodeAt(i)===58?(r=":",i++):(r=null,s===0&&l('":"')),r!==null?(o=vt(),o!==null?r=[r,o]:(r=null,i=b)):(r=null,i=b),r=r!==null?r:"",r!==null?(b=i,t.charCodeAt(i)===58?(o=":",i++):(o=null,s===0&&l('":"')),o!==null?(u=vt(),u!==null?o=[o,u]:(o=null,i=b)):(o=null,i=b),o=o!==null?o:"",o!==null?(b=i,t.charCodeAt(i)===58?(u=":",i++):(u=null,s===0&&l('":"')),u!==null?(a=vt(),a!==null?u=[u,a]:(u=null,i=b)):(u=null,i=b),u=u!==null?u:"",u!==null?(t.substr(i,2)==="::"?(a="::",i+=2):(a=null,s===0&&l('"::"')),a!==null?(f=mt(),f!==null?e=[e,n,r,o,u,a,f]:(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y),e===null&&(y=i,e=vt(),e!==null?(b=i,t.charCodeAt(i)===58?(n=":",i++):(n=null,s===0&&l('":"')),n!==null?(r=vt(),r!==null?n=[n,r]:(n=null,i=b)):(n=null,i=b),n=n!==null?n:"",n!==null?(b=i,t.charCodeAt(i)===58?(r=":",i++):(r=null,s===0&&l('":"')),r!==null?(o=vt(),o!==null?r=[r,o]:(r=null,i=b)):(r=null,i=b),r=r!==null?r:"",r!==null?(b=i,t.charCodeAt(i)===58?(o=":",i++):(o=null,s===0&&l('":"')),o!==null?(u=vt(),u!==null?o=[o,u]:(o=null,i=b)):(o=null,i=b),o=o!==null?o:"",o!==null?(b=i,t.charCodeAt(i)===58?(u=":",i++):(u=null,s===0&&l('":"')),u!==null?(a=vt(),a!==null?u=[u,a]:(u=null,i=b)):(u=null,i=b),u=u!==null?u:"",u!==null?(b=i,t.charCodeAt(i)===58?(a=":",i++):(a=null,s===0&&l('":"')),a!==null?(f=vt(),f!==null?a=[a,f]:(a=null,i=b)):(a=null,i=b),a=a!==null?a:"",a!==null?(t.substr(i,2)==="::"?(f="::",i+=2):(f=null,s===0&&l('"::"')),f!==null?(c=vt(),c!==null?e=[e,n,r,o,u,a,f,c]:(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y),e===null&&(y=i,e=vt(),e!==null?(b=i,t.charCodeAt(i)===58?(n=":",i++):(n=null,s===0&&l('":"')),n!==null?(r=vt(),r!==null?n=[n,r]:(n=null,i=b)):(n=null,i=b),n=n!==null?n:"",n!==null?(b=i,t.charCodeAt(i)===58?(r=":",i++):(r=null,s===0&&l('":"')),r!==null?(o=vt(),o!==null?r=[r,o]:(r=null,i=b)):(r=null,i=b),r=r!==null?r:"",r!==null?(b=i,t.charCodeAt(i)===58?(o=":",i++):(o=null,s===0&&l('":"')),o!==null?(u=vt(),u!==null?o=[o,u]:(o=null,i=b)):(o=null,i=b),o=o!==null?o:"",o!==null?(b=i,t.charCodeAt(i)===58?(u=":",i++):(u=null,s===0&&l('":"')),u!==null?(a=vt(),a!==null?u=[u,a]:(u=null,i=b)):(u=null,i=b),u=u!==null?u:"",u!==null?(b=i,t.charCodeAt(i)===58?(a=":",i++):(a=null,s===0&&l('":"')),a!==null?(f=vt(),f!==null?a=[a,f]:(a=null,i=b)):(a=null,i=b),a=a!==null?a:"",a!==null?(b=i,t.charCodeAt(i)===58?(f=":",i++):(f=null,s===0&&l('":"')),f!==null?(c=vt(),c!==null?f=[f,c]:(f=null,i=b)):(f=null,i=b),f=f!==null?f:"",f!==null?(t.substr(i,2)==="::"?(c="::",i+=2):(c=null,s===0&&l('"::"')),c!==null?e=[e,n,r,o,u,a,f,c]:(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y)):(e=null,i=y))))))))))))))),e!==null&&(e=function(e){return Li.host_type="IPv6",t.substring(i,e)}(g)),e===null&&(i=g),e}function vt(){var e,t,n,r,s;return s=i,e=d(),e!==null?(t=d(),t=t!==null?t:"",t!==null?(n=d(),n=n!==null?n:"",n!==null?(r=d(),r=r!==null?r:"",r!==null?e=[e,t,n,r]:(e=null,i=s)):(e=null,i=s)):(e=null,i=s)):(e=null,i=s),e}function mt(){var e,n,r,o;return o=i,e=vt(),e!==null?(t.charCodeAt(i)===58?(n=":",i++):(n=null,s===0&&l('":"')),n!==null?(r=vt(),r!==null?e=[e,n,r]:(e=null,i=o)):(e=null,i=o)):(e=null,i=o),e===null&&(e=gt()),e}function gt(){var e,n,r,o,u,a,f,c,h;return c=i,h=i,e=yt(),e!==null?(t.charCodeAt(i)===46?(n=".",i++):(n=null,s===0&&l('"."')),n!==null?(r=yt(),r!==null?(t.charCodeAt(i)===46?(o=".",i++):(o=null,s===0&&l('"."')),o!==null?(u=yt(),u!==null?(t.charCodeAt(i)===46?(a=".",i++):(a=null,s===0&&l('"."')),a!==null?(f=yt(),f!==null?e=[e,n,r,o,u,a,f]:(e=null,i=h)):(e=null,i=h)):(e=null,i=h)):(e=null,i=h)):(e=null,i=h)):(e=null,i=h)):(e=null,i=h),e!==null&&(e=function(e){return Li.host_type="IPv4",t.substring(i,e)}(c)),e===null&&(i=c),e}function yt(){var e,n,r,o;return o=i,t.substr(i,2)==="25"?(e="25",i+=2):(e=null,s===0&&l('"25"')),e!==null?(/^[0-5]/.test(t.charAt(i))?(n=t.charAt(i),i++):(n=null,s===0&&l("[0-5]")),n!==null?e=[e,n]:(e=null,i=o)):(e=null,i=o),e===null&&(o=i,t.charCodeAt(i)===50?(e="2",i++):(e=null,s===0&&l('"2"')),e!==null?(/^[0-4]/.test(t.charAt(i))?(n=t.charAt(i),i++):(n=null,s===0&&l("[0-4]")),n!==null?(r=h(),r!==null?e=[e,n,r]:(e=null,i=o)):(e=null,i=o)):(e=null,i=o),e===null&&(o=i,t.charCodeAt(i)===49?(e="1",i++):(e=null,s===0&&l('"1"')),e!==null?(n=h(),n!==null?(r=h(),r!==null?e=[e,n,r]:(e=null,i=o)):(e=null,i=o)):(e=null,i=o),e===null&&(o=i,/^[1-9]/.test(t.charAt(i))?(e=t.charAt(i),i++):(e=null,s===0&&l("[1-9]")),e!==null?(n=h(),n!==null?e=[e,n]:(e=null,i=o)):(e=null,i=o),e===null&&(e=h())))),e}function bt(){var e,t,n,r,s,o,u;return o=i,u=i,e=h(),e=e!==null?e:"",e!==null?(t=h(),t=t!==null?t:"",t!==null?(n=h(),n=n!==null?n:"",n!==null?(r=h(),r=r!==null?r:"",r!==null?(s=h(),s=s!==null?s:"",s!==null?e=[e,t,n,r,s]:(e=null,i=u)):(e=null,i=u)):(e=null,i=u)):(e=null,i=u)):(e=null,i=u),e!==null&&(e=function(e,t){return t=parseInt(t.join("")),Li.port=t,t}(o,e)),e===null&&(i=o),e}function wt(){var e,n,r,o;e=[],o=i,t.charCodeAt(i)===59?(n=";",i++):(n=null,s===0&&l('";"')),n!==null?(r=Et(),r!==null?n=[n,r]:(n=null,i=o)):(n=null,i=o);while(n!==null)e.push(n),o=i,t.charCodeAt(i)===59?(n=";",i++):(n=null,s===0&&l('";"')),n!==null?(r=Et(),r!==null?n=[n,r]:(n=null,i=o)):(n=null,i=o);return e}function Et(){var e;return e=St(),e===null&&(e=xt(),e===null&&(e=Tt(),e===null&&(e=Nt(),e===null&&(e=Ct(),e===null&&(e=kt(),e===null&&(e=Lt())))))),e}function St(){var e,n,r,o;return r=i,o=i,t.substr(i,10).toLowerCase()==="transport="?(e=t.substr(i,10),i+=10):(e=null,s===0&&l('"transport="')),e!==null?(t.substr(i,3).toLowerCase()==="udp"?(n=t.substr(i,3),i+=3):(n=null,s===0&&l('"udp"')),n===null&&(t.substr(i,3).toLowerCase()==="tcp"?(n=t.substr(i,3),i+=3):(n=null,s===0&&l('"tcp"')),n===null&&(t.substr(i,4).toLowerCase()==="sctp"?(n=t.substr(i,4),i+=4):(n=null,s===0&&l('"sctp"')),n===null&&(t.substr(i,3).toLowerCase()==="tls"?(n=t.substr(i,3),i+=3):(n=null,s===0&&l('"tls"')),n===null&&(n=D())))),n!==null?e=[e,n]:(e=null,i=o)):(e=null,i=o),e!==null&&(e=function(e,t){Li.uri_params||(Li.uri_params={}),Li.uri_params.transport=t.toLowerCase()}(r,e[1])),e===null&&(i=r),e}function xt(){var e,n,r,o;return r=i,o=i,t.substr(i,5).toLowerCase()==="user="?(e=t.substr(i,5),i+=5):(e=null,s===0&&l('"user="')),e!==null?(t.substr(i,5).toLowerCase()==="phone"?(n=t.substr(i,5),i+=5):(n=null,s===0&&l('"phone"')),n===null&&(t.substr(i,2).toLowerCase()==="ip"?(n=t.substr(i,2),i+=2):(n=null,s===0&&l('"ip"')),n===null&&(n=D())),n!==null?e=[e,n]:(e=null,i=o)):(e=null,i=o),e!==null&&(e=function(e,t){Li.uri_params||(Li.uri_params={}),Li.uri_params.user=t.toLowerCase()}(r,e[1])),e===null&&(i=r),e}function Tt(){var e,n,r,o;return r=i,o=i,t.substr(i,7).toLowerCase()==="method="?(e=t.substr(i,7),i+=7):(e=null,s===0&&l('"method="')),e!==null?(n=pn(),n!==null?e=[e,n]:(e=null,i=o)):(e=null,i=o),e!==null&&(e=function(e,t){Li.uri_params||(Li.uri_params={}),Li.uri_params.method=t}(r,e[1])),e===null&&(i=r),e}function Nt(){var e,n,r,o;return r=i,o=i,t.substr(i,4).toLowerCase()==="ttl="?(e=t.substr(i,4),i+=4):(e=null,s===0&&l('"ttl="')),e!==null?(n=ui(),n!==null?e=[e,n]:(e=null,i=o)):(e=null,i=o),e!==null&&(e=function(e,t){Li.params||(Li.params={}),Li.params.ttl=t}(r,e[1])),e===null&&(i=r),e}function Ct(){var e,n,r,o;return r=i,o=i,t.substr(i,6).toLowerCase()==="maddr="?(e=t.substr(i,6),i+=6):(e=null,s===0&&l('"maddr="')),e!==null?(n=ft(),n!==null?e=[e,n]:(e=null,i=o)):(e=null,i=o),e!==null&&(e=function(e,t){Li.uri_params||(Li.uri_params={}),Li.uri_params.maddr=t}(r,e[1])),e===null&&(i=r),e}function kt(){var e,n,r,o,u,a;return o=i,u=i,t.substr(i,2).toLowerCase()==="lr"?(e=t.substr(i,2),i+=2):(e=null,s===0&&l('"lr"')),e!==null?(a=i,t.charCodeAt(i)===61?(n="=",i++):(n=null,s===0&&l('"="')),n!==null?(r=D(),r!==null?n=[n,r]:(n=null,i=a)):(n=null,i=a),n=n!==null?n:"",n!==null?e=[e,n]:(e=null,i=u)):(e=null,i=u),e!==null&&(e=function(e){Li.uri_params||(Li.uri_params={}),Li.uri_params.lr=undefined}(o)),e===null&&(i=o),e}function Lt(){var e,n,r,o,u,a;return o=i,u=i,e=At(),e!==null?(a=i,t.charCodeAt(i)===61?(n="=",i++):(n=null,s===0&&l('"="')),n!==null?(r=Ot(),r!==null?n=[n,r]:(n=null,i=a)):(n=null,i=a),n=n!==null?n:"",n!==null?e=[e,n]:(e=null,i=u)):(e=null,i=u),e!==null&&(e=function(e,t,n){Li.uri_params||(Li.uri_params={}),typeof n=="undefined"?n=undefined:n=n[1],Li.uri_params[t.toLowerCase()]=n&&n.toLowerCase()}(o,e[0],e[1])),e===null&&(i=o),e}function At(){var e,t,n;n=i,t=Mt();if(t!==null){e=[];while(t!==null)e.push(t),t=Mt()}else e=null;return e!==null&&(e=function(e,t){return t.join("")}(n,e)),e===null&&(i=n),e}function Ot(){var e,t,n;n=i,t=Mt();if(t!==null){e=[];while(t!==null)e.push(t),t=Mt()}else e=null;return e!==null&&(e=function(e,t){return t.join("")}(n,e)),e===null&&(i=n),e}function Mt(){var e;return e=_t(),e===null&&(e=S(),e===null&&(e=T())),e}function _t(){var e;return t.charCodeAt(i)===91?(e="[",i++):(e=null,s===0&&l('"["')),e===null&&(t.charCodeAt(i)===93?(e="]",i++):(e=null,s===0&&l('"]"')),e===null&&(t.charCodeAt(i)===47?(e="/",i++):(e=null,s===0&&l('"/"')),e===null&&(t.charCodeAt(i)===58?(e=":",i++):(e=null,s===0&&l('":"')),e===null&&(t.charCodeAt(i)===38?(e="&",i++):(e=null,s===0&&l('"&"')),e===null&&(t.charCodeAt(i)===43?(e="+",i++):(e=null,s===0&&l('"+"')),e===null&&(t.charCodeAt(i)===36?(e="$",i++):(e=null,s===0&&l('"$"')))))))),e}function Dt(){var e,n,r,o,u,a,f;a=i,t.charCodeAt(i)===63?(e="?",i++):(e=null,s===0&&l('"?"'));if(e!==null){n=Pt();if(n!==null){r=[],f=i,t.charCodeAt(i)===38?(o="&",i++):(o=null,s===0&&l('"&"')),o!==null?(u=Pt(),u!==null?o=[o,u]:(o=null,i=f)):(o=null,i=f);while(o!==null)r.push(o),f=i,t.charCodeAt(i)===38?(o="&",i++):(o=null,s===0&&l('"&"')),o!==null?(u=Pt(),u!==null?o=[o,u]:(o=null,i=f)):(o=null,i=f);r!==null?e=[e,n,r]:(e=null,i=a)}else e=null,i=a}else e=null,i=a;return e}function Pt(){var e,n,r,o,u;return o=i,u=i,e=Ht(),e!==null?(t.charCodeAt(i)===61?(n="=",i++):(n=null,s===0&&l('"="')),n!==null?(r=Bt(),r!==null?e=[e,n,r]:(e=null,i=u)):(e=null,i=u)):(e=null,i=u),e!==null&&(e=function(e,t,n){t=t.join("").toLowerCase(),n=n.join(""),Li.uri_headers||(Li.uri_headers={}),Li.uri_headers[t]?Li.uri_headers[t].push(n):Li.uri_headers[t]=[n]}(o,e[0],e[2])),e===null&&(i=o),e}function Ht(){var e,t;t=jt(),t===null&&(t=S(),t===null&&(t=T()));if(t!==null){e=[];while(t!==null)e.push(t),t=jt(),t===null&&(t=S(),t===null&&(t=T()))}else e=null;return e}function Bt(){var e,t;e=[],t=jt(),t===null&&(t=S(),t===null&&(t=T()));while(t!==null)e.push(t),t=jt(),t===null&&(t=S(),t===null&&(t=T()));return e}function jt(){var e;return t.charCodeAt(i)===91?(e="[",i++):(e=null,s===0&&l('"["')),e===null&&(t.charCodeAt(i)===93?(e="]",i++):(e=null,s===0&&l('"]"')),e===null&&(t.charCodeAt(i)===47?(e="/",i++):(e=null,s===0&&l('"/"')),e===null&&(t.charCodeAt(i)===63?(e="?",i++):(e=null,s===0&&l('"?"')),e===null&&(t.charCodeAt(i)===58?(e=":",i++):(e=null,s===0&&l('":"')),e===null&&(t.charCodeAt(i)===43?(e="+",i++):(e=null,s===0&&l('"+"')),e===null&&(t.charCodeAt(i)===36?(e="$",i++):(e=null,s===0&&l('"$"')))))))),e}function Ft(){var e;return e=dn(),e===null&&(e=It()),e}function It(){var e,t,n,r,s,o;return o=i,e=pn(),e!==null?(t=y(),t!==null?(n=qt(),n!==null?(r=y(),r!==null?(s=rn(),s!==null?e=[e,t,n,r,s]:(e=null,i=o)):(e=null,i=o)):(e=null,i=o)):(e=null,i=o)):(e=null,i=o),e}function qt(){var e;return e=nt(),e===null&&(e=Rt()),e}function Rt(){var e,n,r,o;return o=i,e=Yt(),e!==null?(t.charCodeAt(i)===58?(n=":",i++):(n=null,s===0&&l('":"')),n!==null?(r=Ut(),r===null&&(r=Xt()),r!==null?e=[e,n,r]:(e=null,i=o)):(e=null,i=o)):(e=null,i=o),e}function Ut(){var e,n,r,o,u;return o=i,e=zt(),e===null&&(e=Wt()),e!==null?(u=i,t.charCodeAt(i)===63?(n="?",i++):(n=null,s===0&&l('"?"')),n!==null?(r=nn(),r!==null?n=[n,r]:(n=null,i=u)):(n=null,i=u),n=n!==null?n:"",n!==null?e=[e,n]:(e=null,i=o)):(e=null,i=o),e}function zt(){var e,n,r,o;return o=i,t.substr(i,2)==="//"?(e="//",i+=2):(e=null,s===0&&l('"//"')),e!==null?(n=Zt(),n!==null?(r=Wt(),r=r!==null?r:"",r!==null?e=[e,n,r]:(e=null,i=o)):(e=null,i=o)):(e=null,i=o),e}function Wt(){var e,n,r;return r=i,t.charCodeAt(i)===47?(e="/",i++):(e=null,s===0&&l('"/"')),e!==null?(n=Jt(),n!==null?e=[e,n]:(e=null,i=r)):(e=null,i=r),e}function Xt(){var e,t,n,r;r=i,e=$t();if(e!==null){t=[],n=Vt();while(n!==null)t.push(n),n=Vt();t!==null?e=[e,t]:(e=null,i=r)}else e=null,i=r;return e}function Vt(){var e;return e=E(),e===null&&(e=S(),e===null&&(e=T())),e}function $t(){var e;return e=S(),e===null&&(e=T(),e===null&&(t.charCodeAt(i)===59?(e=";",i++):(e=null,s===0&&l('";"')),e===null&&(t.charCodeAt(i)===63?(e="?",i++):(e=null,s===0&&l('"?"')),e===null&&(t.charCodeAt(i)===58?(e=":",i++):(e=null,s===0&&l('":"')),e===null&&(t.charCodeAt(i)===64?(e="@",i++):(e=null,s===0&&l('"@"')),e===null&&(t.charCodeAt(i)===38?(e="&",i++):(e=null,s===0&&l('"&"')),e===null&&(t.charCodeAt(i)===61?(e="=",i++):(e=null,s===0&&l('"="')),e===null&&(t.charCodeAt(i)===43?(e="+",i++):(e=null,s===0&&l('"+"')),e===null&&(t.charCodeAt(i)===36?(e="$",i++):(e=null,s===0&&l('"$"')),e===null&&(t.charCodeAt(i)===44?(e=",",i++):(e=null,s===0&&l('","')))))))))))),e}function Jt(){var e,n,r,o,u,a;u=i,e=Kt();if(e!==null){n=[],a=i,t.charCodeAt(i)===47?(r="/",i++):(r=null,s===0&&l('"/"')),r!==null?(o=Kt(),o!==null?r=[r,o]:(r=null,i=a)):(r=null,i=a);while(r!==null)n.push(r),a=i,t.charCodeAt(i)===47?(r="/",i++):(r=null,s===0&&l('"/"')),r!==null?(o=Kt(),o!==null?r=[r,o]:(r=null,i=a)):(r=null,i=a);n!==null?e=[e,n]:(e=null,i=u)}else e=null,i=u;return e}function Kt(){var e,n,r,o,u,a;u=i,e=[],n=Gt();while(n!==null)e.push(n),n=Gt();if(e!==null){n=[],a=i,t.charCodeAt(i)===59?(r=";",i++):(r=null,s===0&&l('";"')),r!==null?(o=Qt(),o!==null?r=[r,o]:(r=null,i=a)):(r=null,i=a);while(r!==null)n.push(r),a=i,t.charCodeAt(i)===59?(r=";",i++):(r=null,s===0&&l('";"')),r!==null?(o=Qt(),o!==null?r=[r,o]:(r=null,i=a)):(r=null,i=a);n!==null?e=[e,n]:(e=null,i=u)}else e=null,i=u;return e}function Qt(){var e,t;e=[],t=Gt();while(t!==null)e.push(t),t=Gt();return e}function Gt(){var e;return e=S(),e===null&&(e=T(),e===null&&(t.charCodeAt(i)===58?(e=":",i++):(e=null,s===0&&l('":"')),e===null&&(t.charCodeAt(i)===64?(e="@",i++):(e=null,s===0&&l('"@"')),e===null&&(t.charCodeAt(i)===38?(e="&",i++):(e=null,s===0&&l('"&"')),e===null&&(t.charCodeAt(i)===61?(e="=",i++):(e=null,s===0&&l('"="')),e===null&&(t.charCodeAt(i)===43?(e="+",i++):(e=null,s===0&&l('"+"')),e===null&&(t.charCodeAt(i)===36?(e="$",i++):(e=null,s===0&&l('"$"')),e===null&&(t.charCodeAt(i)===44?(e=",",i++):(e=null,s===0&&l('","')))))))))),e}function Yt(){var e,n,r,o,u;o=i,u=i,e=p();if(e!==null){n=[],r=p(),r===null&&(r=h(),r===null&&(t.charCodeAt(i)===43?(r="+",i++):(r=null,s===0&&l('"+"')),r===null&&(t.charCodeAt(i)===45?(r="-",i++):(r=null,s===0&&l('"-"')),r===null&&(t.charCodeAt(i)===46?(r=".",i++):(r=null,s===0&&l('"."'))))));while(r!==null)n.push(r),r=p(),r===null&&(r=h(),r===null&&(t.charCodeAt(i)===43?(r="+",i++):(r=null,s===0&&l('"+"')),r===null&&(t.charCodeAt(i)===45?(r="-",i++):(r=null,s===0&&l('"-"')),r===null&&(t.charCodeAt(i)===46?(r=".",i++):(r=null,s===0&&l('"."'))))));n!==null?e=[e,n]:(e=null,i=u)}else e=null,i=u;return e!==null&&(e=function(e){Li.scheme=t.substring(i,e)}(o)),e===null&&(i=o),e}function Zt(){var e;return e=en(),e===null&&(e=tn()),e}function en(){var e,n,r,o;return r=i,o=i,e=it(),e!==null?(t.charCodeAt(i)===64?(n="@",i++):(n=null,s===0&&l('"@"')),n!==null?e=[e,n]:(e=null,i=o)):(e=null,i=o),e=e!==null?e:"",e!==null?(n=at(),n!==null?e=[e,n]:(e=null,i=r)):(e=null,i=r),e=e!==null?e:"",e}function tn(){var e,n;n=S(),n===null&&(n=T(),n===null&&(t.charCodeAt(i)===36?(n="$",i++):(n=null,s===0&&l('"$"')),n===null&&(t.charCodeAt(i)===44?(n=",",i++):(n=null,s===0&&l('","')),n===null&&(t.charCodeAt(i)===59?(n=";",i++):(n=null,s===0&&l('";"')),n===null&&(t.charCodeAt(i)===58?(n=":",i++):(n=null,s===0&&l('":"')),n===null&&(t.charCodeAt(i)===64?(n="@",i++):(n=null,s===0&&l('"@"')),n===null&&(t.charCodeAt(i)===38?(n="&",i++):(n=null,s===0&&l('"&"')),n===null&&(t.charCodeAt(i)===61?(n="=",i++):(n=null,s===0&&l('"="')),n===null&&(t.charCodeAt(i)===43?(n="+",i++):(n=null,s===0&&l('"+"')))))))))));if(n!==null){e=[];while(n!==null)e.push(n),n=S(),n===null&&(n=T(),n===null&&(t.charCodeAt(i)===36?(n="$",i++):(n=null,s===0&&l('"$"')),n===null&&(t.charCodeAt(i)===44?(n=",",i++):(n=null,s===0&&l('","')),n===null&&(t.charCodeAt(i)===59?(n=";",i++):(n=null,s===0&&l('";"')),n===null&&(t.charCodeAt(i)===58?(n=":",i++):(n=null,s===0&&l('":"')),n===null&&(t.charCodeAt(i)===64?(n="@",i++):(n=null,s===0&&l('"@"')),n===null&&(t.charCodeAt(i)===38?(n="&",i++):(n=null,s===0&&l('"&"')),n===null&&(t.charCodeAt(i)===61?(n="=",i++):(n=null,s===0&&l('"="')),n===null&&(t.charCodeAt(i)===43?(n="+",i++):(n=null,s===0&&l('"+"')))))))))))}else e=null;return e}function nn(){var e,t;e=[],t=Vt();while(t!==null)e.push(t),t=Vt();return e}function rn(){var e,n,r,o,u,a,f,c;f=i,c=i,t.substr(i,3).toLowerCase()==="sip"?(e=t.substr(i,3),i+=3):(e=null,s===0&&l('"SIP"'));if(e!==null){t.charCodeAt(i)===47?(n="/",i++):(n=null,s===0&&l('"/"'));if(n!==null){o=h();if(o!==null){r=[];while(o!==null)r.push(o),o=h()}else r=null;if(r!==null){t.charCodeAt(i)===46?(o=".",i++):(o=null,s===0&&l('"."'));if(o!==null){a=h();if(a!==null){u=[];while(a!==null)u.push(a),a=h()}else u=null;u!==null?e=[e,n,r,o,u]:(e=null,i=c)}else e=null,i=c}else e=null,i=c}else e=null,i=c}else e=null,i=c;return e!==null&&(e=function(e){Li.sip_version=t.substring(i,e)}(f)),e===null&&(i=f),e}function sn(){var e;return t.substr(i,6)==="INVITE"?(e="INVITE",i+=6):(e=null,s===0&&l('"INVITE"')),e}function on(){var e;return t.substr(i,3)==="ACK"?(e="ACK",i+=3):(e=null,s===0&&l('"ACK"')),e}function un(){var e;return t.substr(i,7)==="OPTIONS"?(e="OPTIONS",i+=7):(e=null,s===0&&l('"OPTIONS"')),e}function an(){var e;return t.substr(i,3)==="BYE"?(e="BYE",i+=3):(e=null,s===0&&l('"BYE"')),e}function fn(){var e;return t.substr(i,6)==="CANCEL"?(e="CANCEL",i+=6):(e=null,s===0&&l('"CANCEL"')),e}function ln(){var e;return t.substr(i,8)==="REGISTER"?(e="REGISTER",i+=8):(e=null,s===0&&l('"REGISTER"')),e}function cn(){var e;return t.substr(i,9)==="SUBSCRIBE"?(e="SUBSCRIBE",i+=9):(e=null,s===0&&l('"SUBSCRIBE"')),e}function hn(){var e;return t.substr(i,6)==="NOTIFY"?(e="NOTIFY",i+=6):(e=null,s===0&&l('"NOTIFY"')),e}function pn(){var e,n;return n=i,e=sn(),e===null&&(e=on(),e===null&&(e=un(),e===null&&(e=an(),e===null&&(e=fn(),e===null&&(e=ln(),e===null&&(e=cn(),e===null&&(e=hn(),e===null&&(e=D())))))))),e!==null&&(e=function(e){return Li.method=t.substring(i,e),Li.method}(n)),e===null&&(i=n),e}function dn(){var e,t,n,r,s,o;return o=i,e=rn(),e!==null?(t=y(),t!==null?(n=vn(),n!==null?(r=y(),r!==null?(s=gn(),s!==null?e=[e,t,n,r,s]:(e=null,i=o)):(e=null,i=o)):(e=null,i=o)):(e=null,i=o)):(e=null,i=o),e}function vn(){var e,t;return t=i,e=mn(),e!==null&&(e=function(e,t){Li.status_code=parseInt(t.join(""))}(t,e)),e===null&&(i=t),e}function mn(){var e,t,n,r;return r=i,e=h(),e!==null?(t=h(),t!==null?(n=h(),n!==null?e=[e,t,n]:(e=null,i=r)):(e=null,i=r)):(e=null,i=r),e}function gn(){var e,n,r;r=i,e=[],n=E(),n===null&&(n=S(),n===null&&(n=T(),n===null&&(n=O(),n===null&&(n=M(),n===null&&(n=y(),n===null&&(n=b()))))));while(n!==null)e.push(n),n=E(),n===null&&(n=S(),n===null&&(n=T(),n===null&&(n=O(),n===null&&(n=M(),n===null&&(n=y(),n===null&&(n=b()))))));return e!==null&&(e=function(e){Li.reason_phrase=t.substring(i,e)}(r)),e===null&&(i=r),e}function yn(){var e,t,n,r,s,o,u;s=i,o=i,e=bn();if(e!==null){t=[],u=i,n=W(),n!==null?(r=bn(),r!==null?n=[n,r]:(n=null,i=u)):(n=null,i=u);while(n!==null)t.push(n),u=i,n=W(),n!==null?(r=bn(),r!==null?n=[n,r]:(n=null,i=u)):(n=null,i=u);t!==null?e=[e,t]:(e=null,i=o)}else e=null,i=o;return e!==null&&(e=function(e){Li=Li.methods}(s)),e===null&&(i=s),e}function bn(){var e,t;return t=i,e=pn(),e!==null&&(e=function(e,t){Li.methods||(Li.methods=[]),Li.methods.push(t)}(t,e)),e===null&&(i=t),e}function wn(){var e,t,n,r,s,o;s=i,e=er();if(e!==null){t=[],o=i,n=W(),n!==null?(r=er(),r!==null?n=[n,r]:(n=null,i=o)):(n=null,i=o);while(n!==null)t.push(n),o=i,n=W(),n!==null?(r=er(),r!==null?n=[n,r]:(n=null,i=o)):(n=null,i=o);t!==null?e=[e,t]:(e=null,i=s)}else e=null,i=s;return e}function En(){var e,t;return t=i,e=Sn(),e!==null&&(e=function(e,t){Li=t}(t,e)),e===null&&(i=t),e}function Sn(){var e,n,r,o,u,a;return o=i,u=i,e=B(),e!==null?(a=i,t.charCodeAt(i)===64?(n="@",i++):(n=null,s===0&&l('"@"')),n!==null?(r=B(),r!==null?n=[n,r]:(n=null,i=a)):(n=null,i=a),n=n!==null?n:"",n!==null?e=[e,n]:(e=null,i=u)):(e=null,i=u),e!==null&&(e=function(e){return t.substring(i,e)}(o)),e===null&&(i=o),e}function xn(){var e,t,n,r,s,o,u;s=i,e=j();if(e===null){o=i,e=Tn();if(e!==null){t=[],u=i,n=W(),n!==null?(r=Tn(),r!==null?n=[n,r]:(n=null,i=u)):(n=null,i=u);while(n!==null)t.push(n),u=i,n=W(),n!==null?(r=Tn(),r!==null?n=[n,r]:(n=null,i=u)):(n=null,i=u);t!==null?e=[e,t]:(e=null,i=o)}else e=null,i=o}return e!==null&&(e=function(e){var t;for(t in Li.multi_header)if(Li.multi_header[t].parsed===null){Li=null;break}Li!==null?Li=Li.multi_header:Li=-1}(s)),e===null&&(i=s),e}function Tn(){var e,t,n,r,s,o,u;s=i,o=i,e=tt(),e===null&&(e=Nn());if(e!==null){t=[],u=i,n=X(),n!==null?(r=kn(),r!==null?n=[n,r]:(n=null,i=u)):(n=null,i=u);while(n!==null)t.push(n),u=i,n=X(),n!==null?(r=kn(),r!==null?n=[n,r]:(n=null,i=u)):(n=null,i=u);t!==null?e=[e,t]:(e=null,i=o)}else e=null,i=o;return e!==null&&(e=function(e){var t;Li.multi_header||(Li.multi_header=[]);try{t=new JsSIP.NameAddrHeader(Li.uri,Li.display_name,Li.params),delete Li.uri,delete Li.display_name,delete Li.params}catch(n){t=null}Li.multi_header.push({possition:i,offset:e,parsed:t})}(s)),e===null&&(i=s),e}function Nn(){var e,t,n,r,s;return s=i,e=Cn(),e=e!==null?e:"",e!==null?(t=z(),t!==null?(n=nt(),n!==null?(r=U(),r!==null?e=[e,t,n,r]:(e=null,i=s)):(e=null,i=s)):(e=null,i=s)):(e=null,i=s),e}function Cn(){var e,n,r,s,o,u,a;o=i,u=i,e=D();if(e!==null){n=[],a=i,r=N(),r!==null?(s=D(),s!==null?r=[r,s]:(r=null,i=a)):(r=null,i=a);while(r!==null)n.push(r),a=i,r=N(),r!==null?(s=D(),s!==null?r=[r,s]:(r=null,i=a)):(r=null,i=a);n!==null?e=[e,n]:(e=null,i=u)}else e=null,i=u;return e===null&&(e=G()),e!==null&&(e=function(e,n){n=t.substring(i,e).trim(),n[0]==='"'&&(n=n.substring(1,n.length-1)),Li.display_name=n}(o,e)),e===null&&(i=o),e}function kn(){var e;return e=Ln(),e===null&&(e=An(),e===null&&(e=_n())),e}function Ln(){var e,n,r,o,u;return o=i,u=i,t.substr(i,1).toLowerCase()==="q"?(e=t.substr(i,1),i++):(e=null,s===0&&l('"q"')),e!==null?(n=I(),n!==null?(r=Mn(),r!==null?e=[e,n,r]:(e=null,i=u)):(e=null,i=u)):(e=null,i=u),e!==null&&(e=function(e,t){Li.params||(Li.params={}),Li.params.q=t}(o,e[2])),e===null&&(i=o),e}function An(){var e,n,r,o,u;return o=i,u=i,t.substr(i,7).toLowerCase()==="expires"?(e=t.substr(i,7),i+=7):(e=null,s===0&&l('"expires"')),e!==null?(n=I(),n!==null?(r=On(),r!==null?e=[e,n,r]:(e=null,i=u)):(e=null,i=u)):(e=null,i=u),e!==null&&(e=function(e,t){Li.params||(Li.params={}),Li.params.expires=t}(o,e[2])),e===null&&(i=o),e}function On(){var e,t,n;n=i,t=h();if(t!==null){e=[];while(t!==null)e.push(t),t=h()}else e=null;return e!==null&&(e=function(e,t){return parseInt(t.join(""))}(n,e)),e===null&&(i=n),e}function Mn(){var e,n,r,o,u,a,f,c;return a=i,f=i,t.charCodeAt(i)===48?(e="0",i++):(e=null,s===0&&l('"0"')),e!==null?(c=i,t.charCodeAt(i)===46?(n=".",i++):(n=null,s===0&&l('"."')),n!==null?(r=h(),r=r!==null?r:"",r!==null?(o=h(),o=o!==null?o:"",o!==null?(u=h(),u=u!==null?u:"",u!==null?n=[n,r,o,u]:(n=null,i=c)):(n=null,i=c)):(n=null,i=c)):(n=null,i=c),n=n!==null?n:"",n!==null?e=[e,n]:(e=null,i=f)):(e=null,i=f),e!==null&&(e=function(e){return parseFloat(t.substring(i,e))}(a)),e===null&&(i=a),e}function _n(){var e,t,n,r,s,o;return r=i,s=i,e=D(),e!==null?(o=i,t=I(),t!==null?(n=Dn(),n!==null?t=[t,n]:(t=null,i=o)):(t=null,i=o),t=t!==null?t:"",t!==null?e=[e,t]:(e=null,i=s)):(e=null,i=s),e!==null&&(e=function(e,t,n){Li.params||(Li.params={}),typeof n=="undefined"?n=undefined:n=n[1],Li.params[t.toLowerCase()]=n}(r,e[0],e[1])),e===null&&(i=r),e}function Dn(){var e;return e=D(),e===null&&(e=ft(),e===null&&(e=G())),e}function Pn(){var e,t,n,r,s,o;s=i,e=Hn();if(e!==null){t=[],o=i,n=X(),n!==null?(r=Bn(),r!==null?n=[n,r]:(n=null,i=o)):(n=null,i=o);while(n!==null)t.push(n),o=i,n=X(),n!==null?(r=Bn(),r!==null?n=[n,r]:(n=null,i=o)):(n=null,i=o);t!==null?e=[e,t]:(e=null,i=s)}else e=null,i=s;return e}function Hn(){var e;return t.substr(i,6).toLowerCase()==="render"?(e=t.substr(i,6),i+=6):(e=null,s===0&&l('"render"')),e===null&&(t.substr(i,7).toLowerCase()==="session"?(e=t.substr(i,7),i+=7):(e=null,s===0&&l('"session"')),e===null&&(t.substr(i,4).toLowerCase()==="icon"?(e=t.substr(i,4),i+=4):(e=null,s===0&&l('"icon"')),e===null&&(t.substr(i,5).toLowerCase()==="alert"?(e=t.substr(i,5),i+=5):(e=null,s===0&&l('"alert"')),e===null&&(e=D())))),e}function Bn(){var e;return e=jn(),e===null&&(e=_n()),e}function jn(){var e,n,r,o;return o=i,t.substr(i,8).toLowerCase()==="handling"?(e=t.substr(i,8),i+=8):(e=null,s===0&&l('"handling"')),e!==null?(n=I(),n!==null?(t.substr(i,8).toLowerCase()==="optional"?(r=t.substr(i,8),i+=8):(r=null,s===0&&l('"optional"')),r===null&&(t.substr(i,8).toLowerCase()==="required"?(r=t.substr(i,8),i+=8):(r=null,s===0&&l('"required"')),r===null&&(r=D())),r!==null?e=[e,n,r]:(e=null,i=o)):(e=null,i=o)):(e=null,i=o),e}function Fn(){var e,t,n,r,s,o;s=i,e=D();if(e!==null){t=[],o=i,n=W(),n!==null?(r=D(),r!==null?n=[n,r]:(n=null,i=o)):(n=null,i=o);while(n!==null)t.push(n),o=i,n=W(),n!==null?(r=D(),r!==null?n=[n,r]:(n=null,i=o)):(n=null,i=o);t!==null?e=[e,t]:(e=null,i=s)}else e=null,i=s;return e}function In(){var e,t,n;n=i,t=h();if(t!==null){e=[];while(t!==null)e.push(t),t=h()}else e=null;return e!==null&&(e=function(e,t){Li=parseInt(t.join(""))}(n,e)),e===null&&(i=n),e}function qn(){var e,n;return n=i,e=Rn(),e!==null&&(e=function(e){Li=t.substring(i,e)}(n)),e===null&&(i=n),e}function Rn(){var e,t,n,r,s,o,u,a;u=i,e=Un();if(e!==null){t=F();if(t!==null){n=$n();if(n!==null){r=[],a=i,s=X(),s!==null?(o=Jn(),o!==null?s=[s,o]:(s=null,i=a)):(s=null,i=a);while(s!==null)r.push(s),a=i,s=X(),s!==null?(o=Jn(),o!==null?s=[s,o]:(s=null,i=a)):(s=null,i=a);r!==null?e=[e,t,n,r]:(e=null,i=u)}else e=null,i=u}else e=null,i=u}else e=null,i=u;return e}function Un(){var e;return e=zn(),e===null&&(e=Wn()),e}function zn(){var e;return t.substr(i,4).toLowerCase()==="text"?(e=t.substr(i,4),i+=4):(e=null,s===0&&l('"text"')),e===null&&(t.substr(i,5).toLowerCase()==="image"?(e=t.substr(i,5),i+=5):(e=null,s===0&&l('"image"')),e===null&&(t.substr(i,5).toLowerCase()==="audio"?(e=t.substr(i,5),i+=5):(e=null,s===0&&l('"audio"')),e===null&&(t.substr(i,5).toLowerCase()==="video"?(e=t.substr(i,5),i+=5):(e=null,s===0&&l('"video"')),e===null&&(t.substr(i,11).toLowerCase()==="application"?(e=t.substr(i,11),i+=11):(e=null,s===0&&l('"application"')),e===null&&(e=Xn()))))),e}function Wn(){var e;return t.substr(i,7).toLowerCase()==="message"?(e=t.substr(i,7),i+=7):(e=null,s===0&&l('"message"')),e===null&&(t.substr(i,9).toLowerCase()==="multipart"?(e=t.substr(i,9),i+=9):(e=null,s===0&&l('"multipart"')),e===null&&(e=Xn())),e}function Xn(){var e;return e=D(),e===null&&(e=Vn()),e}function Vn(){var e,n,r;return r=i,t.substr(i,2).toLowerCase()==="x-"?(e=t.substr(i,2),i+=2):(e=null,s===0&&l('"x-"')),e!==null?(n=D(),n!==null?e=[e,n]:(e=null,i=r)):(e=null,i=r),e}function $n(){var e;return e=Xn(),e===null&&(e=D()),e}function Jn(){var e,t,n,r;return r=i,e=D(),e!==null?(t=I(),t!==null?(n=Kn(),n!==null?e=[e,t,n]:(e=null,i=r)):(e=null,i=r)):(e=null,i=r),e}function Kn(){var e;return e=D(),e===null&&(e=G()),e}function Qn(){var e,t,n,r;return r=i,e=Gn(),e!==null?(t=N(),t!==null?(n=pn(),n!==null?e=[e,t,n]:(e=null,i=r)):(e=null,i=r)):(e=null,i=r),e}function Gn(){var e,t,n;n=i,t=h();if(t!==null){e=[];while(t!==null)e.push(t),t=h()}else e=null;return e!==null&&(e=function(e,t){Li.value=parseInt(t.join(""))}(n,e)),e===null&&(i=n),e}function Yn(){var e,t;return t=i,e=On(),e!==null&&(e=function(e,t){Li=t}(t,e)),e===null&&(i=t),e}function Zn(){var e,t,n,r,s,o,u;s=i,o=i,e=er();if(e!==null){t=[],u=i,n=X(),n!==null?(r=_n(),r!==null?n=[n,r]:(n=null,i=u)):(n=null,i=u);while(n!==null)t.push(n),u=i,n=X(),n!==null?(r=_n(),r!==null?n=[n,r]:(n=null,i=u)):(n=null,i=u);t!==null?e=[e,t]:(e=null,i=o)}else e=null,i=o;return e!==null&&(e=function(e,t){Li.event=t.join("").toLowerCase()}(s,e[0])),e===null&&(i=s),e}function er(){var e,n,r,o,u,a;u=i,e=P();if(e!==null){n=[],a=i,t.charCodeAt(i)===46?(r=".",i++):(r=null,s===0&&l('"."')),r!==null?(o=P(),o!==null?r=[r,o]:(r=null,i=a)):(r=null,i=a);while(r!==null)n.push(r),a=i,t.charCodeAt(i)===46?(r=".",i++):(r=null,s===0&&l('"."')),r!==null?(o=P(),o!==null?r=[r,o]:(r=null,i=a)):(r=null,i=a);n!==null?e=[e,n]:(e=null,i=u)}else e=null,i=u;return e}function tr(){var e,t,n,r,s,o,u;s=i,o=i,e=tt(),e===null&&(e=Nn());if(e!==null){t=[],u=i,n=X(),n!==null?(r=nr(),r!==null?n=[n,r]:(n=null,i=u)):(n=null,i=u);while(n!==null)t.push(n),u=i,n=X(),n!==null?(r=nr(),r!==null?n=[n,r]:(n=null,i=u)):(n=null,i=u);t!==null?e=[e,t]:(e=null,i=o)}else e=null,i=o;return e!==null&&(e=function(e){var t=Li.tag;try{Li=new JsSIP.NameAddrHeader(Li.uri,Li.display_name,Li.params),t&&Li.setParam("tag",t)}catch(n){Li=-1}}(s)),e===null&&(i=s),e}function nr(){var e;return e=rr(),e===null&&(e=_n()),e}function rr(){var e,n,r,o,u;return o=i,u=i,t.substr(i,3).toLowerCase()==="tag"?(e=t.substr(i,3),i+=3):(e=null,s===0&&l('"tag"')),e!==null?(n=I(),n!==null?(r=D(),r!==null?e=[e,n,r]:(e=null,i=u)):(e=null,i=u)):(e=null,i=u),e!==null&&(e=function(e,t){Li.tag=t}(o,e[2])),e===null&&(i=o),e}function ir(){var e,t,n;n=i,t=h();if(t!==null){e=[];while(t!==null)e.push(t),t=h()}else e=null;return e!==null&&(e=function(e,t){Li=parseInt(t.join(""))}(n,e)),e===null&&(i=n),e}function sr(){var e,t;return t=i,e=On(),e!==null&&(e=function(e,t){Li=t}(t,e)),e===null&&(i=t),e}function or(){var e,t,n,r,s,o,u;s=i,o=i,e=On();if(e!==null){t=[],u=i,n=X(),n!==null?(r=_n(),r!==null?n=[n,r]:(n=null,i=u)):(n=null,i=u);while(n!==null)t.push(n),u=i,n=X(),n!==null?(r=_n(),r!==null?n=[n,r]:(n=null,i=u)):(n=null,i=u);t!==null?e=[e,t]:(e=null,i=o)}else e=null,i=o;return e!==null&&(e=function(e,t){t>=90?Li=t:Li=-1}(s,e[0])),e===null&&(i=s),e}function ur(){var e,t,n,r,s,o,u,a,f,l;a=i,f=i,e=[],t=Cn();while(t!==null)e.push(t),t=Cn();if(e!==null){t=z();if(t!==null){n=nt();if(n!==null){r=U();if(r!==null){s=[],l=i,o=X(),o!==null?(u=_n(),u!==null?o=[o,u]:(o=null,i=l)):(o=null,i=l);while(o!==null)s.push(o),l=i,o=X(),o!==null?(u=_n(),u!==null?o=[o,u]:(o=null,i=l)):(o=null,i=l);s!==null?e=[e,t,n,r,s]:(e=null,i=f)}else e=null,i=f}else e=null,i=f}else e=null,i=f}else e=null,i=f;return e!==null&&(e=function(e){try{Li=new JsSIP.NameAddrHeader(Li.uri,Li.display_name,Li.params)}catch(t){Li=-1}}(a)),e===null&&(i=a),e}function ar(){var e;return e=fr(),e}function fr(){var e,n,r,o,u,a,f,c;f=i,t.substr(i,6).toLowerCase()==="digest"?(e=t.substr(i,6),i+=6):(e=null,s===0&&l('"Digest"'));if(e!==null){n=N();if(n!==null){r=hr();if(r!==null){o=[],c=i,u=W(),u!==null?(a=hr(),a!==null?u=[u,a]:(u=null,i=c)):(u=null,i=c);while(u!==null)o.push(u),c=i,u=W(),u!==null?(a=hr(),a!==null?u=[u,a]:(u=null,i=c)):(u=null,i=c);o!==null?e=[e,n,r,o]:(e=null,i=f)}else e=null,i=f}else e=null,i=f}else e=null,i=f;return e===null&&(e=lr()),e}function lr(){var e,t,n,r,s,o,u,a;u=i,e=D();if(e!==null){t=N();if(t!==null){n=cr();if(n!==null){r=[],a=i,s=W(),s!==null?(o=cr(),o!==null?s=[s,o]:(s=null,i=a)):(s=null,i=a);while(s!==null)r.push(s),a=i,s=W(),s!==null?(o=cr(),o!==null?s=[s,o]:(s=null,i=a)):(s=null,i=a);r!==null?e=[e,t,n,r]:(e=null,i=u)}else e=null,i=u}else e=null,i=u}else e=null,i=u;return e}function cr(){var e,t,n,r;return r=i,e=D(),e!==null?(t=I(),t!==null?(n=D(),n===null&&(n=G()),n!==null?e=[e,t,n]:(e=null,i=r)):(e=null,i=r)):(e=null,i=r),e}function hr(){var e;return e=pr(),e===null&&(e=vr(),e===null&&(e=gr(),e===null&&(e=br(),e===null&&(e=wr(),e===null&&(e=Er(),e===null&&(e=Sr(),e===null&&(e=cr()))))))),e}function pr(){var e,n,r,o;return o=i,t.substr(i,5).toLowerCase()==="realm"?(e=t.substr(i,5),i+=5):(e=null,s===0&&l('"realm"')),e!==null?(n=I(),n!==null?(r=dr(),r!==null?e=[e,n,r]:(e=null,i=o)):(e=null,i=o)):(e=null,i=o),e}function dr(){var e,t;return t=i,e=Y(),e!==null&&(e=function(e,t){Li.realm=t}(t,e)),e===null&&(i=t),e}function vr(){var e,n,r,o,u,a,f,c,h;c=i,t.substr(i,6).toLowerCase()==="domain"?(e=t.substr(i,6),i+=6):(e=null,s===0&&l('"domain"'));if(e!==null){n=I();if(n!==null){r=$();if(r!==null){o=mr();if(o!==null){u=[],h=i,f=y();if(f!==null){a=[];while(f!==null)a.push(f),f=y()}else a=null;a!==null?(f=mr(),f!==null?a=[a,f]:(a=null,i=h)):(a=null,i=h);while(a!==null){u.push(a),h=i,f=y();if(f!==null){a=[];while(f!==null)a.push(f),f=y()}else a=null;a!==null?(f=mr(),f!==null?a=[a,f]:(a=null,i=h)):(a=null,i=h)}u!==null?(a=J(),a!==null?e=[e,n,r,o,u,a]:(e=null,i=c)):(e=null,i=c)}else e=null,i=c}else e=null,i=c}else e=null,i=c}else e=null,i=c;return e}function mr(){var e;return e=Rt(),e===null&&(e=Wt()),e}function gr(){var e,n,r,o;return o=i,t.substr(i,5).toLowerCase()==="nonce"?(e=t.substr(i,5),i+=5):(e=null,s===0&&l('"nonce"')),e!==null?(n=I(),n!==null?(r=yr(),r!==null?e=[e,n,r]:(e=null,i=o)):(e=null,i=o)):(e=null,i=o),e}function yr(){var e,t;return t=i,e=Y(),e!==null&&(e=function(e,t){Li.nonce=t}(t,e)),e===null&&(i=t),e}function br(){var e,n,r,o,u;return o=i,u=i,t.substr(i,6).toLowerCase()==="opaque"?(e=t.substr(i,6),i+=6):(e=null,s===0&&l('"opaque"')),e!==null?(n=I(),n!==null?(r=Y(),r!==null?e=[e,n,r]:(e=null,i=u)):(e=null,i=u)):(e=null,i=u),e!==null&&(e=function(e,t){Li.opaque=t}(o,e[2])),e===null&&(i=o),e}function wr(){var e,n,r,o,u;return o=i,t.substr(i,5).toLowerCase()==="stale"?(e=t.substr(i,5),i+=5):(e=null,s===0&&l('"stale"')),e!==null?(n=I(),n!==null?(u=i,t.substr(i,4).toLowerCase()==="true"?(r=t.substr(i,4),i+=4):(r=null,s===0&&l('"true"')),r!==null&&(r=function(e){Li.stale=!0}(u)),r===null&&(i=u),r===null&&(u=i,t.substr(i,5).toLowerCase()==="false"?(r=t.substr(i,5),i+=5):(r=null,s===0&&l('"false"')),r!==null&&(r=function(e){Li.stale=!1}(u)),r===null&&(i=u)),r!==null?e=[e,n,r]:(e=null,i=o)):(e=null,i=o)):(e=null,i=o),e}function Er(){var e,n,r,o,u;return o=i,u=i,t.substr(i,9).toLowerCase()==="algorithm"?(e=t.substr(i,9),i+=9):(e=null,s===0&&l('"algorithm"')),e!==null?(n=I(),n!==null?(t.substr(i,3).toLowerCase()==="md5"?(r=t.substr(i,3),i+=3):(r=null,s===0&&l('"MD5"')),r===null&&(t.substr(i,8).toLowerCase()==="md5-sess"?(r=t.substr(i,8),i+=8):(r=null,s===0&&l('"MD5-sess"')),r===null&&(r=D())),r!==null?e=[e,n,r]:(e=null,i=u)):(e=null,i=u)):(e=null,i=u),e!==null&&(e=function(e,t){Li.algorithm=t.toUpperCase()}(o,e[2])),e===null&&(i=o),e}function Sr(){var e,n,r,o,u,a,f,c,h,p;c=i,t.substr(i,3).toLowerCase()==="qop"?(e=t.substr(i,3),i+=3):(e=null,s===0&&l('"qop"'));if(e!==null){n=I();if(n!==null){r=$();if(r!==null){h=i,o=xr();if(o!==null){u=[],p=i,t.charCodeAt(i)===44?(a=",",i++):(a=null,s===0&&l('","')),a!==null?(f=xr(),f!==null?a=[a,f]:(a=null,i=p)):(a=null,i=p);while(a!==null)u.push(a),p=i,t.charCodeAt(i)===44?(a=",",i++):(a=null,s===0&&l('","')),a!==null?(f=xr(),f!==null?a=[a,f]:(a=null,i=p)):(a=null,i=p);u!==null?o=[o,u]:(o=null,i=h)}else o=null,i=h;o!==null?(u=J(),u!==null?e=[e,n,r,o,u]:(e=null,i=c)):(e=null,i=c)}else e=null,i=c}else e=null,i=c}else e=null,i=c;return e}function xr(){var e,n;return n=i,t.substr(i,8).toLowerCase()==="auth-int"?(e=t.substr(i,8),i+=8):(e=null,s===0&&l('"auth-int"')),e===null&&(t.substr(i,4).toLowerCase()==="auth"?(e=t.substr(i,4),i+=4):(e=null,s===0&&l('"auth"')),e===null&&(e=D())),e!==null&&(e=function(e,t){Li.qop||(Li.qop=[]),Li.qop.push(t.toLowerCase())}(n,e)),e===null&&(i=n),e}function Tr(){var e,t,n,r,s,o;s=i,e=Nr();if(e!==null){t=[],o=i,n=W(),n!==null?(r=Nr(),r!==null?n=[n,r]:(n=null,i=o)):(n=null,i=o);while(n!==null)t.push(n),o=i,n=W(),n!==null?(r=Nr(),r!==null?n=[n,r]:(n=null,i=o)):(n=null,i=o);t!==null?e=[e,t]:(e=null,i=s)}else e=null,i=s;return e}function Nr(){var e,t;return t=i,e=D(),e!==null&&(e=function(e,t){Li.options||(Li.options=[]),Li.options.push(t)}(t,e)),e===null&&(i=t),e}function Cr(){var e,t,n,r,s,o,u;s=i,o=i,e=kr();if(e!==null){t=[],u=i,n=W(),n!==null?(r=kr(),r!==null?n=[n,r]:(n=null,i=u)):(n=null,i=u);while(n!==null)t.push(n),u=i,n=W(),n!==null?(r=kr(),r!==null?n=[n,r]:(n=null,i=u)):(n=null,i=u);t!==null?e=[e,t]:(e=null,i=o)}else e=null,i=o;return e!==null&&(e=function(e){var t;for(t in Li.multi_header)if(Li.multi_header[t].parsed===null){Li=null;break}Li!==null?Li=Li.multi_header:Li=-1}(s)),e===null&&(i=s),e}function kr(){var e,t,n,r,s,o,u;s=i,o=i,e=Nn();if(e!==null){t=[],u=i,n=X(),n!==null?(r=_n(),r!==null?n=[n,r]:(n=null,i=u)):(n=null,i=u);while(n!==null)t.push(n),u=i,n=X(),n!==null?(r=_n(),r!==null?n=[n,r]:(n=null,i=u)):(n=null,i=u);t!==null?e=[e,t]:(e=null,i=o)}else e=null,i=o;return e!==null&&(e=function(e){var t;Li.multi_header||(Li.multi_header=[]);try{t=new JsSIP.NameAddrHeader(Li.uri,Li.display_name,Li.params),delete Li.uri,delete Li.display_name,delete Li.params}catch(n){t=null}Li.multi_header.push({possition:i,offset:e,parsed:t})}(s)),e===null&&(i=s),e}function Lr(){var e,t,n,r,s,o,u;s=i,o=i,e=tt(),e===null&&(e=Nn());if(e!==null){t=[],u=i,n=X(),n!==null?(r=_n(),r!==null?n=[n,r]:(n=null,i=u)):(n=null,i=u);while(n!==null)t.push(n),u=i,n=X(),n!==null?(r=_n(),r!==null?n=[n,r]:(n=null,i=u)):(n=null,i=u);t!==null?e=[e,t]:(e=null,i=o)}else e=null,i=o;return e!==null&&(e=function(e){try{Li=new JsSIP.NameAddrHeader(Li.uri,Li.display_name,Li.params)}catch(t){Li=-1}}(s)),e===null&&(i=s),e}function Ar(){var e,t,n,r,s,o,u;s=i,o=i,e=Nr();if(e!==null){t=[],u=i,n=W(),n!==null?(r=Nr(),r!==null?n=[n,r]:(n=null,i=u)):(n=null,i=u);while(n!==null)t.push(n),u=i,n=W(),n!==null?(r=Nr(),r!==null?n=[n,r]:(n=null,i=u)):(n=null,i=u);t!==null?e=[e,t]:(e=null,i=o)}else e=null,i=o;return e!==null&&(e=function(e){Li=Li.options}(s)),e===null&&(i=s),e}function Or(){var e,t,n,r,s,o;s=i,e=Mr();if(e!==null){t=[],o=i,n=W(),n!==null?(r=Mr(),r!==null?n=[n,r]:(n=null,i=o)):(n=null,i=o);while(n!==null)t.push(n),o=i,n=W(),n!==null?(r=Mr(),r!==null?n=[n,r]:(n=null,i=o)):(n=null,i=o);t!==null?e=[e,t]:(e=null,i=s)}else e=null,i=s;return e}function Mr(){var e,t,n,r,s,o;s=i,e=Nn();if(e!==null){t=[],o=i,n=X(),n!==null?(r=_n(),r!==null?n=[n,r]:(n=null,i=o)):(n=null,i=o);while(n!==null)t.push(n),o=i,n=X(),n!==null?(r=_n(),r!==null?n=[n,r]:(n=null,i=o)):(n=null,i=o);t!==null?e=[e,t]:(e=null,i=s)}else e=null,i=s;return e}function _r(){var e,t,n,r,s,o,u;s=i,o=i,e=On();if(e!==null){t=[],u=i,n=X(),n!==null?(r=Dr(),r!==null?n=[n,r]:(n=null,i=u)):(n=null,i=u);while(n!==null)t.push(n),u=i,n=X(),n!==null?(r=Dr(),r!==null?n=[n,r]:(n=null,i=u)):(n=null,i=u);t!==null?e=[e,t]:(e=null,i=o)}else e=null,i=o;return e!==null&&(e=function(e,t){Li.interval=t}(s,e[0])),e===null&&(i=s),e}function Dr(){var e;return e=Pr(),e===null&&(e=_n()),e}function Pr(){var e,n,r,o,u;return o=i,u=i,t.substr(i,9).toLowerCase()==="refresher"?(e=t.substr(i,9),i+=9):(e=null,s===0&&l('"refresher"')),e!==null?(n=I(),n!==null?(t.substr(i,3).toLowerCase()==="uas"?(r=t.substr(i,3),i+=3):(r=null,s===0&&l('"uas"')),r===null&&(t.substr(i,3).toLowerCase()==="uac"?(r=t.substr(i,3),i+=3):(r=null,s===0&&l('"uac"'))),r!==null?e=[e,n,r]:(e=null,i=u)):(e=null,i=u)):(e=null,i=u),e!==null&&(e=function(e,t){Li.params||(Li.params={}),Li.params.refresher=t}(o,e[2])),e===null&&(i=o),e}function Hr(){var e,t,n,r,s,o;s=i,e=Br();if(e!==null){t=[],o=i,n=X(),n!==null?(r=jr(),r!==null?n=[n,r]:(n=null,i=o)):(n=null,i=o);while(n!==null)t.push(n),o=i,n=X(),n!==null?(r=jr(),r!==null?n=[n,r]:(n=null,i=o)):(n=null,i=o);t!==null?e=[e,t]:(e=null,i=s)}else e=null,i=s;return e}function Br(){var e,n;return n=i,t.substr(i,6).toLowerCase()==="active"?(e=t.substr(i,6),i+=6):(e=null,s===0&&l('"active"')),e===null&&(t.substr(i,7).toLowerCase()==="pending"?(e=t.substr(i,7),i+=7):(e=null,s===0&&l('"pending"')),e===null&&(t.substr(i,10).toLowerCase()==="terminated"?(e=t.substr(i,10),i+=10):(e=null,s===0&&l('"terminated"')),e===null&&(e=D()))),e!==null&&(e=function(e){Li.state=t.substring(i,e)}(n)),e===null&&(i=n),e}function jr(){var e,n,r,o,u;return o=i,u=i,t.substr(i,6).toLowerCase()==="reason"?(e=t.substr(i,6),i+=6):(e=null,s===0&&l('"reason"')),e!==null?(n=I(),n!==null?(r=Fr(),r!==null?e=[e,n,r]:(e=null,i=u)):(e=null,i=u)):(e=null,i=u),e!==null&&(e=function(e,t){typeof t!="undefined"&&(Li.reason=t)}(o,e[2])),e===null&&(i=o),e===null&&(o=i,u=i,t.substr(i,7).toLowerCase()==="expires"?(e=t.substr(i,7),i+=7):(e=null,s===0&&l('"expires"')),e!==null?(n=I(),n!==null?(r=On(),r!==null?e=[e,n,r]:(e=null,i=u)):(e=null,i=u)):(e=null,i=u),e!==null&&(e=function(e,t){typeof t!="undefined"&&(Li.expires=t)}(o,e[2])),e===null&&(i=o),e===null&&(o=i,u=i,t.substr(i,11).toLowerCase()==="retry_after"?(e=t.substr(i,11),i+=11):(e=null,s===0&&l('"retry_after"')),e!==null?(n=I(),n!==null?(r=On(),r!==null?e=[e,n,r]:(e=null,i=u)):(e=null,i=u)):(e=null,i=u),e!==null&&(e=function(e,t){typeof t!="undefined"&&(Li.retry_after=t)}(o,e[2])),e===null&&(i=o),e===null&&(e=_n()))),e}function Fr(){var e;return t.substr(i,11).toLowerCase()==="deactivated"?(e=t.substr(i,11),i+=11):(e=null,s===0&&l('"deactivated"')),e===null&&(t.substr(i,9).toLowerCase()==="probation"?(e=t.substr(i,9),i+=9):(e=null,s===0&&l('"probation"')),e===null&&(t.substr(i,8).toLowerCase()==="rejected"?(e=t.substr(i,8),i+=8):(e=null,s===0&&l('"rejected"')),e===null&&(t.substr(i,7).toLowerCase()==="timeout"?(e=t.substr(i,7),i+=7):(e=null,s===0&&l('"timeout"')),e===null&&(t.substr(i,6).toLowerCase()==="giveup"?(e=t.substr(i,6),i+=6):(e=null,s===0&&l('"giveup"')),e===null&&(t.substr(i,10).toLowerCase()==="noresource"?(e=t.substr(i,10),i+=10):(e=null,s===0&&l('"noresource"')),e===null&&(t.substr(i,9).toLowerCase()==="invariant"?(e=t.substr(i,9),i+=9):(e=null,s===0&&l('"invariant"')),e===null&&(e=D()))))))),e}function Ir(){var e;return e=L(),e=e!==null?e:"",e}function qr(){var e,t,n,r,s,o,u;s=i,o=i,e=Nr();if(e!==null){t=[],u=i,n=W(),n!==null?(r=Nr(),r!==null?n=[n,r]:(n=null,i=u)):(n=null,i=u);while(n!==null)t.push(n),u=i,n=W(),n!==null?(r=Nr(),r!==null?n=[n,r]:(n=null,i=u)):(n=null,i=u);t!==null?e=[e,t]:(e=null,i=o)}else e=null,i=o;return e=e!==null?e:"",e!==null&&(e=function(e){Li=Li.options||[]}(s)),e===null&&(i=s),e}function Rr(){var e,t,n,r,s,o,u;s=i,o=i,e=Sn();if(e!==null){t=[],u=i,n=X(),n!==null?(r=Ur(),r!==null?n=[n,r]:(n=null,i=u)):(n=null,i=u);while(n!==null)t.push(n),u=i,n=X(),n!==null?(r=Ur(),r!==null?n=[n,r]:(n=null,i=u)):(n=null,i=u);t!==null?e=[e,t]:(e=null,i=o)}else e=null,i=o;return e!==null&&(e=function(e,t){Li.call_id=t}(s,e[0])),e===null&&(i=s),e}function Ur(){var e;return e=zr(),e===null&&(e=Wr(),e===null&&(e=_n())),e}function zr(){var e,n,r,o,u;return o=i,u=i,t.substr(i,10).toLowerCase()==="remote-tag"?(e=t.substr(i,10),i+=10):(e=null,s===0&&l('"remote-tag"')),e!==null?(n=I(),n!==null?(r=D(),r!==null?e=[e,n,r]:(e=null,i=u)):(e=null,i=u)):(e=null,i=u),e!==null&&(e=function(e,t){Li.remote_tag=t}(o,e[2])),e===null&&(i=o),e}function Wr(){var e,n,r,o,u;return o=i,u=i,t.substr(i,9).toLowerCase()==="local-tag"?(e=t.substr(i,9),i+=9):(e=null,s===0&&l('"local-tag"')),e!==null?(n=I(),n!==null?(r=D(),r!==null?e=[e,n,r]:(e=null,i=u)):(e=null,i=u)):(e=null,i=u),e!==null&&(e=function(e,t){Li.local_tag=t}(o,e[2])),e===null&&(i=o),e}function Xr(){var e,t,n,r,s,o,u;s=i,o=i,e=tt(),e===null&&(e=Nn());if(e!==null){t=[],u=i,n=X(),n!==null?(r=Vr(),r!==null?n=[n,r]:(n=null,i=u)):(n=null,i=u);while(n!==null)t.push(n),u=i,n=X(),n!==null?(r=Vr(),r!==null?n=[n,r]:(n=null,i=u)):(n=null,i=u);t!==null?e=[e,t]:(e=null,i=o)}else e=null,i=o;return e!==null&&(e=function(e){var t=Li.tag;try{Li=new JsSIP.NameAddrHeader(Li.uri,Li.display_name,Li.params),t&&Li.setParam("tag",t)}catch(n){Li=-1}}(s)),e===null&&(i=s),e}function Vr(){var e;return e=rr(),e===null&&(e=_n()),e}function $r(){var e,t,n,r,s,o;s=i,e=Jr();if(e!==null){t=[],o=i,n=W(),n!==null?(r=Jr(),r!==null?n=[n,r]:(n=null,i=o)):(n=null,i=o);while(n!==null)t.push(n),o=i,n=W(),n!==null?(r=Jr(),r!==null?n=[n,r]:(n=null,i=o)):(n=null,i=o);t!==null?e=[e,t]:(e=null,i=s)}else e=null,i=s;return e}function Jr(){var e,t,n,r,s,o,u,a;u=i,e=ti();if(e!==null){t=N();if(t!==null){n=ii();if(n!==null){r=[],a=i,s=X(),s!==null?(o=Kr(),o!==null?s=[s,o]:(s=null,i=a)):(s=null,i=a);while(s!==null)r.push(s),a=i,s=X(),s!==null?(o=Kr(),o!==null?s=[s,o]:(s=null,i=a)):(s=null,i=a);r!==null?e=[e,t,n,r]:(e=null,i=u)}else e=null,i=u}else e=null,i=u}else e=null,i=u;return e}function Kr(){var e;return e=Qr(),e===null&&(e=Gr(),e===null&&(e=Yr(),e===null&&(e=Zr(),e===null&&(e=ei(),e===null&&(e=_n()))))),e}function Qr(){var e,n,r,o,u;return o=i,u=i,t.substr(i,3).toLowerCase()==="ttl"?(e=t.substr(i,3),i+=3):(e=null,s===0&&l('"ttl"')),e!==null?(n=I(),n!==null?(r=ui(),r!==null?e=[e,n,r]:(e=null,i=u)):(e=null,i=u)):(e=null,i=u),e!==null&&(e=function(e,t){Li.ttl=t}(o,e[2])),e===null&&(i=o),e}function Gr(){var e,n,r,o,u;return o=i,u=i,t.substr(i,5).toLowerCase()==="maddr"?(e=t.substr(i,5),i+=5):(e=null,s===0&&l('"maddr"')),e!==null?(n=I(),n!==null?(r=ft(),r!==null?e=[e,n,r]:(e=null,i=u)):(e=null,i=u)):(e=null,i=u),e!==null&&(e=function(e,t){Li.maddr=t}(o,e[2])),e===null&&(i=o),e}function Yr(){var e,n,r,o,u;return o=i,u=i,t.substr(i,8).toLowerCase()==="received"?(e=t.substr(i,8),i+=8):(e=null,s===0&&l('"received"')),e!==null?(n=I(),n!==null?(r=gt(),r===null&&(r=dt()),r!==null?e=[e,n,r]:(e=null,i=u)):(e=null,i=u)):(e=null,i=u),e!==null&&(e=function(e,t){Li.received=t}(o,e[2])),e===null&&(i=o),e}function Zr(){var e,n,r,o,u;return o=i,u=i,t.substr(i,6).toLowerCase()==="branch"?(e=t.substr(i,6),i+=6):(e=null,s===0&&l('"branch"')),e!==null?(n=I(),n!==null?(r=D(),r!==null?e=[e,n,r]:(e=null,i=u)):(e=null,i=u)):(e=null,i=u),e!==null&&(e=function(e,t){Li.branch=t}(o,e[2])),e===null&&(i=o),e}function ei(){var e,n,r,o,u,a,f;u=i,a=i,t.substr(i,5).toLowerCase()==="rport"?(e=t.substr(i,5),i+=5):(e=null,s===0&&l('"rport"'));if(e!==null){f=i,n=I();if(n!==null){r=[],o=h();while(o!==null)r.push(o),o=h();r!==null?n=[n,r]:(n=null,i=f)}else n=null,i=f;n=n!==null?n:"",n!==null?e=[e,n]:(e=null,i=a)}else e=null,i=a;return e!==null&&(e=function(e){typeof response_port!="undefined"&&(Li.rport=response_port.join(""))}(u)),e===null&&(i=u),e}function ti(){var e,t,n,r,s,o;return o=i,e=ni(),e!==null?(t=F(),t!==null?(n=D(),n!==null?(r=F(),r!==null?(s=ri(),s!==null?e=[e,t,n,r,s]:(e=null,i=o)):(e=null,i=o)):(e=null,i=o)):(e=null,i=o)):(e=null,i=o),e}function ni(){var e,n;return n=i,t.substr(i,3).toLowerCase()==="sip"?(e=t.substr(i,3),i+=3):(e=null,s===0&&l('"SIP"')),e===null&&(e=D()),e!==null&&(e=function(e,t){Li.protocol=t}(n,e)),e===null&&(i=n),e}function ri(){var e,n;return n=i,t.substr(i,3).toLowerCase()==="udp"?(e=t.substr(i,3),i+=3):(e=null,s===0&&l('"UDP"')),e===null&&(t.substr(i,3).toLowerCase()==="tcp"?(e=t.substr(i,3),i+=3):(e=null,s===0&&l('"TCP"')),e===null&&(t.substr(i,3).toLowerCase()==="tls"?(e=t.substr(i,3),i+=3):(e=null,s===0&&l('"TLS"')),e===null&&(t.substr(i,4).toLowerCase()==="sctp"?(e=t.substr(i,4),i+=4):(e=null,s===0&&l('"SCTP"')),e===null&&(e=D())))),e!==null&&(e=function(e,t){Li.transport=t}(n,e)),e===null&&(i=n),e}function ii(){var e,t,n,r,s;return r=i,e=si(),e!==null?(s=i,t=V(),t!==null?(n=oi(),n!==null?t=[t,n]:(t=null,i=s)):(t=null,i=s),t=t!==null?t:"",t!==null?e=[e,t]:(e=null,i=r)):(e=null,i=r),e}function si(){var e,n;return n=i,e=lt(),e===null&&(e=gt(),e===null&&(e=pt())),e!==null&&(e=function(e){Li.host=t.substring(i,e)}(n)),e===null&&(i=n),e}function oi(){var e,t,n,r,s,o,u;return o=i,u=i,e=h(),e=e!==null?e:"",e!==null?(t=h(),t=t!==null?t:"",t!==null?(n=h(),n=n!==null?n:"",n!==null?(r=h(),r=r!==null?r:"",r!==null?(s=h(),s=s!==null?s:"",s!==null?e=[e,t,n,r,s]:(e=null,i=u)):(e=null,i=u)):(e=null,i=u)):(e=null,i=u)):(e=null,i=u),e!==null&&(e=function(e,t){Li.port=parseInt(t.join(""))}(o,e)),e===null&&(i=o),e}function ui(){var e,t,n,r,s;return r=i,s=i,e=h(),e!==null?(t=h(),t=t!==null?t:"",t!==null?(n=h(),n=n!==null?n:"",n!==null?e=[e,t,n]:(e=null,i=s)):(e=null,i=s)):(e=null,i=s),e!==null&&(e=function(e,t){return parseInt(t.join(""))}(r,e)),e===null&&(i=r),e}function ai(){var e;return e=fr(),e}function fi(){var e,t,n,r;return r=i,e=D(),e!==null?(t=k(),t!==null?(n=li(),n!==null?e=[e,t,n]:(e=null,i=r)):(e=null,i=r)):(e=null,i=r),e}function li(){var e,t;e=[],t=A(),t===null&&(t=M(),t===null&&(t=N()));while(t!==null)e.push(t),t=A(),t===null&&(t=M(),t===null&&(t=N()));return e}function ci(){var e,t;e=[],t=m();while(t!==null)e.push(t),t=m();return e}function hi(){var e,n,r,o;return o=i,e=pi(),e!==null?(t.charCodeAt(i)===58?(n=":",i++):(n=null,s===0&&l('":"')),n!==null?(r=di(),r!==null?e=[e,n,r]:(e=null,i=o)):(e=null,i=o)):(e=null,i=o),e}function pi(){var e,n;return n=i,t.substr(i,5).toLowerCase()==="stuns"?(e=t.substr(i,5),i+=5):(e=null,s===0&&l('"stuns"')),e===null&&(t.substr(i,4).toLowerCase()==="stun"?(e=t.substr(i,4),i+=4):(e=null,s===0&&l('"stun"'))),e!==null&&(e=function(e,t){Li.scheme=t}(n,e)),e===null&&(i=n),e}function di(){var e,n,r,o,u;return o=i,e=vi(),e!==null?(u=i,t.charCodeAt(i)===58?(n=":",i++):(n=null,s===0&&l('":"')),n!==null?(r=bt(),r!==null?n=[n,r]:(n=null,i=u)):(n=null,i=u),n=n!==null?n:"",n!==null?e=[e,n]:(e=null,i=o)):(e=null,i=o),e}function vi(){var e,t;return t=i,e=gt(),e===null&&(e=pt(),e===null&&(e=tn())),e!==null&&(e=function(e,t){Li.host=t}(t,e)),e===null&&(i=t),e}function tn(){var e,n,r;r=i,e=[],n=mi(),n===null&&(n=T(),n===null&&(n=gi()));while(n!==null)e.push(n),n=mi(),n===null&&(n=T(),n===null&&(n=gi()));return e!==null&&(e=function(e){return t.substring(i,e)}(r)),e===null&&(i=r),e}function mi(){var e;return e=p(),e===null&&(e=h(),e===null&&(t.charCodeAt(i)===45?(e="-",i++):(e=null,s===0&&l('"-"')),e===null&&(t.charCodeAt(i)===46?(e=".",i++):(e=null,s===0&&l('"."')),e===null&&(t.charCodeAt(i)===95?(e="_",i++):(e=null,s===0&&l('"_"')),e===null&&(t.charCodeAt(i)===126?(e="~",i++):(e=null,s===0&&l('"~"'))))))),e}function gi(){var e;return t.charCodeAt(i)===33?(e="!",i++):(e=null,s===0&&l('"!"')),e===null&&(t.charCodeAt(i)===36?(e="$",i++):(e=null,s===0&&l('"$"')),e===null&&(t.charCodeAt(i)===38?(e="&",i++):(e=null,s===0&&l('"&"')),e===null&&(t.charCodeAt(i)===39?(e="'",i++):(e=null,s===0&&l('"\'"')),e===null&&(t.charCodeAt(i)===40?(e="(",i++):(e=null,s===0&&l('"("')),e===null&&(t.charCodeAt(i)===41?(e=")",i++):(e=null,s===0&&l('")"')),e===null&&(t.charCodeAt(i)===42?(e="*",i++):(e=null,s===0&&l('"*"')),e===null&&(t.charCodeAt(i)===43?(e="+",i++):(e=null,s===0&&l('"+"')),e===null&&(t.charCodeAt(i)===44?(e=",",i++):(e=null,s===0&&l('","')),e===null&&(t.charCodeAt(i)===59?(e=";",i++):(e=null,s===0&&l('";"')),e===null&&(t.charCodeAt(i)===61?(e="=",i++):(e=null,s===0&&l('"="')))))))))))),e}function yi(){var e,n,r,o,u,a,f;return a=i,e=bi(),e!==null?(t.charCodeAt(i)===58?(n=":",i++):(n=null,s===0&&l('":"')),n!==null?(r=di(),r!==null?(f=i,t.substr(i,11)==="?transport="?(o="?transport=",i+=11):(o=null,s===0&&l('"?transport="')),o!==null?(u=ri(),u!==null?o=[o,u]:(o=null,i=f)):(o=null,i=f),o=o!==null?o:"",o!==null?e=[e,n,r,o]:(e=null,i=a)):(e=null,i=a)):(e=null,i=a)):(e=null,i=a),e}function bi(){var e,n;return n=i,t.substr(i,5).toLowerCase()==="turns"?(e=t.substr(i,5),i+=5):(e=null,s===0&&l('"turns"')),e===null&&(t.substr(i,4).toLowerCase()==="turn"?(e=t.substr(i,4),i+=4):(e=null,s===0&&l('"turn"'))),e!==null&&(e=function(e,t){Li.scheme=t}(n,e)),e===null&&(i=n),e}function wi(){var e,n,r,o,u;o=i,u=i,e=ri();if(e!==null){t.substr(i,3).toLowerCase()==="udp"?(n=t.substr(i,3),i+=3):(n=null,s===0&&l('"udp"'));if(n===null){t.substr(i,3).toLowerCase()==="tcp"?(n=t.substr(i,3),i+=3):(n=null,s===0&&l('"tcp"'));if(n===null){n=[],r=S();while(r!==null)n.push(r),r=S()}}n!==null?e=[e,n]:(e=null,i=u)}else e=null,i=u;return e!==null&&(e=function(e){Li.transport=transport}(o)),e===null&&(i=o),e}function Ei(){var e,n,r;return r=i,t.substr(i,5)==="uuid:"?(e="uuid:",i+=5):(e=null,s===0&&l('"uuid:"')),e!==null?(n=Si(),n!==null?e=[e,n]:(e=null,i=r)):(e=null,i=r),e}function Si(){var e,n,r,o,u,a,f,c,h,p,d;return p=i,d=i,e=Ti(),e!==null?(t.charCodeAt(i)===45?(n="-",i++):(n=null,s===0&&l('"-"')),n!==null?(r=xi(),r!==null?(t.charCodeAt(i)===45?(o="-",i++):(o=null,s===0&&l('"-"')),o!==null?(u=xi(),u!==null?(t.charCodeAt(i)===45?(a="-",i++):(a=null,s===0&&l('"-"')),a!==null?(f=xi(),f!==null?(t.charCodeAt(i)===45?(c="-",i++):(c=null,s===0&&l('"-"')),c!==null?(h=Ni(),h!==null?e=[e,n,r,o,u,a,f,c,h]:(e=null,i=d)):(e=null,i=d)):(e=null,i=d)):(e=null,i=d)):(e=null,i=d)):(e=null,i=d)):(e=null,i=d)):(e=null,i=d)):(e=null,i=d),e!==null&&(e=function(e,n){Li=t.substring(i+5,e)}(p,e[0])),e===null&&(i=p),e}function xi(){var e,t,n,r,s;return s=i,e=d(),e!==null?(t=d(),t!==null?(n=d(),n!==null?(r=d(),r!==null?e=[e,t,n,r]:(e=null,i=s)):(e=null,i=s)):(e=null,i=s)):(e=null,i=s),e}function Ti(){var e,t,n;return n=i,e=xi(),e!==null?(t=xi(),t!==null?e=[e,t]:(e=null,i=n)):(e=null,i=n),e}function Ni(){var e,t,n,r;return r=i,e=xi(),e!==null?(t=xi(),t!==null?(n=xi(),n!==null?e=[e,t,n]:(e=null,i=r)):(e=null,i=r)):(e=null,i=r),e}function Ci(e){e.sort();var t=null,n=[];for(var r=0;r<e.length;r++)e[r]!==t&&(n.push(e[r]),t=e[r]);return n}function ki(){var e=1,n=1,r=!1;for(var s=0;s<Math.max(i,o);s++){var u=t.charAt(s);u==="\n"?(r||e++,n=1,r=!1):u==="\r"||u==="\u2028"||u==="\u2029"?(e++,n=1,r=!0):(n++,r=!1)}return{line:e,column:n}}var r={CRLF:c,DIGIT:h,ALPHA:p,HEXDIG:d,WSP:v,OCTET:m,DQUOTE:g,SP:y,HTAB:b,alphanum:w,reserved:E,unreserved:S,mark:x,escaped:T,LWS:N,SWS:C,HCOLON:k,TEXT_UTF8_TRIM:L,TEXT_UTF8char:A,UTF8_NONASCII:O,UTF8_CONT:M,LHEX:_,token:D,token_nodot:P,separators:H,word:B,STAR:j,SLASH:F,EQUAL:I,LPAREN:q,RPAREN:R,RAQUOT:U,LAQUOT:z,COMMA:W,SEMI:X,COLON:V,LDQUOT:$,RDQUOT:J,comment:K,ctext:Q,quoted_string:G,quoted_string_clean:Y,qdtext:Z,quoted_pair:et,SIP_URI_noparams:tt,SIP_URI:nt,uri_scheme:rt,userinfo:it,user:st,user_unreserved:ot,password:ut,hostport:at,host:ft,hostname:lt,domainlabel:ct,toplabel:ht,IPv6reference:pt,IPv6address:dt,h16:vt,ls32:mt,IPv4address:gt,dec_octet:yt,port:bt,uri_parameters:wt,uri_parameter:Et,transport_param:St,user_param:xt,method_param:Tt,ttl_param:Nt,maddr_param:Ct,lr_param:kt,other_param:Lt,pname:At,pvalue:Ot,paramchar:Mt,param_unreserved:_t,headers:Dt,header:Pt,hname:Ht,hvalue:Bt,hnv_unreserved:jt,Request_Response:Ft,Request_Line:It,Request_URI:qt,absoluteURI:Rt,hier_part:Ut,net_path:zt,abs_path:Wt,opaque_part:Xt,uric:Vt,uric_no_slash:$t,path_segments:Jt,segment:Kt,param:Qt,pchar:Gt,scheme:Yt,authority:Zt,srvr:en,reg_name:tn,query:nn,SIP_Version:rn,INVITEm:sn,ACKm:on,OPTIONSm:un,BYEm:an,CANCELm:fn,REGISTERm:ln,SUBSCRIBEm:cn,NOTIFYm:hn,Method:pn,Status_Line:dn,Status_Code:vn,extension_code:mn,Reason_Phrase:gn,Allow:yn,allow_method:bn,Allow_Events:wn,Call_ID:En,call_id:Sn,Contact:xn,contact_param:Tn,name_addr:Nn,display_name:Cn,contact_params:kn,c_p_q:Ln,c_p_expires:An,delta_seconds:On,qvalue:Mn,generic_param:_n,gen_value:Dn,Content_Disposition:Pn,disp_type:Hn,disp_param:Bn,handling_param:jn,Content_Encoding:Fn,Content_Length:In,Content_Type:qn,media_type:Rn,m_type:Un,discrete_type:zn,composite_type:Wn,extension_token:Xn,x_token:Vn,m_subtype:$n,m_parameter:Jn,m_value:Kn,CSeq:Qn,CSeq_value:Gn,Expires:Yn,Event:Zn,event_type:er,From:tr,from_param:nr,tag_param:rr,Max_Forwards:ir,Min_Expires:sr,Min_SE:or,Name_Addr_Header:ur,Proxy_Authenticate:ar,challenge:fr,other_challenge:lr,auth_param:cr,digest_cln:hr,realm:pr,realm_value:dr,domain:vr,URI:mr,nonce:gr,nonce_value:yr,opaque:br,stale:wr,algorithm:Er,qop_options:Sr,qop_value:xr,Proxy_Require:Tr,option_tag:Nr,Record_Route:Cr,rec_route:kr,Refer_To:Lr,Require:Ar,Route:Or,route_param:Mr,Session_Expires:_r,se_param:Dr,refresher_param:Pr,Subscription_State:Hr,substate_value:Br,subexp_params:jr,event_reason_value:Fr,Subject:Ir,Supported:qr,Target_Dialog:Rr,td_param:Ur,remote_param:zr,local_param:Wr,To:Xr,to_param:Vr,Via:$r,via_parm:Jr,via_params:Kr,via_ttl:Qr,via_maddr:Gr,via_received:Yr,via_branch:Zr,response_port:ei,sent_protocol:ti,protocol_name:ni,transport:ri,sent_by:ii,via_host:si,via_port:oi,ttl:ui,WWW_Authenticate:ai,extension_header:fi,header_value:li,message_body:ci,stun_URI:hi,stun_scheme:pi,stun_host_port:di,stun_host:vi,reg_name:tn,stun_unreserved:mi,sub_delims:gi,turn_URI:yi,turn_scheme:bi,turn_transport:wi,uuid_URI:Ei,uuid:Si,hex4:xi,hex8:Ti,hex12:Ni};if(n!==undefined){if(r[n]===undefined)throw new Error("Invalid rule name: "+e(n)+".")}else n="CRLF";var i=0,s=0,o=0,u=[],Li={},Ai=r[n]();if(Ai===null||i!==t.length){var Oi=Math.max(i,o),Mi=Oi<t.length?t.charAt(Oi):null,_i=ki();return new this.SyntaxError(Ci(u),Mi,Oi,_i.line,_i.column),-1}return Li},toSource:function(){return this._source}};return t.SyntaxError=function(t,n,r,i,s){function o(t,n){var r,i;switch(t.length){case 0:r="end of input";break;case 1:r=t[0];break;default:r=t.slice(0,t.length-1).join(", ")+" or "+t[t.length-1]}return i=n?e(n):"end of input","Expected "+r+" but "+i+" found."}this.name="SyntaxError",this.expected=t,this.found=n,this.message=o(t,n),this.offset=r,this.line=i,this.column=s},t.SyntaxError.prototype=Error.prototype,t}(),r("src/presence",["underscore","EventEmitter","wampy","logger","jssip","./network-api"],function(e,t,n,r,i,s){function l(t){e.each(t,function(e){var t=i.URI.parse("sip:"+e.user);t.hasParam("gr")?(e.device=e.user,e.user=t.toAor().replace(/^sip:/,"")):e.device=null})}var o=r.get("SDK:Presence"),u="http://sdk.acision.com/presence/v1.1/",a="1.1",f=300,c=function(e){var t=e.config.interfaces.presence,n=null,r=null;t&&(n=t.wsEndpoints[a],r=t.restEndpoints[a]),this.init(e,!!t,n,r),this.callbacks={},this.refreshPresentity={},this.fieldTtl={},this.refreshInterval={}};return c.prototype=new s(u),c.prototype.constructor=c,c.prototype.disconnect=function(){this._stopAllRefreshTimers(),s.prototype.disconnect.call(this)},c.prototype._mergeFields=function(t,n){var r=this;e.each(t,function(e,t){e?(r.refreshPresentity[t]=e,r.fieldTtl[t]=n):(delete r.refreshPresentity[t],delete r.fieldTtl[t])},this)},c.prototype.getPresentities=function(t,n,r){if(!t||!r)throw new Error("Missing parameters");if(e.isEmpty(t))throw new Error("Invalid parameters");var i={};e.isArray(t)||(t=[t]),i.users=t,n&&(e.isArray(n)||(n=[n]),i.fields=n),this.sendRequest("POST","getPresentities",i,function(t){o.debug("getPresentities succeeded"),e.isFunction(r.onSuccess)&&(l(t),r.onSuccess(t))},function(t){o.debug("getPresentities failed"),e.isFunction(r.onError)&&r.onError(t.code,t.message)})},c.prototype.getPresentitiesForGroups=function(t,n,r){if(!t||!r)throw new Error("Missing parameters");if(e.isEmpty(t))throw new Error("Invalid parameters");var i={};e.isArray(t)||(t=[t]),i.groups=t,n&&(e.isArray(n)||(n=[n]),i.fields=n),this.sendRequest("POST","getPresentities",i,function(t){o.debug("getPresentitiesForGroups succeeded"),e.isFunction(r.onSuccess)&&(l(t),r.onSuccess(t))},function(t){o.debug("getPresentitiesForGroups failed"),e.isFunction(r.onError)&&r.onError(t.code,t.message)})},c.prototype.getAllPresentities=function(t,n,r){if(!t||!r)throw new Error("Missing parameters");if(e.isEmpty(t))throw new Error("Invalid parameters");var i={};e.isArray(t)||(t=[t]),i.addresses=t,n&&(e.isArray(n)||(n=[n]),i.fields=n),this.sendRequest("POST","getAllPresentities",i,function(t){o.debug("getAllPresentities succeeded"),e.isFunction(r.onSuccess)&&(l(t),r.onSuccess(t))},function(t){o.debug("getAllPresentities failed"),e.isFunction(r.onError)&&r.onError(t.code,t.message)})},c.prototype.getAllPresentitiesForGroups=function(t,n,r){if(!t||!r)throw new Error("Missing parameters");if(e.isEmpty(t))throw new Error("Invalid parameters");var i={};e.isArray(t)||(t=[t]),i.groups=t,n&&(e.isArray(n)||(n=[n]),i.fields=n),this.sendRequest("POST","getAllPresentities",i,function(t){o.debug("getAllPresentitiesForGroups succeeded"),e.isFunction(r.onSuccess)&&(l(t),r.onSuccess(t))},function(t){o.debug("getAllPresentitiesForGroups failed"),e.isFunction(r.onError)&&r.onError(t.code,t.message)})},c.prototype.setOwnPresentity=function(t,n,r){var i=this;if(!t)throw new Error("Missing parameters");if(!e.isObject(t)||n&&!e.isObject(n)||r&&!e.isObject(r))throw new Error("Invalid parameters");n=e.defaults({},n,{refresh:!0});var s=n.ttl,u={};u.user=this.sdk.config.primaryAddress,u.device=this.sdk.uuid,u.fields=t,!e.isUndefined(s)&&s!==null?u.ttl=s:e.isUndefined(this.sdk.config.presenceTTL)||(u.ttl=this.sdk.config.presenceTTL),this.sendRequest("POST","setPresentity",u,function(u){o.debug("setOwnPresentity succeeded");if(n.refresh){var a=f;e.isUndefined(u.refreshDelay)||(a=u.refreshDelay),i._mergeFields(t,s),i._checkRefreshTimer(s,a)}r&&e.isFunction(r.onSuccess)&&r.onSuccess()},function(t){o.warn("setOwnPresentity failed"),r&&e.isFunction(r.onError)&&r.onError(t.code,t.message)})},c.prototype.deleteOwnPresentity=function(t){var n=this,r={};r.user=this.sdk.config.primaryAddress,r.device=this.sdk.uuid,this.sendRequest("POST","deletePresentity",r,function(){o.debug("deleteOwnPresentity succeeded"),n._stopAllRefreshTimers(),n.refreshPresentity={},t&&e.isFunction(t.onSuccess)&&t.onSuccess()},function(n){o.warn("deleteOwnPresentity failed"),t&&e.isFunction(t.onError)&&t.onError(n.code,n.message)})},c.prototype.refreshOwnPresentity=function(t,n,r){var i=this;if(!t)throw new Error("Missing parameters");if(!e.isObject(t)||n&&!e.isObject(n)||r&&!e.isObject(r))throw new Error("Invalid parameters");n=e.defaults({},n,{refresh:!0});var s=n.ttl,u={};u.user=this.sdk.config.primaryAddress,u.device=this.sdk.uuid,u.fields=t,!e.isUndefined(s)&&s!==null?u.ttl=s:e.isUndefined(this.sdk.config.presenceTTL)||(u.ttl=this.sdk.config.presenceTTL),this.sendRequest("POST","refreshPresentity",u,function(u){o.debug("refreshOwnPresentity succeeded");if(n.refresh){var a=f;e.isUndefined(u.refreshDelay)||(a=u.refreshDelay),i._mergeFields(t,s),i._checkRefreshTimer(s,a)}r&&e.isFunction(r.onSuccess)&&r.onSuccess()},function(t){o.warn("refreshOwnPresentity failed"),r&&e.isFunction(r.onError)&&r.onError(t.code,t.message)})},c.prototype._checkRefreshTimer=function(t,n){var r=e.contains(this.fieldTtl,t),i=this.refreshInterval[t];if(r){if(i)return;this._startRefreshTimer(t,n);return}this._stopRefreshTimer(t)},c.prototype._startRefreshTimer=function(t,n){var r=this;o.debug("Starting refresh interval for TTL "+t),this.refreshInterval[t]=setInterval(function(){if(!r.refreshInterval[t])return;var n=e.pick(r.refreshPresentity,function(e,n){return r.fieldTtl[n]===t});e.isEmpty(n)?r._stopRefreshTimer(t):r.refreshOwnPresentity(n,{ttl:t})},n*1e3)},c.prototype._stopRefreshTimer=function(e){this.refreshInterval[e]&&(o.debug("Stopping refresh interval for TTL "+e),clearInterval(this.refreshInterval[e]),delete this.refreshInterval[e])},c.prototype._stopAllRefreshTimers=function(){var t=this,n=e.keys(this.refreshInterval);e.each(n,function(e){t._stopRefreshTimer(e)})},c.prototype.subscribe=function(t,n,r){if(!this.ws)throw new Error("Cannot subscribe to presentity updates for a non-persistent connection.");if(!t)throw new Error("Missing parameters");if(e.isEmpty(t))throw new Error("Invalid parameters");var i={};e.isArray(t)||(t=[t]),i.users=t,n&&(e.isArray(n)||(n=[n]),i.fields=n),this.sendRequest("POST","subscribe",i,function(){o.debug("subscribe succeeded"),r&&e.isFunction(r.onSuccess)&&r.onSuccess()},function(t){o.debug("subscribe failed"),r&&e.isFunction(r.onError)&&r.onError(t.code,t.message)})},c.prototype.subscribeToGroups=function(t,n,r){if(!this.ws)throw new Error("Cannot subscribe to presentity updates for a non-persistent connection.");if(!t)throw new Error("Missing parameters");if(e.isEmpty(t))throw new Error("Invalid parameters");var i={};e.isArray(t)||(t=[t]),i.groups=t,n&&(e.isArray(n)||(n=[n]),i.fields=n),this.sendRequest("POST","subscribe",i,function(){o.debug("subscribeToGroups succeeded"),r&&e.isFunction(r.onSuccess)&&r.onSuccess()},function(t){o.debug("subscribeToGroups failed"),r&&e.isFunction(r.onError)&&r.onError(t.code,t.message)})},c.prototype.unsubscribe=function(t,n){if(!this.ws)throw new Error("Cannot subscribe to presentity updates for a non-persistent connection.");var r={};t&&(e.isArray(t)||(t=[t]),r.users=t),this.sendRequest("POST","unsubscribe",r,function(){o.debug("unsubscribe succeeded"),n&&e.isFunction(n.onSuccess)&&n.onSuccess()},function(t){o.debug("unsubscribe failed"),n&&e.isFunction(n.onError)&&n.onError(t.code,t.message)})},c.prototype.unsubscribeFromGroups=function(t,n){if(!this.ws)throw new Error("Cannot subscribe to presentity updates for a non-persistent connection.");if(!t)throw new Error("Missing parameters");if(e.isEmpty(t))throw new Error("Invalid parameters");var r={};e.isArray(t)||(t=[t]),r.groups=t,this.sendRequest("POST","unsubscribe",r,function(){o.debug("unsubscribeFromGroups succeeded"),n&&e.isFunction(n.onSuccess)&&n.onSuccess()},function(t){o.debug("unsubscribeFromGroups failed"),n&&e.isFunction(n.onError)&&n.onError(t.code,t.message)})},c.prototype.setCallbacks=function(e){if(!this.ws)throw new Error("Cannot set callbacks for a non-persistent connection.");if(!e)throw new Error("Missing parameters");this.callbacks=e,e.onPresentity&&this.ws.subscribe(u+"presentity",function(t){l(t),e.onPresentity(t)})},c}),r("src/webrtc/sdp",["logger"],function(e){function i(e){return new Date((parseInt(e,10)-r)*1e3)}function s(e){return parseInt(e.getTime()/1e3,10)+r}function o(e){return e.replace(/%00/g,"\0").replace(/%0A/gi,"\n").replace(/%0D/gi,"\r").replace(/%22/g,'"').replace(/%25/g,"%")}function u(e){if(e){if(!this.parse(e))return null}else this.reset()}function a(e){if(e){if(!this.parse(e))return null}else this.reset()}function f(e){if(e){if(!this.parse(e))return null}else this.reset()}function l(e){if(e){if(!this.parse(e))return null}else this.reset()}function c(e){if(e){if(!this.parse(e))return null}else this.reset()}var t=e.get("SDK:RTC:SDP"),n="\r\n",r=2208988800;return u.prototype.reset=function(){this.version=0,this.origin=new a,this.sessionName=" ",this.sessionInfo=null,this.uri=null,this.email=null,this.phone=null,this.connection=new f,this.bandwidth=[],this.timing=[new l],this.timezone=null,this.key=null,this.resetAttributes(),this.media=[]},u.prototype.addAttribute=function(e,t){this.attributes[e]||(this.attributes[e]=[],this.attributeNameOrder.push(e)),this.attributes[e].push(t)},u.prototype.removeAttribute=function(e){this.attributes[e]&&(delete this.attributes[e],this.attributeNameOrder.splice(this.attributeNameOrder.indexOf(e),1))},u.prototype.replaceAttribute=function(e,t,n){this.attributes[e]&&(delete this.attributes[e],this.addAttribute(t,n),this.attributeNameOrder.splice(this.attributeNameOrder.lastIndexOf(t),1),this.attributeNameOrder.splice(this.attributeNameOrder.indexOf(e),1,t))},u.prototype.resetAttributes=function(){this.attributeNameOrder=[],this.attributes={}},u.prototype.parse=function(e){var r,i=e.split(n),s,o,u;this.reset(),i[i.length-1]===""&&i.pop();if(i.length<4)return t.log("Unexpected SDP length: "+i.length),!1;r=i.shift();if(r!=="v=0")return t.log("Unexpected SDP version: "+r),!1;r=i.shift();if(r.substr(0,2)!=="o="||!(this.origin=new a(r.substr(2))))return t.log("Unexpected SDP origin: "+r),!1;r=i.shift();if(r.substr(0,2)!=="s=")return t.log("Unexpected SDP session name: "+r),!1;this.sessionName=r.substr(2);while(i.length>0&&i[0].charAt(0)!=="t"){r=i.shift(),s=r.substr(2);switch(r.substr(0,2)){case"i=":this.sessionInfo=s;break;case"u=":this.uri=s;break;case"e=":this.email=s;break;case"p=":this.phone=s;break;case"c=":s=new f(s);if(!s)return!1;this.connection=s;break;case"b=":this.bandwidth.push(s);break;default:return t.log("Unexpected SDP line (pre-timing): "+r),!1}}if(i.length===0)return t.log("Unexpected end of SDP (pre-timing)"),!1;this.timing=[];while(i.length>0&&i[0].charAt(0)==="t"){r=i.shift().substr(2);while(i.length>0&&i[0].charAt(0)==="r")r+=n+i.shift();s=new l(r);if(!s)return!1;this.timing.push(s)}if(this.timing.length===0)return t.log("No timing line found"),!1;while(i.length>0&&i[0].charAt(0)!=="m"){r=i.shift(),s=r.substr(2);switch(r.substr(0,2)){case"z=":this.timezone=s;break;case"k=":this.key=s;break;case"a=":o=s.indexOf(":"),o===-1?(u=s,s=null):(u=s.substr(0,o),s=s.substr(o+1)),this.addAttribute(u,s);break;default:return t.log("Unexpected SDP line (pre-media): "+r),!1}}while(i.length>0&&i[0].charAt(0)==="m"){r=i.shift().substr(2);while(i.length>0&&i[0].charAt(0)!=="m")r+=n+i.shift();s=new c(r);if(!s)return!1;this.media.push(s)}return!0},u.prototype.toString=function(){var e="",t,r,i;e+="v="+this.version+n,e+="o="+this.origin+n,e+="s="+this.sessionName+n,this.sessionInfo&&(e+="i="+this.sessionInfo+n),this.uri&&(e+="u="+this.uri+n),this.email&&(e+="e="+this.email+n),this.phone&&(e+="p="+this.phone+n),this.connection&&(e+="c="+this.connection+n);for(t in this.bandwidth)e+="b="+this.bandwidth[t]+n;for(t in this.timing)e+="t="+this.timing[t]+n;this.timezone&&(e+="z="+this.timezone+n),this.key&&(e+="k="+this.key+n);for(var s=0,o=this.attributeNameOrder.length;s<o;s++){r=this.attributeNameOrder[s],i=this.attributes[r];for(t in i)e+="a="+r,i[t]&&(e+=":"+i[t]),e+=n}for(t in this.media)e+="m="+this.media[t]+n;return e},u.prototype.isHeld=function(){var e,t,n;for(e=0,t=this.media.length;e<t;e++){n=this.media[e];switch(n.media){case"audio":case"video":if(n.isReceiving())return!1}}return!0},a.prototype.reset=function(){this.username="-",this.id=s(new Date),this.version=this.sessId,this.netType="IN",this.addrType="IP4",this.address="address.invalid"},a.prototype.parse=function(e){var n;return n=e.split(" "),n.length!==6?(t.log("Unexpected origin line: "+e),!1):(this.username=n[0],this.id=n[1],this.version=n[2],this.netType=n[3],this.addrType=n[4],this.address=n[5],!0)},a.prototype.toString=function(){var e="";return e+=this.username+" ",e+=this.id+" ",e+=this.version+" ",e+=this.netType+" ",e+=this.addrType+" ",e+=this.address,e},f.prototype.reset=function(){this.netType="IN",this.addrType="IP4",this.address="address.invalid"},f.prototype.parse=function(e){var n;return n=e.split(" "),n.length!==3?(t.log("Unexpected connection line: "+e),!1):(this.netType=n[0],this.addrType=n[1],this.address=n[2],!0)},f.prototype.toString=function(){var e="";return e+=this.netType+" ",e+=this.addrType+" ",e+=this.address,e},l.prototype.reset=function(){this.start=null,this.stop=null,this.repeat=[]},l.prototype.parse=function(e){var r,s,o;return r=e.split(n),s=r.shift(),o=s.split(" "),o.length!==2?(t.log("Unexpected timing line: "+s),!1):(o[0]==="0"?this.start=null:this.start=i(o[0]),o[1]==="0"?this.stop=null:this.stop=i(o[1]),this.repeat=r,!0)},l.prototype.toString=function(){var e="",t;this.start?e+=s(this.start):e+="0",e+=" ",this.stop?e+=s(this.stop):e+="0";for(t in this.repeat)e+=n+this.repeat[t];return e},c.prototype.reset=function(){this.media="message",this.port=2855,this.proto="TCP/MSRP",this.format="*",this.title=null,this.connection=null,this.bandwidth=[],this.key=null,this.resetAttributes()},c.prototype.addAttribute=function(e,t){this.attributes[e]||(this.attributes[e]=[],this.attributeNameOrder.push(e)),this.attributes[e].push(t)},c.prototype.removeAttribute=function(e){this.attributes[e]&&(delete this.attributes[e],this.attributeNameOrder.splice(this.attributeNameOrder.indexOf(e),1))},c.prototype.resetAttributes=function(){this.attributeNameOrder=[],this.attributes={}},c.prototype.replaceAttribute=function(e,t,n){this.attributes[e]&&(delete this.attributes[e],this.addAttribute(t,n),this.attributeNameOrder.splice(this.attributeNameOrder.lastIndexOf(t),1),this.attributeNameOrder.splice(this.attributeNameOrder.indexOf(e),1,t))},c.prototype.parse=function(e){var r,i,s,o,u;this.reset(),r=e.split(n),i=r.shift(),s=i.split(" ");if(s.length<4)return t.log("Unexpected media line: "+i),!1;this.media=s.shift(),this.port=parseInt(s.shift(),10),this.proto=s.shift(),this.format=s.join(" ");for(o in r){var a=r[o].substr(2),l;switch(r[o].substr(0,2)){case"i=":this.title=a;break;case"c=":this.connection=new f(a);if(!this.connection)return!1;break;case"b=":this.bandwidth.push(a);break;case"k=":this.key=a;break;case"a=":l=a.indexOf(":"),l===-1?(u=a,a=null):(u=a.substr(0,l),a=a.substr(l+1)),this.addAttribute(u,a);break;default:return t.log("Unexpected type (within media): "+r[o]),!1}}return!0},c.prototype.toString=function(){var e="",t,r,i;e+=this.media+" ",e+=this.port+" ",e+=this.proto+" ",e+=this.format,this.title&&(e+=n+"i="+this.title),this.connection&&(e+=n+"c="+this.connection);for(t in this.bandwidth)e+=n+"b="+this.bandwidth[t];this.key&&(e+=n+"k="+this.key);for(var s=0,o=this.attributeNameOrder.length;s<o;s++){r=this.attributeNameOrder[s],i=this.attributes[r];for(t in i)e+=n+"a="+r,i[t]&&(e+=":"+i[t])}return e},c.prototype.parseFileAttributes=function(){var e={},t=0,n={},r,i,s,u;if(!this.attributes["file-selector"])return null;var a=this.attributes["file-selector"][0];while(t<a.length){if(a.charAt(t)===" "){t++;continue}r=a.indexOf(":",t);if(r===-1)break;i=a.slice(t,r),t=r+1;if(a.charAt(t)==='"'){t++,u=a.indexOf('"',t);if(u===-1)break;s=a.slice(t,u),t=u+1}else if(i==="type"){var f=!1;u=t;while(u<a.length&&(f||a.charAt(u)!==" "))a.charAt(u)==='"'&&(f=!f),u++;s=a.slice(t,u),t=u+1}else u=a.indexOf(" ",t),u===-1&&(u=a.length),s=a.slice(t,u),t=u+1;switch(i){case"name":n.name=o(s);break;case"size":n.size=parseInt(s,10);break;case"type":n.type=s;break;case"hash":n.hash||(n.hash={}),r=s.indexOf(":"),n.hash[s.substring(0,r)]=s.substring(r+1);break;default:continue}}return e.selector=n,e.id=this.attributes["file-transfer-id"][0],e.disposition=this.attributes["file-disposition"][0]||"render",this.title&&(e.description=this.title),this.attributes["file-icon"]&&(e.icon=this.attributes["file-icon"][0]),e},c.prototype.isSending=function(){return this.attributes.recvonly||this.attributes.inactive?!1:!0},c.prototype.isReceiving=function(){return this.attributes.sendonly||this.attributes.inactive?!1:!0},{Session:u}}),r("src/webrtc/stream-config",["logger","underscore","./sdp"],function(e,t,n){var r=["audio","video"],i=["audioIn","audioOut","videoIn","videoOut"],s=["mandatoryVideoConstraints","optionalVideoConstraints"],o={audioIn:!0,audioOut:!0,videoIn:!1,videoOut:!1},u=function(e,r){if(e instanceof n.Session){this.fromSdp(e);return}e||(e=o);if(typeof e!="object")throw new TypeError("Unexpected streamConfig type: "+typeof e);r&&t.each(s,function(e){r[e]&&(this[e]=r[e])},this),t.each(i,function(t){e[t]?this[t]=!0:this[t]=!1},this),t.each(s,function(t){e[t]&&(this[t]=e[t])},this)};return u.prototype.fromSdp=function(e){t.each(r,function(e){this[e+"In"]=!1,this[e+"Out"]=!1},this),t.each(e.media,function(e){r.indexOf(e.media)!==-1&&e.port!==0&&(this[e.media+"In"]=e.isSending(),this[e.media+"Out"]=e.isReceiving())},this)},u.prototype.isSending=function(){return this.audioOut||this.videoOut?!0:!1},u.prototype.getSendingStreams=function(){var e=[];return t.each(r,function(t){this[t+"Out"]&&e.push(t)},this),e},u.prototype.hold=function(){var e=[];return t.each(r,function(t){this[t+"In"]&&(e.push(t),this[t+"In"]=!1)},this),e},u.prototype.resume=function(e){t.each(r,function(t){e.indexOf(t)>=0&&(this[t+"In"]=!0)},this)},u.prototype.equals=function(e){return t.every(i,function(t){return this[t]===e[t]},this)},u.prototype.sendingStreamsEqual=function(e){return t.every(r,function(t){return this[t+"Out"]===e[t+"Out"]},this)},u.prototype.isSafeChange=function(e){return t.every(r,function(t){return!e[t+"Out"]||this[t+"Out"]},this)},u}),r("src/webrtc/util",["logger","jssip"],function(e,t){var n=e.get("SDK:RTC:Util"),r={},i={string:String,"boolean":Boolean,number:Number,"function":Function};r.isType=function(e,t){if(t.lastIndexOf("[]")===-1){if(typeof e===t)return!0;if(typeof e=="object"&&e instanceof i[t])return!0}else if(e instanceof Array){var n=t.slice(0,-2);for(var s=0,o=e.length;s<o;s++)if(!r.isType(e[s],n))return!1;return!0}return!1},r.jsSipCauseToSdkStatus=function(e){switch(e){case t.C.causes.BUSY:return"normal";case t.C.causes.CONNECTION_ERROR:return"error";case t.C.causes.REQUEST_TIMEOUT:return"offline";case t.C.causes.REJECTED:return"blocked";case t.C.causes.NOT_FOUND:return"notfound";case t.C.causes.UNAVAILABLE:return"offline";default:return"normal"}};var s={options:{normal:200,blocked:403,notfound:404,offline:480},invite:{normal:486,blocked:403,notfound:404,offline:480}};return r.sdkStatusToSipStatus=function(e,t){return s[e][t]},r.fireEvent=function(e,t,r,i){if(i||e.hasOwnProperty(t))try{n.log("Firing event "+e.constructor.name+"."+t+":",r),e[t](r)}catch(s){n.warn(e.constructor.name+"."+t+" handler threw exception:\n",s.stack)}else n.log("No handler registered for event "+e.constructor.name+"."+t+":",r)},r}),r("src/webrtc/custom-headers",["logger","jssip","./util"],function(e,t,n){function i(e){if(e instanceof t.IncomingRequest)this.fromJsSipHeaders(e.headers);else if(e instanceof t.OutgoingRequest)this.fromExtraHeaders(e.extraHeaders);else if(e){var n,i;for(n in e)i=e[n],this.isValidCustomHeader(n,i)?this[n]=i:r.warn("Ignored custom header:",n,i)}}var r=e.get("SDK:RTC:CustomHeaders");return i.prototype.isValidCustomHeader=function(e,t){var r=/[^a-zA-Z0-9\-\.!%\*_\+`'~]/;return e.match(r)?!1:n.isType(t,"string")?t.match(/[\r\n]/)?!1:!0:!1},i.prototype.equals=function(e){var t=Object.keys(this);if(t.length!==Object.keys(e).length)return!1;for(var n=0,r=t.length;n<r;n++){var i=t[n];if(e[i]!==this[i])return!1}return!0},i.prototype.fromJsSipHeaders=function(e){for(var t in e)if(t.slice(0,2).toUpperCase()==="X-"){var n=e[t][0].raw;this.isValidCustomHeader(t,n)?this[t.slice(2)]=n:r.warn("Ignored custom header:",t,n)}},i.prototype.fromExtraHeaders=function(e){for(var t=0,n=e.length;t<n;t++){var r=e[t],i=r.match(/([^:]*)\s*:\s*(.*)/),s=i[1],o=i[2];s.slice(0,2).toUpperCase()==="X-"&&this.isValidCustomHeader(s,o)&&(this[s.slice(2)]=o)}},i.prototype.toExtraHeaders=function(){var e=[],t=Object.keys(this);for(var n=0,i=t.length;n<i;n++){var s=t[n],o=this[s];this.isValidCustomHeader(s,o)?e.push("X-"+s+": "+o):r.warn("Ignored invalid custom header:",s,o)}return e},i.prototype.isEmpty=function(){var e=Object.keys(this);return e.length===0},i}),r("src/webrtc/exceptions",[],function(){var e={},t=function(e){var t=new Error;t.stack&&(this.stack=t.stack),this.message=e||"Unexpected value error"};t.prototype=new Error,t.prototype.constructor=t,t.prototype.name="ValueError";var n=function(e){var t=new Error;t.stack&&(this.stack=t.stack),this.message=e||"Unexpected state error"};n.prototype=new Error,n.prototype.constructor=n,n.prototype.name="StateError";var r=function(e){var t=new Error;t.stack&&(this.stack=t.stack),this.message=e||"Version error"};r.prototype=new Error,r.prototype.constructor=r,r.prototype.name="VersionError";var i=function(e){var t=new Error;t.stack&&(this.stack=t.stack),this.message=e||"Unsupported error"};return i.prototype=new Error,i.prototype.constructor=i,i.prototype.name="UnsupportedError",e.ValueError=t,e.StateError=n,e.VersionError=r,e.UnsupportedError=i,e}),r("src/webrtc/session",["logger","underscore","EventEmitter","jssip","./sdp","./stream-config","./custom-headers","./exceptions","./util"],function(e,t,n,r,i,s,o,u,a){function c(e,t){var n=new i.Session(e.sdp),r=["sendrecv","sendonly","recvonly","inactive"],s,o,u=!1;for(var a in n.media){var f=n.media[a],l=t[f.media+"Out"],c=t[f.media+"In"];if(f.media==="application")continue;s=null;for(var h in r)f.attributes[r[h]]&&(s=r[h]);s===null&&(s="sendrecv",f.addAttribute(s,null),u=!0),l?c?o="sendrecv":o="sendonly":c?o="recvonly":o="inactive",s!==o&&(f.replaceAttribute(s,o,null),u=!0)}u&&(e.sdp=n.toString())}function h(e){var t=e,n=navigator.userAgent.match(/Chrome\/([0-9]*)/);if(n&&parseInt(n[1],10)<37){var r=t.match(/a=ssrc-group:FID.* ([0-9]+)\r?\n/);if(r&&r.length>=2){var i=r[1];t=t.replace(/a=rtpmap:96 rtx.*\r?\n/,""),t=t.replace(/a=fmtp:96 apt=100.*\r?\n/,""),t=t.replace(/a=ssrc-group:FID.*\r?\n/,"");var s=new RegExp("a=ssrc:"+i+".*\r?\n","g");t=t.replace(s,"")}}return t}function p(e){return/Firefox/.test(navigator.userAgent)?t.map(e,function(e){return t.isArray(e.urls)?e.url=e.urls[0]:e.url=e.urls,e}):e}function d(e,t){var n=Date.now(),r=!1,i=setTimeout(function(){l.log("Proceeding without null candidate!",Date.now()-n),i=null,r||(r=!0,t())},5e3);e.onicecandidate=function(e){l.log("onicecandidate",Date.now()-n,e.candidate),e.candidate||(i&&(clearTimeout(i),i=null),this.onicecandidate=null,r||(r=!0,t()))}}function v(e){var t=function(){l.log("PC: signalling state change:",this.signalingState)};"onsignalingstatechange"in e?e.onsignalingstatechange=t:"onstatechange"in e&&(e.onstatechange=t);var n=function(){l.log("PC: ICE connection state change:",this.iceConnectionState)};"oniceconnectionstatechange"in e?e.oniceconnectionstatechange=n:"onicechange"in e&&(e.onicechange=n)}function m(e,t){e.srcObject=t,window.URL.createObjectURL&&(e.src=window.URL.createObjectURL(t)),e.play()}var f={PENDING:"pending",ESTABLISHED:"established",CLOSED:"closed"},l=e.get("SDK:RTC:Session"),g=function(e,t,n,i,s){this.webrtcApi=e,this.sipSession=t,this.state=f.PENDING,this.peerConnection=new r.WebRTC.RTCPeerConnection({iceServers:p(i)},s),this.videoConstraints=null,this.audioConstraints=null,this.localStream=null,this.externalStream=!1,this.accepted=!1,this.offerOutstanding=!1,this.remoteHold=!1,this.remoteHoldStreams=null,this.localHold=!1,this.localHoldStreams=null,this.dtmfSender=null,this.transferFeedback=null,this.address=n,this.displayName=null,this.customHeaders=null,this.streamConfig=null,this.remoteAudioElement=null,this.remoteVideoElement=null,this.localVideoElement=null,v(this.peerConnection),this.peerConnection.onnegotiationneeded=this._handleNegotiationNeeded.bind(this),this.peerConnection.onaddstream=this._handleAddStream.bind(this),this.peerConnection.onremovestream=this._handleRemoveStream.bind(this);var o=this;t.on("progress",function(){a.fireEvent(o,"onProvisional",{})}),t.on("started",this._handleStarted.bind(this)),t.on("ended",function(e){var t=e.data;if(t.originator!=="local"){var n=a.jsSipCauseToSdkStatus(t.cause);o.sipSession=null,o.close(n)}}),t.on("failed",function(e){var t=a.jsSipCauseToSdkStatus(e.data.cause);o.sipSession=null,o.close(t)}),t.on("reinvite",this._handleReinvite.bind(this)),t.on("refresh",this._handleRefresh.bind(this))};g.prototype=new n,g.prototype.constructor=g,g.prototype._getUserMedia=function(e,t){var n=this,i=e||this.streamConfig,s={audio:i.audioOut,video:i.videoOut};i.videoOut&&(i.mandatoryVideoConstraints||i.optionalVideoConstraints)&&(s.video={mandatory:i.mandatoryVideoConstraints||{},optional:i.optionalVideoConstraints||[]});var o=n.localStream;o&&(n.peerConnection.removeStream(o),o.stop(),n.localStream=null);var u=function(e){if(n.state===f.CLOSED){e.stop();return}var r=n.localVideoElement;l.log("Got local media stream"),n.localStream=e,n.peerConnection.addStream(e),s.video&&r&&(m(r,e),r.muted=!0),t()},c=function(e){l.warn("getUserMedia failed:",e),n.close()};s.audio&&(this.audioConstraints&&a.isType(s.audio,"boolean")?s.audio=this.audioConstraints:a.isType(s.audio,"object")&&(this.audioConstraints=s.audio)),s.video&&(this.videoConstraints&&a.isType(s.video,"boolean")?s.video=this.videoConstraints:a.isType(s.video,"object")&&(this.videoConstraints=s.video));if(!s.audio&&!s.video){setTimeout(function(){t()},0);return}l.log("Requesting user media:",s),r.WebRTC.getUserMedia(s,u,c)},g.prototype._createOffer=function(e,t){var n=this,r=this.peerConnection,i=e||this.streamConfig,s=function(){l.log("Local description set, ice gathering state:",r.iceGatheringState),r.iceGatheringState==="complete"?t():d(r,t)},o=function(e){l.warn("setLocalDescription failed:",e),n.close()},u=function(e){l.log("Offer created"),c(e,i),r.setLocalDescription(e,s,o)},a=function(e){l.warn("createOffer failed:",e),n.close()},f={mandatory:{OfferToReceiveAudio:i.audioIn,OfferToReceiveVideo:i.videoIn}};/Chrome/.test(navigator.userAgent)&&(f.mandatory.OfferToReceiveAudio=!0,f.mandatory.OfferToReceiveVideo=!0);try{r.createOffer(u,a,f)}catch(h){l.warn("createOffer failed:",h.stack),n.close()}},g.prototype._createAnswer=function(e){var t=this,n=this.peerConnection,r=function(){l.log("Local description set, ice gathering state:",n.iceGatheringState),n.iceGatheringState==="complete"?e():d(n,e)},i=function(e){l.warn("setLocalDescription failed:",e),t.close()},s=function(e){l.log("Answer created"),c(e,t.streamConfig),n.setLocalDescription(e,r,i)},o=function(e){l.warn("createOffer failed:",e),t.close()},u=null;n.createAnswer(s,o,u)},g.prototype._updateIceServers=function(e){this.peerConnection.updateIce({iceServers:p(e)})},g.prototype._setRemoteStreamOutput=function(){var e,t=this.peerConnection;if(this.hasOwnProperty("onAddStream"))return;t.getRemoteStreams?e=t.getRemoteStreams():e=t.remoteStreams;for(var n=0,r=e.length;n<r;n++)this._handleAddStream({stream:e[n]})},g.prototype._handleAddStream=function(e){a.fireEvent(this,"onAddStream",e,!0)},g.prototype._handleRemoveStream=function(e){a.fireEvent(this,"onRemoveStream",e,!1)},g.prototype._connect=function(e,t,n){var r=this;this.streamConfig=t||new s,this.customHeaders=new o(n),e?(this.setLocalStream(e),this._sendInvite()):this._getUserMedia(null,function(){r._sendInvite()})},g.prototype._sendInvite=function(){var e=this;this._createOffer(null,function(){var t={};t.sdp=e.peerConnection.localDescription.sdp,t.extraHeaders=e.customHeaders.toExtraHeaders(),e.sipSession.connect(e.address,t),a.fireEvent(e,"onConnecting",{})})},g.prototype._sendReinvite=function(e,t){var n=this;t=t||this.customHeaders,this._createOffer(e,function(){n.sipSession.sendReinvite({sdp:n.peerConnection.localDescription.sdp,extraHeaders:t.toExtraHeaders()})})},g.prototype._handleNegotiationNeeded=function(){if(this.state!==f.ESTABLISHED){l.log("Ignoring negotiationneeded event - session not established");return}if(this.offerOutstanding){l.log("Ignoring negotiationneeded event - already due");return}l.log("Starting O/A negotiation at PC's request"),this._sendReinvite()},g.prototype._handleInitialInvite=function(e,t,n,i){var u=new r.WebRTC.RTCSessionDescription({type:"offer",sdp:h(e.body)});this.peerConnection.setRemoteDescription(u,n,i),this.streamConfig=new s(t),this.customHeaders=new o(e)},g.prototype._handleStarted=function(e){var t=e.data.response;this.state=f.ESTABLISHED;if(t){var n=this,o=function(){l.log("Remote answer set"),a.fireEvent(n,"onConnect",{})},u=function(e){l.warn("setRemoteDescription failed:",e),n.sipSession.terminate({status_code:488}),n.sipSession=null,n.close()},c=t.body;l.log("Setting remote description"),this.streamConfig=new s(new i.Session(c),this.streamConfig);var p=new r.WebRTC.RTCSessionDescription({type:"answer",sdp:h(c)});this.peerConnection.setRemoteDescription(p,o,u)}},g.prototype._handleReinvite=function(e){var t=this,n=e.data,u,f;if(n.originator==="remote"){this.offerOutstanding=!0;var c=n.sdp,p=new i.Session(c),d=!1,v=!1;p||n.reinvite.sdpInvalid();var m=new s(p,this.streamConfig),g=new o(n.request);if(this.remoteHold&&m.isSending()){var y=this.remoteHoldStreams,b=m.getSendingStreams();for(u=0,f=b.length;u<f;u++)y.indexOf(b[u])===-1&&(l.warn("Remote UA tried to activate additional stream during resume:",b[u]),n.reinvite.sdpInvalid())}else m.equals(this.streamConfig)||(l.log("re-INVITE changing stream configuration"),d=!0),g.equals(this.customHeaders)||(l.log("re-INVITE changing custom headers"),v=!0);var w=new r.WebRTC.RTCSessionDescription({type:"offer",sdp:h(c)}),E=function(){var e=t.streamConfig;l.log("Remote offer set"),n.reinvite.sdpValid();var r=function(r){r?t.streamConfig=new s(r,t.streamConfig):t.streamConfig=m,t.customHeaders=g;var i=function(){t._createAnswer(function(){n.reinvite.accept({sdp:t.peerConnection.localDescription.sdp})})};this.externalStream||t.remoteHold||t.streamConfig.sendingStreamsEqual(e)?i():t._getUserMedia(null,i)};if(e.isSending()&&!m.isSending())t.remoteHold=!0,t.remoteHoldStreams=e.getSendingStreams(),r(),a.fireEvent(t,"onHold",{});else if(t.remoteHold&&m.isSending())r(),t.remoteHold=!1,a.fireEvent(t,"onResume",{});else{var i=function(){n.reinvite.reject({status_code:488})},o=!0;e.isSafeChange(m)||(o=!1),a.fireEvent(t,"onRenegotiateRequest",{streamConfig:d?m:null,customHeaders:v?g:null,safe:o,accept:r,reject:i},!0)}},S=function(e){l.warn("setRemoteDescription failed:",e),n.reinvite.sdpInvalid()};this.peerConnection.setRemoteDescription(w,E,S)}else n.reinvite.on("succeeded",function(e){var u=function(){l.log("Remote answer set")},f=function(e){l.warn("setRemoteDescription failed:",e),t.sipSession.terminate({status_code:488}),t.sipSession=null,t.close()},c=e.data.sdp;l.log("Setting remote description"),t.streamConfig=new s(new i.Session(c),t.streamConfig),t.customHeaders=new o(n.request);var p=new r.WebRTC.RTCSessionDescription({type:"answer",sdp:h(c)});t.peerConnection.setRemoteDescription(p,u,f),a.fireEvent(t,"onRenegotiateResponse",{accepted:!0})}),n.reinvite.on("failed",function(e){l.log("Reinvite failed, closing session",e.data),a.fireEvent(t,"onRenegotiateResponse",{accepted:!1}),t.close()});n.reinvite.on("completed",function(){t.offerOutstanding=!1,a.fireEvent(t,"onRenegotiateComplete",{})})},g.prototype._handleRefresh=function(){this.sipSession.isMethodAllowed(r.C.UPDATE,!1)?this.sipSession.sendUpdate():this._sendReinvite()},g.prototype._handleRefer=function(e){var t=new w(this,e);a.fireEvent(this,"onTransferRequest",t,!0)};var y={onConnecting:!0,onProvisional:!0,onConnect:!0,onClose:!0,onRenegotiateRequest:!0,onRenegotiateResponse:!0,onRenegotiateComplete:!0,onHold:!0,onResume:!0,onTransferRequest:!0};g.prototype.setCallbacks=function(e){for(var t in e)y[t]?this[t]=e[t]:l.warn("Unsupported callback: ",t)},g.prototype.setLocalStream=function(e){var t,n;if(this.localStream)throw new u.StateError("Cannot mix external and internal streams");this.externalStream=!0;var r=this.peerConnection.getLocalStreams();for(t=0,n=r.length;t<n;t++)r[t]!==e&&this.peerConnection.removeStream(r[t]);this.peerConnection.addStream(e)},g.prototype.getLocalStreams=function(){if(!this.peerConnection)throw new u.StateError("Cannot get streams for closed session");return this.peerConnection.getLocalStreams()},g.prototype.getRemoteStreams=function(){if(!this.peerConnection)throw new u.StateError("Cannot get streams for closed session");return this.peerConnection.getRemoteStreams()},g.prototype.accept=function(e){var t=this;e&&(e instanceof s?this.streamConfig=e:this.streamConfig=new s(e));if(this.state!==f.PENDING)throw new u.StateError("Session cannot be accepted in state",this.state);if(this.sipSession.direction!=="incoming")throw new u.StateError("Cannot call accept() on outgoing sessions");var n=function(){t._createAnswer(function(){t.state===f.PENDING&&(/Firefox/.test(navigator.userAgent)&&t._setRemoteStreamOutput(),t.sipSession.answer({sdp:t.peerConnection.localDescription.sdp}),a.fireEvent(t,"onConnect",{}))})};this.externalStream?n():this._getUserMedia(null,n),this._setRemoteStreamOutput()},g.prototype.hold=function(){if(this.localHold)return;if(this.offerOutstanding)throw new u.StateError("Existing renegotiation still in progress");this.localHold=!0,this.offerOutstanding=!0;var e=this.localStream.getVideoTracks(),t=this.localStream.getAudioTracks(),n=e.concat(t);for(var r=0,i=n.length;r<i;r++)n[r].enabled=!1;var o=new s(this.streamConfig);this.localHoldStreams=o.hold(),this._sendReinvite(o)},g.prototype.resume=function(){if(!this.localHold)return;if(this.offerOutstanding)throw new u.StateError("Existing renegotiation still in progress");this.offerOutstanding=!0;var e=new s(this.streamConfig);e.resume(this.localHoldStreams),this._sendReinvite(e);var t=this.localStream.getVideoTracks(),n=this.localStream.getAudioTracks(),r=t.concat(n);for(var i=0,o=r.length;i<o;i++)r[i].enabled=!0;this.localHold=!1},g.prototype.renegotiate=function(e){e||(e={});var t=e.streamConfig,n=e.customHeaders;t&&(t=new s(t,this.streamConfig)),n&&(n=new o(n)),e.stream&&this.setLocalStream(e.stream);if((this.localHold||this.remoteHold)&&t)throw new u.StateError("Cannot modify streams whilst on hold");if(this.offerOutstanding)throw new u.StateError("Existing renegotiation still in progress");this.offerOutstanding=!0;if(t&&!this.externalStream){var r=this;this._getUserMedia(t,function(){r._sendReinvite(t,n)})}else this._sendReinvite(t,n)},g.prototype.mute=function(){if(!this.localStream)return;var e=this.localStream.getAudioTracks();for(var t=0,n=e.length;t<n;t++)e[t].enabled=!1},g.prototype.unmute=function(){if(!this.localStream)return;if(this.localHold)throw new u.StateError("Cannot unmute a held call");var e=this.localStream.getAudioTracks();for(var t=0,n=e.length;t<n;t++)e[t].enabled=!0},g.prototype.sendDTMF=function(e,t){t=t||{};var n=t.type||"pc",r=t.duration||200,i=t.interToneGap||n==="info"?500:50,s=this;e=e.toString().toUpperCase();if(/[^0-9A-D\*#,]/.test(e))throw new u.ValueError("Invalid characters in DTMF tones:",e);r=Math.max(r,70),r=Math.min(r,6e3),i=Math.max(i,50);if(n==="info")this.sipSession.sendDTMF(e,{duration:r,interToneGap:i});else{var o=this.dtmfSender;if(o){o.insertDTMF(o.toneBuffer+e,o.duration,o.interToneGap);return}var a=this.localStream.getAudioTracks();if(a.length<1)throw new u.ValueError("Cannot send DTMF without an audio track");o=this.peerConnection.createDTMFSender(a[0]),o.insertDTMF(e,r,i),o.ontonechange=function(e){e.tone||(s.dtmfSender=null)},this.dtmfSender=o}},g.prototype.transfer=function(e){if(this.state!==f.ESTABLISHED)throw new u.StateError("Media session not established: "+this.state);if(this.transferFeedback)throw new u.StateError("Previous transfer outstanding");var t=new b(this),n={};n.eventHandlers=t._getJsSipHandlers();try{this.sipSession.sendRefer(e,n)}catch(i){if(i instanceof r.Exceptions.RemoteSupportError)throw new u.UnsupportedError("Remote party does not support transfers")}return this.transferFeedback=t,t},g.prototype.close=function(e){if(this.state===f.CLOSED)return;var t=this.state;this.state=f.CLOSED,e||(e="normal"),this.peerConnection&&(this.peerConnection.close(),this.peerConnection=null),this.localStream&&(this.localStream.stop(),this.localStream=null);if(this.sipSession){var n=null;if(t===f.PENDING&&this.sipSession.direction==="incoming"){var r=a.sdkStatusToSipStatus("invite",e);n={status_code:r}}try{this.sipSession.terminate(n)}catch(i){l.error("Error terminating SIP session:\n",i.stack)}}this.emitEvent("close"),a.fireEvent(this,"onClose",{status:e})},g.prototype.onConnecting=function(){},g.prototype.onProvisional=function(){},g.prototype.onConnect=function(){},g.prototype.onAddStream=function(e){var t,n,r;t=e.stream,n=t.getAudioTracks(),r=t.getVideoTracks(),r.length>0?this.remoteVideoElement?m(this.remoteVideoElement,t):l.log("Video received, but no remoteVideoElement provided"):n.length>0&&(this.remoteAudioElement?m(this.remoteAudioElement,t):l.log("Audio stream received, but no remoteAudioElement provided"))},g.prototype.onRenegotiateRequest=function(e){if(e.safe){l.log("Auto-accepting re-INVITE (no significant changes)"),e.accept();return}l.log("Auto-rejecting re-INVITE (significant changes)"),e.reject()},g.prototype.onTransferRequest=function(e){e.reject()},g.prototype.onClose=function(){};var b=function(e){this.session=e};b.prototype.onAccepted=function(){this.session.close()},b.prototype.onRejected=function(){this.session.close()},b.prototype._getJsSipHandlers=function(){var e=this;return{accepted:function(){a.fireEvent(e,"onAccepted",{},!0)},failed:function(){e.session.transferFeedback=null,a.fireEvent(e,"onRejected",{},!0)},notify:function(t){var n=t.data;if(!n.finalNotify)return;e.session.transferFeedback=null;switch(n.sessionEvent){case"started":a.fireEvent(e,"onTransferSucceeded",{});break;case"failed":a.fireEvent(e,"onTransferFailed",{});break;default:a.fireEvent(e,"onTransferResultUnknown",{})}}}};var w=function(e,t){var n=this;this.session=e,this.refer=t,this.timer=setTimeout(function(){n.reject(),n.timer=null},3e4),this.address=t.refer_uri.toString().replace(/^sip:/,"")};return w.prototype.accept=function(e,t){if(this.timer===null)return;clearTimeout(this.timer),this.timer=null,t=t||{},t.streamConfig||(t.streamConfig=this.session.streamConfig);var n=this.session.webrtcApi.connect(this.address,e,t);return this.refer.addSessionNotifyHandlers(n.sipSession),n},w.prototype.reject=function(){if(this.timer===null)return;clearTimeout(this.timer),this.timer=null,this.refer.reject({status_code:603})},g}),r("src/webrtc",["underscore","EventEmitter","logger","jssip","./webrtc/sdp","./webrtc/session","./webrtc/util"],function(e,t,n,r,i,s,o){var u=n.get("SDK:RTC"),a="1.1",f="error",l="ready",c=function(e){var t=this,n=e.config.interfaces.webrtc;this.sdk=e,this.enabled=!!n,this.ready=!1,this.sessions=[];if(!this.enabled)return;r.C.USER_AGENT.indexOf("Acision")<0&&(r.C.USER_AGENT="Acision SDK v".concat(e.version,"; ",navigator.userAgent));var i={ws_servers:n.wsEndpoints[a],uri:"sip:"+(e.config.primaryAddress||"anonymous@anonymous.invalid"),authorization_user:n.credentials.username,password:n.credentials.password,register:!1,handle_media:!1,instance_id:e.uuid};this.ua=new r.UA(i),this.ua.on("connected",function(){t.emitEvent(l)}),this.ua.on("registrationFailed",function(){t.emitEvent(f)}),this.ua.on("newRTCSession",function(e){var n=e.data;if(n.originator!=="remote")return;t._handleIncoming(n)}),this.ua.on("newRefer",this._handleRefer.bind(this)),this.ua.start()};return c.prototype=new t,c.prototype.constructor=c,c.prototype.isReady=function(){return!this.enabled||this.ua.isConnected()},c.prototype.refreshConfig=function(){if(!this.enabled)return;var e=this.sdk.config.interfaces.webrtc,t={ws_servers:e.wsEndpoints[a],authorization_user:e.credentials.username,password:e.credentials.password};this.ua.updateConfiguration(t);for(var n=0,r=this.sessions.length;n<r;n++)this.sessions[n]._updateIceServers(this.sdk.config.iceServers)},c.prototype.disconnect=function(){this.ua&&(this.ua.stop(),this.ua=null)},c.prototype.setCallbacks=function(e){e.onIncomingSession?(this.onIncomingSession=e.onIncomingSession,this.ua.register()):(delete this.onIncomingSession,this.ua.unregister())},c.prototype.connect=function(e,t,n){var i=this,o=new r.RTCSession(this.ua);n||(n={}),e.indexOf("@")<0&&(e=e.concat("@",this.sdk.config.defaultDomain));var u=this.sdk.config.iceServers,a=new s(this,o,e,u,n.constraints);return a.setCallbacks(t),a._connect(n.stream,n.streamConfig,n.customHeaders),this.sessions.push(a),a.on("close",function(){var e=i.sessions;e.splice(e.indexOf(this),1)}),a},c.prototype._handleIncoming=function(e){var t=this,n=new i.Session(e.request.body);if(!n){e.sdpInvalid();return}var r=null;!n.attributes.fingerprint&&!n.media[0].attributes.fingerprint&&(r={mandatory:{DtlsSrtpKeyAgreement:!1}});var a=e.session.remote_identity.uri.toAor().replace(/^sip:/,""),f=this.sdk.config.iceServers,l=new s(this,e.session,a,f,r),c=function(){u.log("Remote offer set"),e.sdpValid(),o.fireEvent(t,"onIncomingSession",{session:l})},h=function(t){u.warn("setRemoteDescription failed:",t),e.sdpInvalid(),l.close()};l._handleInitialInvite(e.request,n,c,h),this.sessions.push(l),l.on("close",function(){var e=t.sessions;e.splice(e.indexOf(this),1)})},c.prototype._handleRefer=function(e){var t=e.data;if(t.originator!=="remote")return;t.refer.refer_uri.scheme!==r.C.SIP&&t.refer.reject({status_code:416,reason_phrase:"Unsupported Refer URI Scheme"});var n=t.session;if(!n){t.refer.reject({status_code:481,reason_phrase:"Target Session Does Not Exist"});return}var i=null;for(var s=0,o=this.sessions.length;s<o;s++){i=this.sessions[s];if(i.sipSession===n){i._handleRefer(t.refer);return}}t.refer.reject({status_code:481,reason_phrase:"Target Session Does Not Exist"})},c}),r("sdk",["require","src/auth","src/messaging","src/contacts","src/presence","src/webrtc","logger","underscore","uuid"],function(e){var t=e("src/auth"),n=e("src/messaging"),r=e("src/contacts"),i=e("src/presence"),s=e("src/webrtc"),o=e("logger"),u=e("underscore"),a=e("uuid"),f=o.get("SDK"),l="sdk.rtc.sip-instance",c={baseUrl:"sdk.acision.com",persistent:!0},h=["messaging","contacts","presence","webrtc"];o.useDefaults();var p=function(e,t,n){this.apiKey=e,this.callbacks=t,this.config=u.defaults({},n,c),this.refreshTimer=null,this.uuid=localStorage[l],this.uuid||(this.uuid=a.v1(),localStorage[l]=this.uuid),this.initialised=!1,this.allready=!1,this.authenticate()};p.version="1.1.0",p.prototype.version=p.version;var d="onConnected",v="onAuthFailure",m="onDisconnected";return p.prototype.authenticate=function(){var e=this;this.auth=new t(this.apiKey,this.config),this.auth.once("error",function(t){f.warn("Authentication error"),e.fireEvent(v,t),e.disconnect()}),this.initialised?this.auth.on("success",function(t){f.info("Authentication refresh successful"),u.extend(e.config,t),e.refreshTimer=setTimeout(e.authenticate.bind(e),e.config.ttl*1e3),e.refreshConfig()}):this.auth.on("success",function(t){f.info("Authentication successful"),u.extend(e.config,t),e.config.refreshToken&&(e.config.password=""),e.refreshTimer=setTimeout(e.authenticate.bind(e),e.config.ttl*1e3),e.initInterfaces(),e.initialised=!0})},p.prototype.fireEvent=function(e,t){var n=this.callbacks[e];if(u.isFunction(n))try{n(t)}catch(r){f.error("Exception encountered for "+e+"callback:",r)}},p.prototype.initInterfaces=function(){var e=this.checkInterfaces.bind(this),t=this.disconnect.bind(this);this.messaging=new n(this),this.messaging.once("ready",e),this.messaging.on("error",t),this.contacts=new r(this),this.contacts.once("ready",e),this.contacts.on("error",t),this.presence=new i(this),this.presence.once("ready",e),this.presence.on("error",t),this.webrtc=new s(this),this.webrtc.once("ready",e),this.webrtc.on("error",t),this.checkInterfaces()},p.prototype.checkInterfaces=function(){var e=this;e.allReady=u.every(h,function(t){return e[t].isReady()}),e.allReady&&u.defer(u.bind(this.fireEvent,this,d))},p.prototype.refreshConfig=function(){var e=this;u.each(h,function(t){e[t].refreshConfig()})},p.prototype.disconnect=function(){var e=this;this.refreshTimer&&(clearTimeout(this.refreshTimer),this.refreshTimer=null),u.each(h,function(t){e[t]&&e[t].disconnect()}),e.fireEvent(m)},p.prototype.getAddress=function(){var e=this;return e.config.primaryAddress},p.prototype.getAppConfig=function(){var e=this;return!e.allReady||u.isUndefined(e.config.appConfig)?null:e.config.appConfig},p}),r("underscore",function(){return e}),n("sdk")});