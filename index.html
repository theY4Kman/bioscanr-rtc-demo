<html>
<head>
</head>
<body>

<div id="accounts-wrapper">
    <h2 id="accounts-title">Login as user:</h2>
    <ul id="accounts"></ul>
</div>

<div id="video-wrapper" style="display: none;">
    <div style="float: left;">
        <h2>Them:</h2>
        <video id="video-remote" width="320" height="240" autoplay></video>
    </div>
    <div style="float: left;">
        <h2>You:</h2>
        <video id="video-local" width="320" height="240" autoplay></video>
    </div>
</div>

<script type="text/javascript">
    var STATE_LOGIN = 1,
      STATE_CONFER_WITH = 2,
      STATE_CONFERRING = 3;

    var accounts = {
        'they4kman_gmail_com_0': 'Y@f3t6TkG',
        'they4kman_gmail_com_1': '@0NqGYy5t',
        'they4kman_gmail_com_2': 'mvWVeu@x3',
        'they4kman_gmail_com_3': 'pysWm1vga',
        'they4kman_gmail_com_4': '0JqWXASGX',
        'they4kman_gmail_com_5': 'akNv7NKOE',
        'they4kman_gmail_com_6': 'yqmWCS9fr',
        'they4kman_gmail_com_7': '5gENnvDnQ',
        'they4kman_gmail_com_8': 'Pbgt3tHUW',
        'they4kman_gmail_com_9': 'OH8FgNmcI'
    };
    var accountsWrapper = document.getElementById('accounts-wrapper');
    var accountsTitle = document.getElementById('accounts-title');
    var accountsList = document.getElementById('accounts');
    var videoWrapper = document.getElementById('video-wrapper');
    var videoRemote = document.getElementById('video-remote');
    var videoLocal = document.getElementById('video-local');

    var lib = null;
    var session = null;
    var state = STATE_LOGIN;

    var connect = function (user, password, onConnected) {
        lib = new AcisionSDK("JMQZwn9v685J", {
              onConnected: function () {
                  if (onConnected) {
                      onConnected(lib);
                  }
              },
              onAuthFailure: function () {
                  console.warn("Invalid username or password!");
              }
          }, {
              persistent: true,
              username: user,
              password: password
          }
        );
    };

    var beginConference = function(session) {
        setupSession(session);
        accountsWrapper.style.display = 'none';
    };

    var setupSession = function(session) {
        session.remoteVideoElement = videoRemote;
        session.localVideoElement = videoLocal;
    };

    var accountClicked = function (btn) {
        var username = btn.innerText;
        if (state == STATE_LOGIN) {
            var password = accounts[btn.innerText];
            connect(username, password, function () {
                accountsTitle.innerText = 'Start video conference with user:';
                btn.style.display = 'none';

                // Setup incoming hooks, so we can receive calls
                lib.webrtc.setCallbacks({
                    onIncomingSession: function (event) {
                        videoWrapper.style.display = 'block';
                        session = event.session;
                        beginConference(session);
                        session.accept();

                        state = STATE_CONFERRING;
                    }
                });

                state = STATE_CONFER_WITH;
            });
        } else if (state == STATE_CONFER_WITH) {
            videoWrapper.style.display = 'block';
            var session = lib.webrtc.connect(username, {}, {
                streamConfig: {
                    videoIn: true,
                    videoOut: true
                }
            });
            beginConference(session);
            state = STATE_CONFERRING;
        }
    };

    var username, password, li, btn;
    for (username in accounts) {
        if (!accounts.hasOwnProperty(username)) {
            continue;
        }

        btn = document.createElement('button');
        btn.innerText = username;
        btn.addEventListener('click', (function (btn) {
            return function () {
                return accountClicked(btn);
            }
        })(btn));

        li = document.createElement('li');
        li.appendChild(btn);

        accountsList.appendChild(li);
    }
</script>
<script src="js/underscore-min.js"></script>
<script src="js/acision/sdk.min.js"></script>
</body>
</html>
